unit ServiceValesCupones_Impl;

{----------------------------------------------------------------------------}
{ This unit was automatically generated by the RemObjects SDK after reading  }
{ the RODL file associated with this project .                               }
{                                                                            }
{ This is where you are supposed to code the implementation of your objects. }
{----------------------------------------------------------------------------}

{$I RemObjects.inc}

interface

uses
  {vcl:} Classes, SysUtils, 
  {RemObjects:} uROXMLIntf, uROClientIntf, uROTypes, uROServer, uROServerIntf, uROSessions,
  {Required:} uRORemoteDataModule,
  {Data Abstract:} uDAClasses, uDADataTable, uDABinAdapter, uDAInterfaces, uDADataStreamer,
  {Ancestor Implementation:} DataAbstractService_Impl, uAutorizacion,
  {Used RODLs:} DataAbstract4_Intf,
  {Generated:} LibraryValesCupones_Intf, uDABin2DataStreamer, Forms,
  uDAScriptingProvider, uDABusinessProcessor, uROComponent,
  uDAStreamableComponent, uDASchema, ActiveX, uROStream,
  {RSA-MD5} libeay32, uDAEngine, uDASDACDriver, uROMessage, uROBinMessage;

type
  { TServiceValesCupones }
  TServiceValesCupones = class(TDataAbstractService, IServiceValesCupones)
    dbpUsuario: TDABusinessProcessor;
    bpReporte: TDABusinessProcessor;
    DataStreamer: TDABin2DataStreamer;
    dbpDetalleLiquidacion: TDABusinessProcessor;
    dbpLiquidacion: TDABusinessProcessor;
    Schema: TDASchema;

    procedure DataAbstractServiceCreate(Sender: TObject);
  private
    procedure AsignaEstacion;
    procedure AsignaNodos;
    procedure UltimasVentas(BombaID: Integer);
    procedure CalculaIEPS(var Datos: TDatosFactura);
    procedure CalculaISR_IVARTN(var Datos: TDatosFactura);
    procedure CalculaIEPSExpress(var Datos: TFacturaExpress);
    function IEPS(ProductoID: Integer): Real;
    function PremioPuntos(EstacionID: Integer; Puntos: Double): String;
    function CER(const texto, Dir: AnsiString) : string;
    function CERNUM(const texto, Dir: AnsiString) : String;
    function LlavePriv(const Password, Dir: AnsiString; EstacionID: Integer) : string;
    function GuardaArchivo(nomArch,Texto: String):Integer;
    procedure dbpLiquidacionBeforeProcessDelta(Sender: TDABusinessProcessor;
      const aDelta: IDADelta);
    function BuscaAutorizacion(const Referencia:String):Boolean;
    function BuscaClientexVehiculo(const VehiculoID: Integer): Integer;
    procedure EnviaTramas(Tramas, Host: String; GasolineroID: Integer);
    function BuscaTicketsFactura(FacturaID: Integer): String;
  protected
    { IServiceValesCupones methods }
    function AbreDataSetReporte(const SQL: AnsiString; const Parametros: TParametros): Binary;
    procedure ActualizaCupon(const Barras: AnsiString; const DiaConsumo: Integer; const EjercicioConsumo: Integer; const FechaConsumo: DateTime;
                             const PeriodoConsumo: Integer; const Secuencia: Integer; const Ticket: Integer; const Liquidacion: Integer);
    procedure ActualizaCuponConReferencia(const Barras: AnsiString; const DiaConsumo: Integer; const EjercicioConsumo: Integer; const FechaConsumo: DateTime;
                                          const PeriodoConsumo: Integer; const Secuencia: Integer; const Ticket: Integer; const Referencia: AnsiString);
    procedure ActualizaLiquidacionCorte(const Liquidacion: Integer; const Secuencia: Integer; const AgrupacionID: Integer);
    procedure ActualizarStatusValeCredito(const CarteraValeCreditoID: Integer; const Status: AnsiString; const FacturaID: Integer);
    procedure ActualizaStatusCupon(const Barras: AnsiString; const DiaConsumo: Integer; const EjercicioConsumo: Integer; const FechaConsumo: DateTime;
                                   const LiquidacionID: Integer; const PeriodoConsumo: Integer; const Secuencia: Integer);
    function GeneraFactura(const EstacionID: Integer; const Serie: AnsiString; const FechaCorte: DateTime; const ClienteID: Integer;
                           const UsuarioID: Integer): Integer;
    function BuscaReporte(const Nombre: AnsiString; const TipoTemplate: Integer): TReporte;
    function CambiaFolioFactura(const Serie: AnsiString; const Folio: Integer; const NewSerie: AnsiString; const NewFolio: Integer): AnsiString;
    function CancelaFactura(const Folio: Integer; const Serie: AnsiString; const Fecha: DateTime; const EstacionID: Integer; const UsuarioID: Integer): AnsiString;
    function CierraLiquidacion(const LiquidacionID: Integer): AnsiString;
    function CostoProducto(const ProductoID: Integer): Double;
    function DatosCliente(const ClienteID: Integer; const Referencia: AnsiString): TDatosCliente;
    function Existencia(const EstacionID: Integer; const AlmacenID: Integer; const ProductoID: Integer; const Fecha: DateTime): Double;
    function FacturaExpress(const Serie: AnsiString; const Folio: Integer): TFacturaExpress;
    function FacturaID(const Serie: AnsiString; const Folio: Integer): Integer;
    function FacturaYLiquidacion(const ClienteID: Integer): Boolean;
    function Fecha: DateTime;
    function Folio(const Campo: AnsiString; const Serie: AnsiString): Integer;
    function FolioActual(const Campo: AnsiString; const Serie: AnsiString): Integer;
    function FolioActual2(const serie: AnsiString; const folio: Integer): Integer;
    procedure GuardaAccesos(const UsuarioID: Integer; const Lista: AnsiString);
    function GuardaConsumoExpress(const Consumo: TConsumoExpress): Boolean;
    procedure GuardaLimiteFactura(const UsuarioID: Int64; const Cantidad: Double);
    procedure GuardarDatosFactura(const DatosFactura: TDatosFactura);
    procedure GuardarDatosLiquidacion(const DatosLiquidacion: TDatosLiquidacion);
    procedure GuardarDatosReciboPago(const DatosReciboPago: TDatosReciboPago);
    function GuardarFacturaExpress(const ClienteID: Integer; const Serie: AnsiString; const EstacionID: Integer; const TicketID: Integer): TFacturaExpress;
    procedure InsertaDeposito(const DepositoID: Integer; const Cantidad: Double; const Usuario: Integer; const Fecha: DateTime; const Secuencia: Integer;
                              const EstacionID: Integer; const Descripcion: AnsiString; const Ejercicio: Integer; const Periodo: Integer;
                              const Dia: Integer);
    procedure InsertaProductoPrecio(const ProductoID: Integer; const EstacionID: Integer; const Precio: Double);
    function Login(const Usuario: AnsiString; const Clave: AnsiString): TLoginInfo;
    function ModificarFolioActual(const Campo: AnsiString; const Serie: AnsiString; const Folio: Integer): AnsiString;
    function ObtenerStatusCupon(const Barras: AnsiString): AnsiString;
    function PrefijaCupon(const nBomba: Integer; const Barras: AnsiString; const Terminal: AnsiString; const Grupo: Integer; const ClienteID: Integer): TCupon;
    function ObtenerTipoCambioIDPorEstacion(const EstacionID: Integer): Integer;
    function ObtenerTipoCambioPorEstacion(const EstacionID: Integer): Double;
    function PrecioProducto(const EstacionID: Integer; const ProductoID: Integer): Double;
    function StatusTicket(const EstacionID: Integer; const TicketID: Integer): Integer;
    function SumaAnticipo(const Estacion: Integer; const Secuencia: Integer): Double;
    function SumaVentasCorte(const Estacion: Integer; const Secuencia: Integer; const AgrupacionID: Integer): Double;
    function ValoresTurno(const EstacionID: Integer; const TurnoID: Integer): TValoresTurno;
    function VersionServer: AnsiString;
    function LiquidacionCerrada(const EstacionID: Integer; const TurnoID: Integer): Boolean;
    function ClienteValido(const ClienteID: Integer; const NewClienteID: Integer): Boolean;
    function BuscaOtroProducto(const EstacionID: Integer; const Codigo: AnsiString): TOtroProducto;
    function TurnoALiquidacionID(const TurnoID: Integer; const EstacionID: Integer): Integer;
    function BuscaSagarpa(const EstacionID: Integer): TSagarpa;
    function PuntosCalculaSaldo(const ClienteID: Integer): Double;
    function PuntosCalculaPuntos(const ClienteID: Integer; const ProductoID: Integer; const Volumen: Double): Double;
    procedure PuntosGuardaDatos(const Datos: TDatosPuntos);
    function PuntosDatos(const ClienteID: Integer): TDatosPuntos;
    function EliminaAutomaticosLiquidacion(const EstacionID: Integer; const TurnoID: Integer): Boolean;
    function BuscaDespachadorLiquidacion(const BombaID: Integer; const EstacionID: Integer; const TurnoID: Integer): Integer;
    function EntregaPremio(const ClienteID: Integer; const PremioID: Integer; const Cantidad: Integer): TEntregaPremio;
    function DatosPremio(const PremioID: Integer): TDatosPremio;
    function ValidaConsumo(const Consumo: TConsumoExpress): Integer;
    function AgrupacionesBomba(const EstacionID: Integer): AAgrupacion;
    function DatosCerrarLiquidacion(const EstacionID: Integer; const TurnoID: Integer): TDatosCerrarLiquidacion;
    procedure ProcesaVentasLiquidacion(const Datos: TDatosCerrarLiquidacion);
    function TicketsLiquidacion(const LiquidacionID: Integer): AnsiString;
    function ValidaFolioFactura(const Serie: AnsiString; const Folio: Integer): Boolean;
    procedure PuntosGuardaCriterios(const PuntosCriterioID: Integer; const Datos: AnsiString);
    function DatosFacturaElectronica(const FacturaID: Integer; const EstacionID: Integer): TFacturaElectronica;
    function LlavePrivaCertificado(const LlavePrivada: AnsiString; const Certificado: AnsiString; const GasolineroID: Integer; const Password: AnsiString; 
                                   const EstacionID: Integer): AnsiString;
    function SELLOPEMs(const Texto: UnicodeString; const EstacionID: Integer): AnsiString;
    function CERs(const DIR: AnsiString): AnsiString;
    function ValidaLiquidacionDespachador(const LiquidacionID: Integer): AnsiString;
    function ActualizaLiquidacionProd(const Estacion: Integer; const FechaIni: DateTime; const FechaFin: DateTime; const TurnoID: Integer): Boolean;
    procedure PuntosDespachador(const TurnoID: Integer; const EstacionID: Integer; const UsuarioID: Integer);
    procedure GuardarDatosFacturaPemex(const DatosFacturaPemex: TDatosFacturaPemex);
    function AfectaInventarios(const LiquidacionID: Integer; const UsuarioID: Integer): AnsiString;
    procedure InsertaFacturaElectronica(const FacturaElectronicaID: Integer; const CadenaOriginal: UnicodeString; const SelloDigital: UnicodeString; 
                                        const FacturaID: Integer; const Vigencia: Boolean; const Enviado: Boolean; const NoCertificado: AnsiString; 
                                        const NoAprobacion: AnsiString; const FechaAprobacion: DateTime);
    function CERsNUM(const DIR: AnsiString): AnsiString;
    function ActualizaFirmaDefault(const UsuarioID: Integer; const FIRMA: Binary): AnsiString;
    function obtendatosempleados(const EstacionID: AnsiString; const Turno: AnsiString): AnsiString;
    procedure ProgramaMantenimiento(const IDPROGRAMAMANTENIMIENTO: Integer; const IDESTACION: Integer; const FECHA: DateTime);
    function obtendatosActividadesProgramadas(const IDESTACION: Integer; const TIPO: Integer): AnsiString;
    function obtenNotificacionesDiarias(const IDESTACION: Integer): AnsiString;
    function registraactividadrealizada(const IDACTIVIDADMANTENIMIENTO: Integer; const NOTA: AnsiString; const STATUS: AnsiString): AnsiString;
    function CancelarCupones(const Lista: AnsiString; const UsuarioID: Integer): AnsiString;
    function CancelarLote(const LoteID: Integer; const UsuarioID: Integer): AnsiString;
    function StatusCupon(const Codigo: AnsiString): AnsiString;
    function BuscarReporte(const Nombre: AnsiString): TReporte;
    function FacturaCupon(const Cliente: Integer; const Importe: Double; const EstacionID: Integer; const EmpleadoID: Integer;
                          const SerieFactura: AnsiString): Integer;
    procedure GuardaDatosFactura(const DatosFactura: TDatosFactura);
    procedure GeneraCupones(const LoteCuponID: Integer; const ClienteID: Integer; const EstacionID: Integer; const Identificador: Integer;
                            const Cupones: AGeneraCupon; const TipoCupon: Boolean; const Serie: AnsiString; const aFolio: Integer);
    function DocumentosConSaldo(const ClienteID: Integer): TDocumentosConSaldoArray;
    function FacturaRecibo(const Cliente: Integer; const Importe: Double; const EstacionID: Integer; const EmpleadoID: Integer;
                           const SerieFactura: AnsiString; const ProductoID: Integer): Integer;
    function CaracteresCupon: AnsiString;
    function ObtenCuponValido(const Barras: AnsiString; const Grupo: Integer; const CuponAutoriza: TAutoriza): TCuponValido;
    function GuardaAutorizacion(const Autorizacion: TAutoriza): Boolean;
    function BuscaHost(const Tipo: Integer; const Gasolinero: Integer): AnsiString;
    function DatosVehiculo(const VehiculoID: Integer): TDatosVehiculo;
    function CancelaGrupo(const Grupo: Integer): Boolean;
    function QuemarCupon(const Consumo: TConsumo; const Barras: AnsiString): Boolean;
    function GuardarConsumo(const Consumo: TConsumo): Boolean;
    function DatosVerifica(const VehiculoID: Integer): TDatosVerifica;
    function DatosVerificaReferencia(const Referencia: AnsiString): TDatosVerifica;
    function TarjetaConsumo(const Tarjeta: AnsiString; const Consumo: TConsumo): Boolean;
    procedure ActualizaHistorial(const Consumo: TConsumo);
    function EliminaAutorizacionVehiculo(const Referencia: AnsiString): Boolean;
    function AgregaSecuencias(const Consumos: aConsumo): Boolean;
    function AutorizaTarjeta(const Autoriza: TAutoriza): TTarjeta;
    function BuscaAutorizacionTarjeta(const ClienteID: Integer; const VehiculoID: Integer; const GasolineroID: Integer): Boolean;
    procedure EstadoDispensario(const Dispensario: Integer; const Estado: AnsiString);
    procedure EntradaBitacora(const Descripcion: AnsiString; const Tipo: eTipoBitacora; const Alerta: Boolean);
    procedure AutoCambioPrecio;
    procedure CierraTurno(const BombaID: Integer; const TurnoID: Integer; const FinLecturas: aLecturas);
    procedure CreaTurno(const BombaID: Integer; const TurnoID: Integer; const InicioLecturas: aLecturas);
    function GuardaVenta(const nBomba: Integer): Integer;
    function UltimoTurnoBomba: aTurnoBomba;
    procedure ValidaSecuencias(const TurnoID: Integer);
    function ValidaSecuenciasC(const EstacionID: Integer; const Secuencias: AnsiString): AnsiString;
    function Datos: TGlobal;
    procedure CancelaGrupoC(const BombaID: Integer; const Grupo: Integer);
    function PrefijaGrupo(const Bomba: Integer; const Grupo: Integer; const Terminal: AnsiString; const Cupon: TCupon): AnsiString;
    function PrefijaTarjeta(const nBomba: Integer; const Tarjeta: AnsiString; const NIP: AnsiString; const Odometro: AnsiString;
                            const Terminal: AnsiString): AnsiString;
    procedure AsignaBombas;
    procedure AsignaProductos;
    procedure AsignaDispositivo;
    procedure AsignaTanques;
    procedure IncrementarImpreso(const Secuencia: Integer);
    function PrefijaTarjetaFrecuente(const nBomba: Integer; const Tarjeta: AnsiString; const Odometro: AnsiString; const Terminal: AnsiString): AnsiString;
    function GenerarFacturas(const Serie: AnsiString; const fol: Integer; const FechaCorte: DateTime; const FechaContable: DateTime;
                             const DiaFacturar: Integer; const Magna: Boolean; const Premium: Boolean; const Diesel: Boolean; const EmpleadoID: Integer): Integer;
    function EliminaFactura(const Folio: Integer; const Serie: AnsiString): Boolean;
    function CambioFactura(const Serie: AnsiString; const Folio: Integer; const NuevaSerie: AnsiString; const NuevoFolio: Integer;
                           const FechaImpresion: DateTime): AnsiString;
    function DatosFactura(const Folio: Integer; const Serie: AnsiString): Boolean;
    function GeneraFacturasXCliente(const ClienteID: Integer; const Productos: AnsiString; const FechaCorte: DateTime; const FechaContable: DateTime;
                                    const Serie: AnsiString; const aFolio: Integer; const EmpleadoID: Integer): Integer;
    function GasolineroID: Integer;
  end;

implementation

{$IFDEF DELPHIXE2UP}
{%CLASSGROUP 'System.Classes.TPersistent'}
{$ENDIF}

{$IFNDEF FPC}
  {$R *.dfm}
{$ELSE}
  {$R *.lfm}
{$ENDIF}
uses
  {Generated:} LibraryValesCupones_Invk, fServerDataModule, UtileriasComun, Dialogs, Controlador;

procedure Create_ServiceValesCupones(out anInstance: IUnknown);
begin
  anInstance := TServiceValesCupones.Create(nil);
end;

{ TServiceValesCupones }

function TServiceValesCupones.AbreDataSetReporte(const SQL: AnsiString;
  const Parametros: TParametros): Binary;
var
  DataSet: IDADataset;
  Aux: TStrings;
procedure AgregaParametro(Nombre: AnsiString; Tipo: TDADataType);
begin
  with DataSet.Params.Add do
  begin
    Name:=Nombre;
    DataType:=Tipo;
  end;    // with
end;
begin
  Aux:=TStringList.Create;
  if  FileExists('DefaultEmpresas.dat') then
    Aux.LoadFromFile('DefaultEmpresas.dat');
  Aux.Text:=Aux.Text + #10#13 + SQL;
  Aux.SaveToFile('SQL.txt');
  DataSet := Connection.NewDataset(Aux.Text, 'Reporte');
  Aux.Free;
  AgregaParametro('FechaIni', datDateTime);
  AgregaParametro('FechaFin', datDateTime);
  AgregaParametro('ClienteIni', datInteger);
  AgregaParametro('ClienteFin', datInteger);
  AgregaParametro ('Estacion',datInteger);
  AgregaParametro('EmpleadoIni',datInteger);
  AgregaParametro('EmpleadoFin',datInteger);
  AgregaParametro('Status',datString);
  AgregaParametro('TipoMantenimiento', datInteger);
  AgregaParametro('Usuario', datInteger);
  AgregaParametro('FolioFactura',datInteger);
  AgregaParametro('Serie',datString);
  AgregaParametro('EstacionIni',datInteger);
  AgregaParametro('EstacionFin',datInteger);
  AgregaParametro('Seleccion',datInteger);
  {AgregaParametro('SecuenciaIni',datInteger);
  AgregaParametro('SecuenciaFin',datInteger);
  AgregaParametro('Factura',datInteger);
  AgregaParametro('Serie',datString);
  AgregaParametro('FolioFactura',datInteger);
  AgregaParametro('Ejercicio',datInteger);
  AgregaParametro('Periodo',datInteger);
  AgregaParametro('Dia',datInteger);
  AgregaParametro('EjercicioFin',datInteger);
  AgregaParametro('PeriodoFin',datInteger);
  AgregaParametro('DiaFin',datInteger);
  AgregaParametro('Sentencia',datString);
  AgregaParametro('Status',datString);
  AgregaParametro('Agrupacion',datInteger);
  AgregaParametro('Almacen',datInteger);
  AgregaParametro('SecuenciaIniLiquidacion',datInteger);
  AgregaParametro('SecuenciaFinLiquidacion',datInteger);
  AgregaParametro('FacturasdeCompras',datInteger);
  AgregaParametro('MontoFacturado',datFloat);
  AgregaParametro('Turno',datInteger);
  AgregaParametro('EstacionIni',datInteger);
  AgregaParametro('EstacionFin',datInteger);}


  //AgregaParametro('Serie',datString);

  {AgregaParametro('Identificador', datInteger);
  AgregaParametro('TipoFecha', datInteger);
  AgregaParametro('Grupo', datString);
  AgregaParametro('EstacionIni', datInteger);
  AgregaParametro('EstacionFin', datInteger);
  AgregaParametro('FacturaIni', datInteger);
  AgregaParametro('FacturaFin', datInteger);
  AgregaParametro('FechaCorte', datDateTime);
  AgregaParametro('Venc0', datInteger);
  AgregaParametro('Venc1', datInteger);
  AgregaParametro('Venc2', datInteger);
  AgregaParametro('Venc3', datInteger);
  AgregaParametro('Venc4', datInteger);
  AgregaParametro('Seleccion', datInteger);
  AgregaParametro('Orden', datInteger);
  AgregaParametro('Status', datInteger);
  AgregaParametro('ImporteLitros', datInteger);
  AgregaParametro('TarjetaIni', datInteger);
  AgregaParametro('TarjetaFin', datInteger);
  AgregaParametro('TipoMov', datString);
  AgregaParametro('FormaCompraID', datInteger);
  AgregaParametro('DiaFacturarID', datInteger);
  AgregaParametro('Ejercicio', datInteger);
  AgregaParametro('PeriodoIni', datInteger);
  AgregaParametro('PeriodoFin', datInteger);
  AgregaParametro('Movimientos', datString);
  AgregaParametro('AgenteIni', datInteger);
  AgregaParametro('AgenteFin', datInteger);
  AgregaParametro('ProcesaTabla', datInteger);}

  DataSet.ParamByName('FechaIni').AsDateTime:=Parametros.FechaIni;
  DataSet.ParamByName('FechaFin').AsDateTime:=Parametros.FechaFin;
  DataSet.ParamByName('ClienteIni').AsInteger:=Parametros.ClienteIni;
  DataSet.ParamByName('ClienteFin').AsInteger:=Parametros.ClienteFin;
  Dataset.ParamByName('Estacion').AsInteger:=Parametros.Estacion;
  DataSet.ParamByName('EmpleadoIni').AsInteger:=Parametros.EmpleadoIni;
  DataSet.ParamByName('EmpleadoFin').AsInteger:=Parametros.EmpleadoFin;
  DataSet.ParamByName('Status').AsString:=Parametros.Status;
  DataSet.ParamByName('TipoMantenimiento').AsInteger:= Parametros.TipoMantenimiento;
  DataSet.ParamByName('Usuario').AsInteger:= Parametros.Usuario;
  Dataset.ParamByName('FolioFactura').AsInteger:=Parametros.FolioFactura;
  Dataset.ParamByName('Serie').AsString:=Parametros.Serie;
  DataSet.ParamByName('EstacionIni').AsInteger:=Parametros.EstacionIni;
  DataSet.ParamByName('EstacionFin').Asinteger:=Parametros.EstacionFin;
  DataSet.ParamByName('Seleccion').Asinteger:=Parametros.Seleccion;
  {Dataset.ParamByName('SecuenciaIni').AsInteger:=Parametros.SecuenciaIni;
  Dataset.ParamByName('SecuenciaFin').AsInteger:=Parametros.SecuenciaFin;
  Dataset.ParamByName('Factura').AsInteger:=Parametros.Factura;
  Dataset.ParamByName('FolioFactura').AsInteger:=Parametros.FolioFactura;
  Dataset.ParamByName('Serie').AsString:=Parametros.Serie;
  Dataset.ParamByName('Ejercicio').AsInteger:=Parametros.Ejercicio;
  Dataset.ParamByName('Periodo').AsInteger:=Parametros.Periodo;
  Dataset.ParamByName('Dia').AsInteger:=Parametros.Dia;
  Dataset.ParamByName('EjercicioFin').AsInteger:=Parametros.EjercicioFin;
  DataSet.ParamByName('PeriodoFin').AsInteger:=Parametros.PeriodoFin;
  DataSet.ParamByName('DiaFin').AsInteger:=Parametros.DiaFin;
  DataSet.ParamByName('Sentencia').AsString:=Parametros.Secuencia;
  DataSet.ParamByName('Agrupacion').AsInteger:=Parametros.Agrupacion;
  DataSet.ParamByName('almacen').AsInteger:=Parametros.Almacen;
  Dataset.ParamByName('SecuenciaIniLiquidacion').AsInteger:=Parametros.SecuenciaIniLiquidacion;
  DataSet.ParamByName('SecuenciaFinLiquidacion').AsInteger:=Parametros.SecuenciaFinLiquidacion;
  DataSet.ParamByName('FacturasdeCompras').AsInteger:=Parametros.FacturasdeCompras;
  DataSet.ParamByName('MontoFacturado').AsFloat:=Parametros.MontoFacturado;
  DataSet.ParamByName('Turno').AsFloat:=Parametros.Turno;
  DataSet.ParamByName('EstacionIni').AsInteger:=Parametros.EstacionIni;
  DataSet.ParamByName('EstacionFin').Asinteger:=Parametros.EstacionFin; }

  //Dataset.ParamByName('Serie').AsString:=Parametros.Serie;
  {  DataSet.ParamByName('ProcesaTabla').AsBoolean:=Pos('#CONSUMOS', UpperCase(SQL)) > 0;
  DataSet.ParamByName('Identificador').AsInteger:=Parametros.Identificador;
  DataSet.ParamByName('TipoFecha').AsInteger:=Parametros.TipoFecha;
  DataSet.ParamByName('Grupo').AsString:=Parametros.Grupo;
  DataSet.ParamByName('EstacionIni').AsInteger:=Parametros.EstacionIni;
  DataSet.ParamByName('EstacionFin').AsInteger:=Parametros.EstacionFin;
  DataSet.ParamByName('FacturaIni').AsInteger:=Parametros.FacturaIni;
  DataSet.ParamByName('FacturaFin').AsInteger:=Parametros.FacturaFin;
  DataSet.ParamByName('FechaCorte').AsDateTime:=Parametros.FechaCorte;
  DataSet.ParamByName('Venc0').AsInteger:=Parametros.Venc0;
  DataSet.ParamByName('Venc1').AsInteger:=Parametros.Venc1;
  DataSet.ParamByName('Venc2').AsInteger:=Parametros.Venc2;
  DataSet.ParamByName('Venc3').AsInteger:=Parametros.Venc3;
  DataSet.ParamByName('Venc4').AsInteger:=Parametros.Venc4;
  DataSet.ParamByName('Seleccion').AsInteger:=Parametros.Seleccion;
  DataSet.ParamByName('Orden').AsInteger:=Parametros.Orden;
  DataSet.ParamByName('Status').AsInteger:=Parametros.Status;
  DataSet.ParamByName('ImporteLitros').AsInteger:=Parametros.ImporteLitros;
  DataSet.ParamByName('TarjetaIni').AsInteger:=Parametros.TarjetaIni;
  DataSet.ParamByName('TarjetaFin').AsInteger:=Parametros.TarjetaFin;
  DataSet.ParamByName('TipoMov').AsString:=Parametros.TipoMov;
  DataSet.ParamByName('FormaCompraID').AsInteger:=Parametros.FormaCompraID;
  DataSet.ParamByName('DiaFacturarID').AsInteger:=Parametros.DiaFacturarID;
  DataSet.ParamByName('Ejercicio').AsInteger:=Parametros.Ejercicio;
  DataSet.ParamByName('PeriodoIni').AsInteger:=Parametros.PeriodoIni;
  DataSet.ParamByName('PeriodoFin').AsInteger:=Parametros.PeriodoFin;
  DataSet.ParamByName('AgenteIni').AsInteger:=Parametros.AgenteIni;
  DataSet.ParamByName('AgenteFin').AsInteger:=Parametros.AgenteFin;
  DataSet.ParamByName('Movimientos').AsString:=Parametros.Movimientos;
  DataSet.ParamByName('Serie').AsString:=Parametros.Serie;  }

  DataSet.Open;
  Result := Binary.Create;
  DataStreamer.WriteDataset(result, DataSet, [woSchema, woRows]);
  DataSet.Close;
end;

{    procedure ActualizaCupon(const Barras: String; const NewParam: String; const DiaConsumo: Integer; const EjercicioConsumo: Integer;
                             const FechaConsumo: DateTime; const PeriodoConsumo: Integer; const Ticket: Integer);
var
 cmd:IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection, 'ActualizaCupon');
  cmd.ParamByName('Barras').AsString:=Barras;
  cmd.ParamByName('DiaConsumo').AsInteger:=DiaConsumo;
  cmd.ParamByName('EjercicioConsumo').AsInteger:=EjercicioConsumo;
  cmd.ParamByName('FechaConsumo').AsDateTime:=FechaConsumo;
  cmd.ParamByName('PeriodoConsumo').AsInteger:=PeriodoConsumo;
  cmd.ParamByName('Secuencia').AsInteger:=Secuencia;
  cmd.Execute;

end;}

{procedure TServiceValesCupones.ActualizaCupon(const Barras, NewParam: String;
  const DiaConsumo, EjercicioConsumo: Integer; const FechaConsumo: DateTime;
  const PeriodoConsumo, Ticket: Integer);
var
  cmd:IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection,'ActualizaCupon');
  cmd.ParamByName('Barras').AsString:=Barras;
  cmd.ParamByName('DiaConsumo').AsInteger:=DiaConsumo;
  cmd.ParamByName('EjercicioConsumo').AsInteger:=EjercicioConsumo;
  cmd.ParamByName('FechaConsumo').AsDateTime:=FechaConsumo;
  cmd.ParamByName('PeriodoConsumo').AsInteger:=PeriodoConsumo;
  cmd.ParamByName('Secuencia').AsInteger:=Secuencia;
  cmd.ParamByName('Ticket').AsInteger:=Ticket;
  cmd.Execute;
end;    }

{procedure TServiceValesCupones.ActualizaCupon(const Barras: String;
  const DiaConsumo, EjercicioConsumo: Integer; const FechaConsumo: DateTime;
  const PeriodoConsumo, Secuencia, Ticket: Integer);
var
  cmd:IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection,'ActualizaCupon');
  cmd.ParamByName('Barras').AsString:=Barras;
  cmd.ParamByName('DiaConsumo').AsInteger:=DiaConsumo;
  cmd.ParamByName('EjercicioConsumo').AsInteger:=EjercicioConsumo;
  cmd.ParamByName('FechaConsumo').AsDateTime:=FechaConsumo;
  cmd.ParamByName('PeriodoConsumo').AsInteger:=PeriodoConsumo;
  cmd.ParamByName('Secuencia').AsInteger:=Secuencia;
  cmd.ParamByName('Ticket').AsInteger:=Ticket;
  cmd.Execute;
end; }


procedure TServiceValesCupones.ActualizaCupon(const Barras: AnsiString;
  const DiaConsumo, EjercicioConsumo: Integer; const FechaConsumo: DateTime;
  const PeriodoConsumo, Secuencia, Ticket, Liquidacion: Integer);
var
  cmd:IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection,'ActualizaCupon');
  cmd.ParamByName('Barras').AsString:=Barras;
  cmd.ParamByName('DiaConsumo').AsInteger:=DiaConsumo;
  cmd.ParamByName('EjercicioConsumo').AsInteger:=EjercicioConsumo;
  cmd.ParamByName('FechaConsumo').AsDateTime:=FechaConsumo;
  cmd.ParamByName('PeriodoConsumo').AsInteger:=PeriodoConsumo;
  cmd.ParamByName('Secuencia').AsInteger:=Secuencia;
  cmd.ParamByName('Ticket').AsInteger:=Ticket;
  cmd.ParamByName('LiquidacionID').AsInteger:=Liquidacion;
  cmd.Execute;

end;

procedure TServiceValesCupones.ActualizaCuponConReferencia(
  const Barras: AnsiString; const DiaConsumo, EjercicioConsumo: Integer;
  const FechaConsumo: DateTime; const PeriodoConsumo, Secuencia,
  Ticket: Integer; const Referencia: AnsiString);
var
  cmd:IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection,'ActualizaCuponConReferencia');
  cmd.ParamByName('Barras').AsString:=Barras;
  cmd.ParamByName('DiaConsumo').AsInteger:=DiaConsumo;
  cmd.ParamByName('EjercicioConsumo').AsInteger:=EjercicioConsumo;
  cmd.ParamByName('FechaConsumo').AsDateTime:=FechaConsumo;
  cmd.ParamByName('PeriodoConsumo').AsInteger:=PeriodoConsumo;
  cmd.ParamByName('Secuencia').AsInteger:=Secuencia;
  cmd.ParamByName('Ticket').AsInteger:=Ticket;
  cmd.ParamByName('Referencia').AsString:=Referencia;
  cmd.Execute;
end;

function TServiceValesCupones.ActualizaFirmaDefault(const UsuarioID: Integer;
  const FIRMA: Binary): AnsiString;
var
  cmd: IDADataset;
  respuesta: String;

  SD: TROStream;
begin
  SD:= TROStream.Create(FIRMA,false);

  cmd:= Schema.NewDataset(Connection,'spActualizaFirmaDefault');

  //FIRMA.Assign(stream);
  try

  cmd.ParamByName('UsuarioID').AsInteger:= UsuarioID;
  cmd.ParamByName('FIRMADEFAULT').LoadFromStream(SD);

  cmd.Execute;

  respuesta:= 'OK';

  except on E : Exception do
    respuesta:= E.ClassName+' error raised, with message : '+E.Message;
  end;

  result:= respuesta;

end;

procedure TServiceValesCupones.ActualizaHistorial(const Consumo: TConsumo);
var
  cmd : IDASQLCommand;
  Aux: TDatosVerifica;
begin
  {if Consumo.Importe < 1 then
    Exit;}
  Aux:=TDatosVerifica.Create;
  Aux.AfectarHistorico:=False;
  try
    if (Consumo.VehiculoID > 0) and (Consumo.ProductoID > 3) then
      Aux.Assign(DatosVerifica(Consumo.VehiculoID));
    if not Aux.AfectarHistorico then
    begin
      cmd:= Schema.NewCommand(Connection,'spActualizaHistorial');
      cmd.ParamByName('ClienteID').AsInteger:= Consumo.ClienteID;
      cmd.ParamByName('VehiculoID').AsInteger:= Consumo.VehiculoID;
      cmd.ParamByName('GasolineroID').AsInteger:= Consumo.GasolineroID;
      cmd.ParamByName('Cantidad').AsFloat:= Consumo.Cantidad;
      cmd.ParamByName('Importe').AsFloat:= Consumo.Importe;
      cmd.ParamByName('Fecha').AsDateTime:= Consumo.FechaCarga;
      cmd.Execute;
    end;
  finally
    Aux.Free;
  end;
end;

procedure TServiceValesCupones.ActualizaLiquidacionCorte(const Liquidacion,
  Secuencia: Integer; const AgrupacionID: Integer);
var
  cmd:IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection,'ActualizaCorteLiquidacion');
  cmd.ParamByName('LiquidacionID').AsInteger:=Liquidacion;
  cmd.ParamByName('Secuencia').AsInteger:=Secuencia;
  cmd.ParamByName('AgrupacionID').AsInteger:=AgrupacionID;
  cmd.Execute;
end;

function TServiceValesCupones.ActualizaLiquidacionProd(
  const Estacion: Integer; const FechaIni, FechaFin: DateTime;
  const TurnoID: Integer): Boolean;
var
  cmd : IDASQLCommand;
  cmd2: IDADataset;

  cmd3: IDASQLCommand;
  cmd4: IDADataset;
begin
  cmd:= Schema.NewDataset(Connection,'spLiquidacionProd');
  cmd2:= Schema.NewDataset(Connection,'spObtenEstacionLiq');

  cmd3:= Schema.NewDataset(Connection,'spLiquidacionProdIsla');
  cmd4:= Schema.NewDataset(Connection,'spObtenEstacionLiqIslas');

  cmd2.Close;
  cmd2.ParamByName('Estacion').AsInteger:=  Estacion;
  cmd2.ParamByName('Fecha').AsDateTime:= FechaIni;
  cmd2.ParamByName('TurnoID').AsInteger:= TurnoID;
  cmd2.Open;

  while not(cmd2.EOF) do
  begin
    cmd.ParamByName('TurnoID').AsInteger := TurnoID;
    cmd.ParamByName('InvIni').AsInteger := cmd2.FieldByName('InvIni').AsInteger;
    cmd.ParamByName('Resurtidos').AsInteger := cmd2.FieldByName('Resurtidos').AsInteger;
    cmd.ParamByName('InvFin').AsInteger := 0;
    cmd.ParamByName('Venta').AsInteger := cmd2.FieldByName('Venta').AsInteger;
    cmd.ParamByName('Bodega').AsInteger := cmd2.FieldByName('Bodega').AsInteger;
    cmd.ParamByName('Fecha').AsDateTime := FechaIni;
    cmd.ParamByName('ProductoID').AsInteger := cmd2.FieldByName('PRODUCTOID').AsInteger;
    cmd.ParamByName('EstacionID').AsInteger := Estacion;
    cmd.ParamByName('Existencia').AsInteger := cmd2.FieldByName('EXISTENCIA').AsInteger;
    cmd.ParamByName('Costo').AsFloat:= cmd2.FieldByName('COSTO').AsFloat;
    cmd.ParamByName('Precio').AsFloat:= cmd2.FieldByName('PRECIOVENTA').AsFloat;
    cmd.Execute;

    cmd2.Next;
  end;

  cmd4.Close;
  cmd4.ParamByName('Estacion').AsInteger:= Estacion;
  cmd4.ParamByName('Fecha').AsDateTime:= FechaIni;
  cmd4.ParamByName('TurnoID').AsInteger:= TurnoID;
  cmd4.Open;

  while not(cmd4.EOF) do
  begin
    cmd3.ParamByName('TurnoID').AsInteger := TurnoID;
    cmd3.ParamByName('InvIni').AsInteger := cmd4.FieldByName('InvIni').AsInteger;
    cmd3.ParamByName('Resurtidos').AsInteger := cmd4.FieldByName('Resurtidos').AsInteger;
    cmd3.ParamByName('Venta').AsInteger := cmd4.FieldByName('Venta').AsInteger;
    cmd3.ParamByName('Fecha').AsDateTime := FechaIni;
    cmd3.ParamByName('ProductoID').AsInteger := cmd4.FieldByName('ProductoID').AsInteger;
    cmd3.ParamByName('EstacionID').AsInteger := Estacion;
    cmd3.ParamByName('AlmacenID').AsInteger := cmd4.FieldByName('IDALMACEN').AsInteger;
    cmd3.ParamByName('Existencia').AsInteger := cmd4.FieldByName('EXISTENCIA').AsInteger;
    cmd3.ParamByName('Costo').AsFloat:= cmd4.FieldByName('COSTO').AsFloat;
    cmd3.ParamByName('Precio').AsFloat:= cmd4.FieldByName('PRECIOVENTA').AsFloat;
    cmd3.Execute;

    cmd4.Next;
  end;
  Result:= True;
end;

procedure TServiceValesCupones.ActualizarStatusValeCredito(const CarteraValeCreditoID: Integer; const Status: AnsiString; const FacturaID: Integer);
var
  cmd:IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection,'spActualizarStatusValeCredito');
  cmd.ParamByName('CarteraValeCreditoID').AsInteger:=CarteraValeCreditoID;
  cmd.ParamByName('Status').AsString:=Status;
  cmd.ParamByName('FacturaID').AsInteger:=FacturaID;
  cmd.Execute;
end;

procedure TServiceValesCupones.ActualizaStatusCupon(const Barras: AnsiString;
  const DiaConsumo, EjercicioConsumo: Integer; const FechaConsumo: DateTime;
  const LiquidacionID, PeriodoConsumo, Secuencia: Integer);
var
  cmd:IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection,'spActualizaStatusCupon');
  cmd.ParamByName('Barras').AsString:=Barras;
  cmd.ParamByName('DiaConsumo').AsInteger:=DiaConsumo;
  cmd.ParamByName('EjercicioConsumo').AsInteger:=EjercicioConsumo;
  cmd.ParamByName('FechaConsumo').AsDateTime:=FechaConsumo;
  cmd.ParamByName('LiquidacionID').AsInteger:=LiquidacionID;
  cmd.ParamByName('PeriodoConsumo').AsInteger:=PeriodoConsumo;
  cmd.ParamByName('Secuencia').AsInteger:=Secuencia;
  cmd.Execute;
end;

function TServiceValesCupones.AfectaInventarios(const LiquidacionID,
  UsuarioID: Integer): AnsiString;
var
  dsTotalAlmacen, ds2: IDADataSet;
  dsInventario: IDADataSet;
  MovID, AlmacenID: Integer;
  cmdMov, cmdDet: IDASQLCommand;
begin
  Result:='';
  ds2:=Schema.NewDataset(Connection, 'spEliminaInventariosLiquidacion');
  ds2.ParamByName('LiquidacionID').AsInteger:=LiquidacionID;
  ds2.Open; ds2.Close;

  dsInventario:=Schema.NewDataset(Connection, 'spInventarioOtrosProductos');
  dsInventario.ParamByName('LiquidacionID').AsInteger:=LiquidacionID;
  dsInventario.Open;

  AlmacenID:=-1;
  MovID:=0;
  cmdMov:=Schema.NewCommand(Connection, 'Insert_dbo MovimientoAlmacen2');
  cmdDet:=Schema.NewCommand(Connection, 'Insert_dbo DetalleMovimientoAlmacen2');
  dsTotalAlmacen:=Schema.NewDataset(Connection, 'spTotalAlmacen');
  while not dsInventario.EOF do
  begin
    if dsInventario.FieldByName('AlmacenID').AsInteger <> AlmacenID then
    begin
      MovID:=Folio('MovimientoAlmacen', '');
      AlmacenID:=dsInventario.FieldByName('AlmacenID').AsInteger;
      dsTotalAlmacen.ParamByName('LiquidacionID').AsInteger:=LiquidacionID;
      dsTotalAlmacen.ParamByName('AlmacenID').AsInteger:=AlmacenID;
      dsTotalAlmacen.Open;
      cmdMov.ParamByName('MovimientoAlmacenID').AsInteger:=MovID;
      cmdMov.ParamByName('Folio').AsInteger:=MovID;
      cmdMov.ParamByName('Fecha').AsDateTime:=Trunc(Fecha);
      cmdMov.ParamByName('Ejercicio').AsString:=FormatDateTime('yyyy', Now);
      cmdMov.ParamByName('Periodo').AsString:=FormatDateTime('m', Now);
      cmdMov.ParamByName('Dia').AsString:=FormatDateTime('d', Now);
      cmdMov.ParamByName('Total').AsFloat:=Decimales(dsTotalAlmacen.FieldByName('Importe').AsFloat, 2);
      cmdMov.ParamByName('ImpuestoPorcentaje').AsFloat:=Decimales(dsTotalAlmacen.FieldByName('ImpuestoPorcentaje').AsFloat, 2);
      cmdMov.ParamByName('SubTotal').AsFloat:=Decimales(dsTotalAlmacen.FieldByName('SubTotal').AsFloat, 2);
      cmdMov.ParamByName('Impuesto').AsFloat:=Decimales(dsTotalAlmacen.FieldByName('Impuesto').AsFloat, 2);
      cmdMov.ParamByName('EstacionID').AsInteger:=dsTotalAlmacen.FieldByName('EstacionID').AsInteger;
      cmdMov.ParamByName('BonoMerma').AsInteger:=0;
      cmdMov.ParamByName('EstacionDestinoID').AsInteger:=0;
      cmdMov.ParamByName('AlmacenDestinoID').AsInteger:=0;
      cmdMov.ParamByName('ProveedorID').AsInteger:=0;
      cmdMov.ParamByName('AlmacenID').AsInteger:=AlmacenID;
      cmdMov.ParamByName('TipoMovimientoAlmacenID').AsInteger:=2;
      cmdMov.ParamByName('UsuarioID').AsInteger:= UsuarioID;
      cmdMov.ParamByName('LiquidacionID').AsInteger:= LiquidacionID;
      cmdMov.Execute;
      dsTotalAlmacen.Close;
    end;
    cmdDet.ParamByName('DetalleMovimientoAlmacenID').AsInteger:=Folio('DetalleTransaccionID', '');
    cmdDet.ParamByName('MovimientoAlmacenID').AsInteger:=MovID;
    cmdDet.ParamByName('Cantidad').AsFloat:=Decimales(dsInventario.FieldByName('Cantidad').AsFloat, 2);
    cmdDet.ParamByName('Precio').AsFloat:=Decimales(dsInventario.FieldByName('Precio').AsFloat, 2);
    cmdDet.ParamByName('Importe').AsFloat:=Decimales(dsInventario.FieldByName('Importe').AsFloat, 2);
    cmdDet.ParamByName('ProductoID').AsInteger:=dsInventario.FieldByName('ProductoID').AsInteger;
    cmdDet.Execute;
    dsInventario.Next;
  end;
  dsInventario.Close;

  Result:='OK';
end;

function TServiceValesCupones.AgregaSecuencias(
  const Consumos: aConsumo): Boolean;
var
  I: Integer;
begin
  for I := 0 to Consumos.Count - 1 do
  begin
    if Copy(Consumos[I].Tarjeta, 1, 4) = '0005' then
      QuemarCupon(Consumos[I], Consumos[I].Tarjeta)
    else
      TarjetaConsumo(Consumos[I].Tarjeta, Consumos[I]);
  end;
  Result:=True;
end;

function TServiceValesCupones.AgrupacionesBomba(
  const EstacionID: Integer): AAgrupacion;
var
  ds: IDADataset;
  Aux: Integer;
  MiNodo: TAgrupacion;
begin
  Result:=AAgrupacion.Create;
  ds:=Schema.NewDataset(Connection, 'spAgrupacionesBomba');
  ds.ParamByName('EstacionID').AsInteger:=EstacionID;
  ds.Open;
  Aux:=-1978;
  MiNodo:=nil;
  while not ds.EOF do
  begin
    if Aux <> ds.FieldByName('AgrupacionID').AsInteger then
    begin
      Aux:=ds.FieldByName('AgrupacionID').AsInteger;
      MiNodo:=Result.Add;
      MiNodo.AgrupacionID:=Aux;
    end;
    MiNodo.Bombas.Add(ds.FieldByName('BombaID').AsInteger);
    ds.Next;
  end;
  ds.Close;
end;

procedure TServiceValesCupones.AsignaBombas;
var
  ds: IDADataset;
  nBomba: Integer;
begin
  ds:=Schema.NewDataset(Connection, 'AsignaBombas');
  ds.Open;
  Global.TotalBombas:=ds.FieldByName('TotalBombas').AsInteger;
  while not ds.EOF do
  begin
    nBomba:=ds.FieldByName('BombaID').AsInteger;
    Global.Bombas[nBomba].NoMangueras:=ds.FieldByName('Mangueras').AsInteger;
    Global.Bombas[nBomba].Mangueras[ds.FieldByName('MangueraID').AsInteger].NoGasolina:=ds.FieldByName('IDInterno').AsInteger;
    Global.Bombas[nBomba].LecturasFinales[ds.FieldByName('MangueraID').AsInteger].CashMoney:=ds.FieldByName('LecturaInicialImporte').AsFloat;
    Global.Bombas[nBomba].LecturasFinales[ds.FieldByName('MangueraID').AsInteger].CashVolume:=ds.FieldByName('LecturaInicialVolumen').AsFloat;
    Global.Bombas[nBomba].TurnoID:=ds.FieldByName('TurnoID').AsInteger;
    Global.Bombas[nBomba].Flujo.Minimo:=ds.FieldByName('Minimo').AsString;
    Global.Bombas[nBomba].Flujo.Maximo:=ds.FieldByName('Maximo').AsString;
    Global.Bombas[nBomba].Modo:=eModoOperacion(ds.FieldByName('Modo').AsInteger);
    Global.Bombas[nBomba].FactorDecimal.CambioPrecios:=ds.FieldByName('FactorCambioPrecios').AsFloat;
    Global.Bombas[nBomba].FactorDecimal.VentaPrecio:=ds.FieldByName('FactorPrecio').AsFloat;
    Global.Bombas[nBomba].FactorDecimal.VentaVolumen:=ds.FieldByName('FactorVolumen').AsFloat;
    Global.Bombas[nBomba].FactorDecimal.VentaImporte:=ds.FieldByName('FactorImporte').AsFloat;
    Global.Bombas[nBomba].FactorDecimal.LecturasVolumen:=ds.FieldByName('FactorLecturaVolumen').AsFloat;
    Global.Bombas[nBomba].FactorDecimal.LecturasImporte:=ds.FieldByName('FactorLecturaImporte').AsFloat;
    Global.Bombas[nBomba].FactorDecimal.PrefijarVolumen:=ds.FieldByName('FactorPrefijarVolumen').AsFloat;
    Global.Bombas[nBomba].FactorDecimal.PrefijarImporte:=ds.FieldByName('FactorPrefijarImporte').AsFloat;
    Global.Bombas[nBomba].FactorDecimal.DespliegaVolumen:=ds.FieldByName('FactorDespliegaVolumen').AsFloat;
    Global.Bombas[nBomba].FactorDecimal.DespliegaImporte:=ds.FieldByName('FactorDespliegaImporte').AsFloat;
    Global.Bombas[nBomba].MaximoLecturasImporte:=ds.FieldByName('MaximoLecturasImporte').AsFloat;
    Global.Bombas[nBomba].MaximoLecturasVolumen:=ds.FieldByName('MaximoLecturasVolumen').AsFloat;
    Global.Bombas[nBomba].AutoImprimir:=ds.FieldByName('AutoImprimir').AsBoolean;
    Global.Bombas[nBomba].NombreImpresora:=ds.FieldByName('Impresora').AsString;
    Global.Bombas[nBomba].Ticket:=eImpresionTicket_itNoImprime;
    Global.Bombas[nBomba].AutorizacionAutomatica:=0;

    if ServerDataModule.BombasOffLine then
       Global.Bombas[nBomba].Estado:=eEstadoBomba_ebUnknown
    else
       Global.Bombas[nBomba].Estado:=eEstadoBomba_ebOffLine;

    ds.Next;
    UltimasVentas(nBomba);
  end;
  ds.Close;
  AsignaProductos;
  AsignaEstacion;
  AsignaNodos;
end;

procedure TServiceValesCupones.AsignaDispositivo;
var
  ds: IDADataSet;
  I: Integer;
begin
  ds:=Schema.NewDataset(Connection, 'dbo.Dispositivo');
  ds.Open;
  while not ds.EOF do
  begin
    I:=ds.FieldByName('DispositivoID').AsInteger;
    Global.Dispositivos[I].Puerto:=ds.FieldByName('Puerto').AsInteger;
    Global.Dispositivos[I].Speed:=ds.FieldByName('Velocidad').AsInteger;
    Global.Dispositivos[I].DataBits:=ds.FieldByName('BitsDatos').AsInteger;
    Global.Dispositivos[I].Parity:=ds.FieldByName('Paridad').AsInteger;
    Global.Dispositivos[I].StopBits:=ds.FieldByName('BitParo').AsInteger;
    Global.Dispositivos[I].RetardoLectura:=ds.FieldByName('RetardoLectura').AsInteger;
    Global.Dispositivos[I].RetardoCiclo:=ds.FieldByName('RetardoCiclo').AsInteger;
    Global.Dispositivos[I].Activo:=ds.FieldByName('Activo').AsBoolean;
    ds.Next;
  end;
  ds.Close;
end;

procedure TServiceValesCupones.AsignaEstacion;
var
  ds: IDADataset;
begin
  ds:=Schema.NewDataset(Connection, 'dbo.Estacion');
  ds.Open;
  Global.Estacion:=ds.FieldByName('IDEstacion').AsInteger;
  Global.Fabricante:=eFabricante(ds.FieldByName('Fabricante').AsInteger);
  Global.NombreEstacion:=ds.FieldByName('Nombre').AsString;
  Global.SIIC:=ds.FieldByName('ClavePemex').AsString;
  Global.RFC:=ds.FieldByName('RFC').AsString;
  ds.Close;
end;

procedure TServiceValesCupones.AsignaNodos;
var
  ds: IDADataSet;
begin
  ds:=Schema.NewDataset(Connection, 'dbo Nodo');
  ds.Open;
  while not ds.EOF do
  begin
    with ServerDataModule.Nodos.Add do
    begin
      Nombre:=ds.FieldByName('Nombre').AsString;
      Tipo:=ds.FieldByName('Tipo').AsInteger;
      Gasolinero:=ds.FieldByName('GasolineroID').AsInteger;
      Host:=ds.FieldByName('Host').AsString;
    end;
    ds.Next;
  end;
  ds.Close;
end;

procedure TServiceValesCupones.AsignaProductos;
var
  ds: IDADataset;
  dscp: IDADataset;
begin
  ds:=Schema.NewDataset(Connection, 'AsignaProductos');
  ds.Open;
  while not ds.EOF do
  begin
    Global.Gasolinas[ds.FieldByName('IDInterno').AsInteger].Precio:=ds.FieldByName('Precio').AsFloat;
    Global.Gasolinas[ds.FieldByName('IDInterno').AsInteger].PrecioProgramado:=ds.FieldByName('PrecioProgramado').AsFloat;
    Global.Gasolinas[ds.FieldByName('IDInterno').AsInteger].Impuesto:=ds.FieldByName('Impuesto').AsFloat;
    Global.Gasolinas[ds.FieldByName('IDInterno').AsInteger].Nombre:=ds.FieldByName('Nombre').AsString;
    Global.Gasolinas[ds.FieldByName('IDInterno').AsInteger].ClavePemex:=ds.FieldByName('Codigo').AsString;
    Global.Gasolinas[ds.FieldByName('IDInterno').AsInteger].IEPS:=ds.FieldByName('IEPS').AsFloat;
    Global.Gasolinas[ds.FieldByName('IDInterno').AsInteger].IEPSProgramado:=ds.FieldByName('IEPSProgramado').AsFloat;
    with Global.CambioPrecio.Precios.Add do
    begin
      ProductoID:=ds.FieldByName('ProductoID').AsInteger;
      Precio:=ds.FieldByName('PrecioProgramado').AsFloat;
      IEPS:=ds.FieldByName('IEPSProgramado').AsFloat;
    end;
{    case ds.FieldByName('IDInterno').AsInteger of
      1: Global.CambioPrecio.Producto1:=ds.FieldByName('PrecioProgramado').AsFloat;
      2: Global.CambioPrecio.Producto2:=ds.FieldByName('PrecioProgramado').AsFloat;
      3: Global.CambioPrecio.Producto3:=ds.FieldByName('PrecioProgramado').AsFloat;
      4: Global.CambioPrecio.Producto4:=ds.FieldByName('PrecioProgramado').AsFloat;
      5: Global.CambioPrecio.Producto5:=ds.FieldByName('PrecioProgramado').AsFloat;
    end;}
    ds.Next;
  end;
  ds.Close;
  dscp:=Schema.NewDataset(Connection, 'dbo.CambioPrecio');
  dscp.Open;
  if not dscp.IsEmpty then
  begin
    Global.CambioPrecio.Activo:=dscp.FieldByName('Activo').AsBoolean;
    Global.CambioPrecio.Fecha:=dscp.FieldByName('Fecha').AsDateTime;
  end
  else
    Global.CambioPrecio.Activo:=False;
  dscp.Close;
end;

procedure TServiceValesCupones.AsignaTanques;
var
  ds: IDADataset;
begin
  ds:=Schema.NewDataset(Connection, 'AsignaTanques');
  ds.Open;
  Global.Telemedicion:=ds.FieldByName('Telemedicion').AsInteger;
  while not ds.EOF do
  begin
    with Global.Tanques.Add do
    begin
      TanqueID:=ds.FieldByName('TanqueID').AsInteger;
      ProductoID:=ds.FieldByName('ProductoID').AsInteger;
      Tanque:=ds.FieldByName('Tanque').AsInteger;
      Nombre:=ds.FieldByName('Nombre').AsString;
      Capacidad:=ds.FieldByName('Capacidad').AsFloat;
      Fondaje:=ds.FieldByName('Fondaje').AsFloat;
      Inicial:=ds.FieldByName('Inicial').AsFloat;
    end;
    ds.Next;
  end;
  ds.Close;
end;

procedure TServiceValesCupones.AutoCambioPrecio;
var
  cmd: IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection, 'AutoCambioPrecio');
  cmd.Execute;
end;

function TServiceValesCupones.AutorizaTarjeta(
  const Autoriza: TAutoriza): TTarjeta;
var
  DataSet: IDADataSet;
  ClienteID, VehiculoID, GasolineroID: Integer;
  Importe, Volumen: Double;
  Procesar : TProcesaTarjeta;
  msn:String;
  aBarras: String;

{pla_GOB}//-GOBIERNO DEL ESTADO------------------------------------------------}
  //SALDOGOB: Double;
  //AutGOB: TAutorizaGOB;
{pla_GOB}//--------------------------------------------------------------------}
begin
  Procesar :=  TProcesaTarjeta.Create();
  Result:=TTarjeta.Create;
  Result.Status:=ERR_SINCOMUNICACION;
  Result.Valido:= False;
  //SALDOGOB:= 0;

  if Length(Autoriza.Referencia) <= 10 then
  begin
     ABarras:=IntToStr(ClaveToID(Autoriza.Referencia));
     Autoriza.Referencia:= ABarras;
  end;

  try
  DataSet:= Schema.NewDataset(Connection, 'spBuscaReferencia');
  DataSet.ParamByName('Referencia').AsString:= Autoriza.Referencia;
  DataSet.Open;


{pla_GOB}//--VALIDA GOBIERNO DEL ESTADO--BC-----------------------------------//
   //if DataSet.IsEmpty then
   //   if (copy(Autoriza.Referencia,1,1) <> '0') and (ServerDataModule.AUTORIZAGOB = 'S') then
   //   begin
   //      AutGOB:= TAutorizaGOB.Create();
   //      AutGOB.Assign(AutorizaGOB(Autoriza.Referencia));

   //      SALDOGOB:= AutGOB.SALDOGOB;
   //      DataSet.Close;
   //      DataSet.ParamByName('Referencia').AsString:= AutGOB.REFERENCIAGOB;
   //      DataSet.Open;
   //   end;
{pla_GOB}//--VALIDA GOBIERNO DEL ESTADO--BC-----------------------------------//


  if not DataSet.IsEmpty then
  begin
      ClienteID   := DataSet.FieldByName('ClienteID').AsInteger;
      VehiculoID  := DataSet.FieldByName('VehiculoID').AsInteger;
      GasolineroID:= DataSet.FieldByName('GasolineroID').AsInteger;

      if not (BuscaAutorizacionTarjeta(ClienteID, VehiculoID, GasolineroID)) then
      begin
        DataSet:=Schema.NewDataset(Connection, 'ValidarTarAutorizaciones');
        //DataSet.ParamByName('Identificador').AsInteger:=TProcesaTarjeta(MiRef.Procesa).IdentificadorID;
        DataSet.ParamByName('ClienteID').AsInteger:=ClienteID;
        DataSet.ParamByName('TarjetaID').AsInteger:=VehiculoID;
        DataSet.Open;
        if not DataSet.IsEmpty then
        begin
          msn:= 'Paso ValidarAutorizaciones';
          Procesar.curLitTarProceso:=DataSet.FieldByName('Volumen').AsFloat;
          Procesar.curImpTarProceso:=DataSet.FieldByName('Importe').AsFloat;
        end;
        DataSet.Close;

        DataSet:=Schema.NewDataset(Connection, 'ValidarTarSaldoEjercicio');
        //DataSet.ParamByName('Identificador').AsInteger:=Procesar.IdentificadorID;
        DataSet.ParamByName('ClienteIni').AsInteger:=ClienteID;
        DataSet.ParamByName('ClienteFin').AsInteger:=ClienteID;
        DataSet.Open;
        if not DataSet.IsEmpty then
        begin
          msn:= 'Paso ValidarSaldoEjercicio';
          Procesar.curSaldo:=DataSet.FieldByName('Saldo').AsCurrency;

{pla-GOB} //if (ServerDataModule.AUTORIZAGOB ='S') and (SALDOGOB > 0) Then
          //begin
          //    Procesar.curSaldo:= FloatToCurr(SALDOGOB);
          //end;
{pla-GOB}

          Procesar.curCargos:=0;
          Procesar.curAbonos:=0;
        end;
        DataSet.Close;

        DataSet:=Schema.NewDataset(Connection, 'ValidarCliAutorizaciones');
        DataSet.ParamByName('Identificador').AsInteger:=GasolineroID;
        DataSet.ParamByName('ClienteID').AsInteger:=ClienteID;
        DataSet.Open;
        if not DataSet.IsEmpty then
        begin
          msn:= 'Paso Validar CliAutorizaciones';
          Result.RFC:= DataSet.FieldByName('RFC').AsString;
          Procesar.cliNombre:=DataSet.FieldByName('Nombre').AsString;
          Procesar.cliStatus:=DataSet.FieldByName('Estatus').AsString;
          Procesar.cliFormaCompra:=DataSet.FieldByName('FormaCompraID').AsInteger;
          Procesar.cliCuentaContable:=DataSet.FieldByName('CuentaContable').AsString;
          Procesar.cliLimiteCredito:=DataSet.FieldByName('LimiteCredito').AsFloat;
          Procesar.cliImpProceso:=DataSet.FieldByName('Importe').AsFloat;
          Procesar.cliVolProceso:=DataSet.FieldByName('Volumen').AsFloat;
          Procesar.curTipoTarjeta:=DataSet.FieldByName('NombreFormaCompra').AsString;
          Procesar.cliFormaCompra := DataSet.FieldByName('FormaCompraID').AsInteger;
        end;
        DataSet.Close;

        DataSet:=Schema.NewDataset(Connection, 'SaldoTarjeta');
        DataSet.ParamByName('Identificador').AsInteger:=GasolineroID;
        DataSet.ParamByName('ClienteID').AsInteger:=ClienteID;
        DataSet.ParamByName('TarjetaID').AsInteger:=VehiculoID;
        DataSet.Open;
        if not DataSet.IsEmpty then
        begin
          msn:= 'Paso SaldoTarjeta';
          Procesar.DigitoSeguridad:=Autoriza.DigitoSeguridad;
          if Autoriza.Magna > 0 then
            Procesar.Magna:=Autoriza.Magna
          else
            Procesar.Magna:=PrecioProducto(ServerDataModule.EstacionID, 1);
          if Autoriza.Premium > 0 then
            Procesar.Premium:=Autoriza.Premium
          else
            Procesar.Premium:=PrecioProducto(ServerDataModule.EstacionID,2);
          if Autoriza.Diesel > 0 then
            Procesar.Diesel:=Autoriza.Diesel
          else
            Procesar.Diesel:=PrecioProducto(ServerDataModule.EstacionID,3);
          procesar.PresetMN:=Autoriza.PresetMN;
          Procesar.PresetLT:=Autoriza.PresetLT;
          Procesar.SeleccionDeProducto:=Autoriza.SeleccionDeProducto;
          Procesar.curStatus:=DataSet.FieldByName('Estatus').AsString;
          Procesar.curNIP:=DataSet.FieldByName('NIP').AsString;
          Procesar.curClasificacion:=DataSet.FieldByName('Clasificacion').AsInteger;
          Procesar.curFechaVencimiento:=DataSet.FieldByName('FechaExpira').AsDateTime;
          Procesar.curNombre:=DataSet.FieldByName('Nombre').AsString;
          Procesar.curCentroCosto:=DataSet.FieldByName('CentroCostos').AsString;
          Procesar.curIdentificacion:=DataSet.FieldByName('Identificacion').AsString;
          Procesar.curNoEconomico:=DataSet.FieldByName('NumeroEconomico').AsString;
          Procesar.curDepartamento:=DataSet.FieldByName('Departamento').AsString;
          Procesar.curProductoAutorizado:=DataSet.FieldByName('ProductoAutorizado').AsString;
          Procesar.curOdometro:=DataSet.FieldByName('Odometro').AsBoolean;
          Procesar.curFirma:=DataSet.FieldByName('Firma').AsBoolean;
          Procesar.curPlacas:=DataSet.FieldByName('Placas').AsBoolean;
          Procesar.curLunes:=DataSet.FieldByName('Lunes').AsString;
          Procesar.curMartes:=DataSet.FieldByName('Martes').AsString;
          Procesar.curMiercoles:=DataSet.FieldByName('Miercoles').AsString;
          Procesar.curJueves:=DataSet.FieldByName('Jueves').AsString;
          Procesar.curViernes:=DataSet.FieldByName('Viernes').AsString;
          Procesar.curSabado:=DataSet.FieldByName('Sabado').AsString;
          Procesar.curDomingo:=DataSet.FieldByName('Domingo').AsString;
          Procesar.Mensaje:=DataSet.FieldByName('Mensaje').AsString;
          Procesar.curDigitoSeguridad:=DataSet.FieldByName('DigitoSeguridad').AsInteger;
          Procesar.LimiteLTTurno:=DataSet.FieldByName('LimiteLTTurno').AsFloat;
          Procesar.LimiteLTDia:=DataSet.FieldByName('LimiteLTDia').AsFloat;
          Procesar.LimiteLTSemana:=DataSet.FieldByName('LimiteLTSemana').AsFloat;
          Procesar.LimiteLTMes:=DataSet.FieldByName('LimiteLTMes').AsFloat;
          Procesar.LimiteMNTurno:=DataSet.FieldByName('LimiteMNTurno').AsFloat;
          Procesar.LimiteMNDia:=DataSet.FieldByName('LimiteMNDia').AsFloat;
          Procesar.LimiteMNSemana:=DataSet.FieldByName('LimiteMNSemana').AsFloat;
          Procesar.LimiteMNMes:=DataSet.FieldByName('LimiteMNMes').AsFloat;
          Procesar.CargasMaximas:=DataSet.FieldByName('CargasMaximas').AsInteger;

          Procesar.ActualLTTurno:=DataSet.FieldByName('ActualLTTurno').AsFloat;
          Procesar.ActualLTDia:=DataSet.FieldByName('ActualLTDia').AsFloat;
          Procesar.ActualLTSemana:=DataSet.FieldByName('ActualLTSemana').AsFloat;
          Procesar.ActualLTMes:=DataSet.FieldByName('ActualLTMes').AsFloat;
          Procesar.ActualMNTurno:=DataSet.FieldByName('ActualMNTurno').AsFloat;
          Procesar.ActualMNDia:=DataSet.FieldByName('ActualMNDia').AsFloat;
          Procesar.ActualMNSemana:=DataSet.FieldByName('ActualMNSemana').AsFloat;
          Procesar.ActualMNMes:=DataSet.FieldByName('ActualMNMes').AsFloat;
          Procesar.ActualCargas:=DataSet.FieldByName('ActualCargas').AsInteger;
          Procesar.NIP:=Autoriza.NIP;
          Procesar.Odometro:=Autoriza.Odometro;
          Procesar.MaximoVolumen:= 900;
          Procesar.MaximoImporte:= 9000;
        end
        else
          Result.Status:=ERR_DIGITOSEGURIDADINCORRECTO;
        DataSet.Close;

        Result.Status:=Procesar.Procesar;

        if (Result.Status = ERR_OK) then
        begin
          Autoriza.ImporteCantidad:=Procesar.VolumenImporte;
          Autoriza.ClienteID:=ClienteID;
          Autoriza.VehiculoID:=VehiculoID;
          Autoriza.GasolineroID:=GasolineroID;
          Autoriza.Fecha:=Now;
          if Procesar.VolumenImporte = 'I' then
          begin
            Importe:=Procesar.Despacho;
            Volumen:=Importe / Procesar.PrecioAlto;
          end
          else
          begin
            Volumen:=Procesar.Despacho;
            Importe:=Volumen * Procesar.PrecioAlto;
          end;
          Autoriza.Importe:=Importe;
          Autoriza.Cantidad:=Volumen;
          Autoriza.AutorizacionID:=Folio('AutorizacionID', '');
          Autoriza.Tipo:= 1;
          GuardaAutorizacion(Autoriza);

          Result.Cantidad:=Procesar.Despacho;
          Result.Clasificacion:=IntToStr(Procesar.curClasificacion);
          Result.LitrosImporte:=Procesar.VolumenImporte;
          Result.GasolineroID:=GasolineroID;
          Result.VehiculoID:=VehiculoID;
          Result.ClienteID:=ClienteID;
          Result.Identificacion:= Procesar.curIdentificacion;

          Result.Saldo:= Procesar.curSaldo;
          {GOB----}
          Result.Mensaje:= Procesar.curMensaje;
          Result.CentroCostos:= Procesar.curCentroCosto;
          Result.Valido:= True;
          Result.Nombre:= Procesar.curNombre;
          Result.RazonSocial:= Procesar.cliNombre;
          Result.Productos:=Procesar.curProductoAutorizado;
          {Result.FormaCompraID := Procesar.cliFormaCompra;
          Result.NombreFormaCompra := Procesar.curTipoTarjeta}
        end
        else
        begin
          {if Result.Status <> ERR_OK then
            Result:=MiRef.Armar('')
          else
            Result:=MiRef.Armar(MiRef.Procesa.Mensaje + '0|');}
        end;
      end
      else
        Result.Status:= ERR_SALDORETENIDO;
      Result.MsnError:= MensajeDeError(Result.Status);
      Result.Status:=Autoriza.AutorizacionID;
  end
  else
  begin
    Result.Status:= ERR_TARJETANOACTIVA;
    Result.MsnError:= MensajeDeError(Result.Status);
  end;
  except
    on E : Exception do
       Result.MsnError:= E.ClassName+' error raised, with message : '+E.Message;
       //ShowMessage(E.ClassName+' error raised, with message : '+E.Message);
  end;

  //HTTPRIO.Free;
end;

function TServiceValesCupones.BuscaAutorizacion(
  const Referencia: String): Boolean;
var
  DataSet: IDADataset;
begin
  Result:= False;
  DataSet := Schema.NewDataset(Connection,'spBuscaAutorizacion');
  DataSet.ParamByName('Barras').AsString:= Referencia;
  DataSet.Open;

  if not DataSet.IsEmpty then
     Result:= True;
end;

function TServiceValesCupones.BuscaAutorizacionTarjeta(const ClienteID,
  VehiculoID, GasolineroID: Integer): Boolean;
var
  DataSet: IDADataset;
begin
  Result:= False;
  DataSet := Schema.NewDataset(Connection,'spBuscaAutorizacionTarjeta');
  DataSet.ParamByName('ClienteID').AsInteger:= ClienteID;
  DataSet.ParamByName('VehiculoID').AsInteger:= VehiculoID;
  DataSet.ParamByName('GasolineroID').AsInteger:= GasolineroID;
  DataSet.Open;

  if not DataSet.IsEmpty then
     Result:= True;

end;

function TServiceValesCupones.BuscaClientexVehiculo(
  const VehiculoID: Integer): Integer;
var
  S: String;
  ds: IDADataset;
begin
  Result:=0;
  try
    S:= Format('Select ClienteID from Vehiculo where VehiculoID = %d', [VehiculoID]);
    ds:=Connection.NewDataset(S, 'BuscaClientexVehiculo');
    ds.Open;
    Result:=ds.FieldByName('ClienteID').AsInteger;
    ds.Close;
  except
  end;
end;

function TServiceValesCupones.BuscaDespachadorLiquidacion(const BombaID,
  EstacionID, TurnoID: Integer): Integer;
var
  ds: IDADataset;
  cmd: IDASQLCommand;
begin
  ds:=Schema.NewDataset(Connection, 'spBuscaDespachadorLiquidacion');
  ds.ParamByName('BombaID').AsInteger:=BombaID;
  ds.ParamByName('EstacionID').AsInteger:=BombaID;
  ds.ParamByName('TurnoID').AsInteger:=BombaID;
  ds.Open;
  if ds.IsEmpty then
  begin
    Result:=Folio('DespachadorLiquidacionID', '');
    cmd:=Schema.NewCommand(Connection, '');
    cmd.ParamByName('BombaID').AsInteger:=BombaID;
    cmd.ParamByName('EstacionID').AsInteger:=EstacionID;
    cmd.ParamByName('TurnoID').AsInteger:=TurnoID;
    cmd.ParamByName('DespachadorLiquidacionID').AsInteger:=Result;
    cmd.Execute;
  end
  else
    Result:=ds.FieldByName('DespachadorLiquidacionID').AsInteger;
end;

function TServiceValesCupones.BuscaHost(const Tipo,
  Gasolinero: Integer): AnsiString;
var
  Ok: Boolean;
  I: Integer;
begin
  Result:='';
  //if Tipo <= 5 then
  //  Tipo:=1;

  Ok:=False;
  for I := 0 to ServerDataModule.Nodos.Count - 1 do
  begin
    if (ServerDataModule.Nodos[I].Tipo = Tipo) and (ServerDataModule.Nodos[I].Gasolinero = Gasolinero) then
    begin
      OK:=True;
      Result:=ServerDataModule.Nodos[I].Host;
      Break;
    end;
  end;
  if not OK then
    Result:=ServerDataModule.FDefaultHost;
end;

function TServiceValesCupones.BuscaOtroProducto(const EstacionID: Integer;
  const Codigo: Ansistring): TOtroProducto;
var
  ds: IDADataset;
begin
  Result:=TOtroProducto.Create;
  Result.ID:=0;
  ds:=Schema.NewDataset(Connection, 'spBuscaOtroProducto');
  ds.ParamByName('EstacionID').AsInteger:=EstacionID;
  ds.ParamByName('Codigo').AsString:=Codigo;
  ds.Open;
  if not ds.IsEmpty then
  begin
    Result.ID:=ds.FieldByName('ProductoID').AsInteger;
    Result.Nombre:=ds.FieldByName('Nombre').AsString;
    Result.Codigo:=ds.FieldByName('Codigo').AsString;
    Result.Barras:=ds.FieldByName('Barras').AsString;
    Result.Precio:=ds.FieldByName('Precio').AsFloat;
  end;
  ds.Close;
end;

function TServiceValesCupones.BuscaReporte(const Nombre: AnsiString;
  const TipoTemplate: Integer): TReporte;
var
  ds: IDADataset;
begin
  Result:=nil;
  ds:=Schema.NewDataset(Connection, 'BuscaReporte');
  ds.ParamByName('Nombre').AsString:=UpperCase(Nombre);
  ds.Open;
  if not ds.IsEmpty then
  begin
    Result:=TReporte.Create;
    Result.SQL1:=ds.FieldByName('SQL1').AsString;
    Result.SQL2:=ds.FieldByName('SQL2').AsString;
    Result.CampoJoin:=ds.FieldByName('CampoJoin').AsString;
    case TipoTemplate of
    2: Result.Template:=ds.FieldByName('TemplateMedia').AsString;
    3: Result.Template:=ds.FieldByName('TemplateBaja').AsString;
    else
      Result.Template:=ds.FieldByName('Template').AsString;
    end;
  end;
  ds.Close;
end;

function TServiceValesCupones.BuscarReporte(const Nombre: AnsiString): TReporte;
var
  MiDataSet: IDADataSet;
begin
  Result:=nil;
  MiDataSet:=Schema.NewDataset(Connection, 'BuscarReporte');
  MiDataSet.ParamByName('Nombre').AsString:=UpperCase(Nombre);
  MiDataSet.Open;
  if not MiDataSet.IsEmpty then
  begin
    Result:=TReporte.Create;
    Result.SQL1:=MiDataSet.FieldByName('SQL1').AsString;
    Result.SQL2:=MiDataSet.FieldByName('SQL2').AsString;
    Result.Template:=MiDataSet.FieldByName('Template').AsString;
    Result.CampoJoin:=MiDataSet.FieldByName('CampoJoin').AsString;
  end;
  MiDataSet.Close;
end;

function TServiceValesCupones.BuscaSagarpa(const EstacionID: Integer): TSagarpa;
var
  ds: IDADataset;
begin
  Result:=TSagarpa.Create;
  ds:=Schema.NewDataset(Connection, 'spBuscaSagarpa');
  ds.ParamByName('EstacionID').AsInteger:=EstacionID;
  ds.Open;
  Result.ClienteSagarpa:=ds.FieldByName('ClienteSagarpa').AsInteger;
  Result.ClienteSagarpaPemex:=ds.FieldByName('ClienteSagarpaPemex').AsInteger;
  ds.Close;
end;

function TServiceValesCupones.BuscaTicketsFactura(FacturaID: Integer): String;
var
  ds: IDADataset;
  Tickets: String;
begin
  Result := '';
  Tickets := '';
  try
    ds := Schema.NewDataset(Connection, 'spBuscaTicketFactura');
    ds.ParamByName('FacturaID').AsInteger := FacturaID;
    ds.Open;

    while not ds.EOF do
    begin
      Tickets := Tickets + ds.FieldByName('SecuenciaVenta').AsString;
      ds.Next;

      if not ds.EOF then Tickets := Tickets + ',';
    end;
  finally
    ds.Close;
  end;
  Result := Tickets
end;

procedure TServiceValesCupones.CalculaIEPS(var Datos: TDatosFactura);
var
  Aux, Impuesto: Double;
  SubTotal: Double;
  I: Integer;
begin
  SubTotal:=0;
  for I := 0 to Datos.Detalles.Count - 1 do
  begin
    Impuesto:=IEPS(Datos.Detalles[I].ProductoID);
    Aux:=Datos.Detalles[I].Precio - Impuesto;
    Aux:=Aux / (1 + (Datos.Factura.ImpuestoPorcentaje / 100));
    Aux:=Aux + Impuesto;
    Aux:=Decimales(Aux, 6);
    Datos.Detalles[I].Precio:=Aux;
    Datos.Detalles[I].Cantidad:=Decimales(Datos.Detalles[I].Cantidad, 4);
    Datos.Detalles[I].Importe:=Decimales(Aux * Datos.Detalles[I].Cantidad, 2);
    SubTotal:=SubTotal + Datos.Detalles[I].Importe;
  end;
  Datos.Factura.Total:=Decimales(Datos.Factura.Total, 2);
  Datos.Factura.Subtotal:=Decimales(SubTotal, 2);
  Datos.Factura.Impuesto:=Decimales(Datos.Factura.Total - SubTotal, 2);
end;

procedure TServiceValesCupones.CalculaIEPSExpress(var Datos: TFacturaExpress);
var
  Aux, Impuesto: Double;
  SubTotal: Double;
  I: Integer;

  ds: IDADataset;
begin
  ds:=Schema.NewDataset(Connection, 'spIEPS');

  SubTotal:=0;
  for I := 0 to Datos.Detalle.Count - 1 do
  begin
    Impuesto:=IEPS(StrToInt(Datos.Detalle[I].Codigo));
    Aux:=Datos.Detalle[I].Precio - Impuesto;
    Aux:=Aux / (1 + (Datos.Impuesto / 100));
    Aux:=Aux + Impuesto;
    Aux:=Decimales(Aux, 6);
    Datos.Detalle[I].Precio:=Aux;
    Datos.Detalle[I].Cantidad:=Decimales(Datos.Detalle[I].Cantidad, 4);
    Datos.Detalle[I].Importe:=Decimales(Aux * Datos.Detalle[I].Cantidad, 2);
    SubTotal:=SubTotal + Datos.Detalle[I].Importe;
  end;
  Datos.Total:=Decimales(Datos.Total, 2);
  Datos.Subtotal:=Decimales(SubTotal, 2);
  Datos.IVA:=Decimales(Datos.Total - Datos.Subtotal, 2);
end;

procedure TServiceValesCupones.CalculaISR_IVARTN(var Datos: TDatosFactura);
var
  I: Integer;
  ds: IDADataset;

  dostercerasPartes: Float;
begin
  dostercerasPartes:= 2 / 3;
  ds:=Schema.NewDataset(Connection, 'spISRIVARTN');
  ds.ParamByName('EmpresaID').AsInteger:= Datos.Factura.EstacionID;
  ds.Open;

  Datos.Factura.ISR := 0;
  for I := 0 to Datos.Detalles.Count - 1 do
  begin

    Datos.Factura.ISR:=   Datos.Factura.ISR +
    (Datos.Detalles[I].Importe - (Datos.Detalles[I].Importe / (1 + (ds.FieldByName('ISR').AsFloat / 100))));

  end;
  Datos.Factura.IVARTN:=  Datos.Factura.Impuesto * (dostercerasPartes);

  Datos.Factura.Total:=Decimales(Datos.Factura.Total - Datos.Factura.ISR -  Datos.Factura.IVARTN, 2);
end;

function TServiceValesCupones.PuntosCalculaPuntos(const ClienteID, ProductoID: Integer;
  const Volumen: Double): Double;
var
  ds: IDADataset;
  FactorNacimiento, FactorCliente, FactorProducto: Double;
begin
  ds:=Schema.NewDataset(Connection, 'spPuntosFactor');
  ds.ParamByName('ClienteID').AsInteger:=ClienteID;
  ds.ParamByName('ProductoID').AsInteger:=ProductoID;
  ds.ParamByName('Fecha').AsDateTime:=Trunc(Now);
  ds.Open;
  FactorCliente:=ds.FieldByName('FactorCliente').AsFloat;
  FactorProducto:=ds.FieldByName('FactorProducto').AsFloat;
  FactorNacimiento:=ds.FieldByName('FactorNacimiento').AsFloat;
  if FactorCliente = 0 then
    FactorCliente:=1;
  if FactorProducto = 0 then
    FactorProducto:=1;
  if FactorNacimiento = 0 then
    FactorNacimiento:=1;

  Result:=Volumen * FactorCliente * FactorProducto * FactorNacimiento;
end;

function TServiceValesCupones.PuntosCalculaSaldo(
  const ClienteID: Integer): Double;
var
  ds: IDADataset;
begin
  ds:=Schema.NewDataset(Connection, 'spPuntosSaldo');
  ds.ParamByName('ClienteID').AsInteger:=ClienteID;
  ds.Open;
  Result:=Decimales(ds.FieldByName('Saldo').AsFloat, 2);
  while not ds.EOF do
  begin
    Result:=Result + PuntosCalculaPuntos(ClienteID, ds.FieldByName('ProductoID').AsInteger, ds.FieldByName('Volumen').AsFloat);
    ds.Next;
  end;
  ds.Close;
end;

function TServiceValesCupones.PuntosDatos(
  const ClienteID: Integer): TDatosPuntos;
var
  ds: IDADataset;
begin
  Result := TDatosPuntos.Create;

  try
    ds := Schema.NewDataset(Connection, 'spPuntosDatos');
    ds.ParamByName('ClienteID').AsInteger := ClienteID;
    ds.Open;

    Result.ClienteID := ClienteID;
    Result.ApellidoPaterno := ds.FieldByName('ApellidoPaterno').AsString;
    Result.ApellidoMaterno := ds.FieldByName('ApellidoMaterno').AsString;
    Result.Nombres := ds.FieldByName('Nombres').AsString;
    Result.email := ds.FieldByName('email').AsString;
    Result.Nacimiento := Trunc(ds.FieldByName('Nacimiento').AsDateTime);
    Result.Referencia := ds.FieldByName('Referencia').AsString;
    Result.Telefonos := ds.FieldByName('Telefonos').AsString;
    Result.FacturaExpress := ds.FieldByName('FacturaExpress').AsBoolean;
    Result.PuntosCategoriaID := ds.FieldByName('PuntosCategoriaID').AsInteger;
    Result.Sexo := ds.FieldByName('Sexo').AsInteger;
    Result.FechaRegistro := ds.FieldByName('FechaAltaExpress').AsDateTime;
    Result.PuntosClubID := ds.FieldByName('PuntosClubID').AsInteger;
  finally
    ds.Close;
  end;
end;

procedure TServiceValesCupones.PuntosDespachador(const TurnoID, EstacionID,
  UsuarioID: Integer);
var
  ds: IDADataSet;
  cmd:IDASQLCommand;
  cmd2:IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection,'spInsertaPuntosDespachador');
  cmd2:=Schema.NewCommand(Connection,'spLimpiapuntosDespachadorTurno');
  ds:=Schema.NewDataset(Connection, 'spObtenPuntosDespachador');
  ds.ParamByName('ESTACIONID').AsInteger:=EstacionID;
  ds.ParamByName('TURNOID').AsInteger:=TurnoID;
  ds.Open;

  cmd2.ParamByName('ESTACIONID').AsInteger:=  ds.FieldByName('ESTACIONID').AsInteger;
  cmd2.ParamByName('TURNOID').AsInteger:=     ds.FieldByName('TURNOID').AsInteger;
  cmd2.ParamByName('LIQUIDACIONID').AsInteger:=   ds.FieldByName('LIQUIDACIONID').AsInteger;
  cmd2.Execute;

  while not ds.EOF do
  begin
     cmd.ParamByName('MOVIMIENTODESPACHADORID').AsInteger:=Folio('MovimientoDespachadorID','');
     cmd.ParamByName('FECHA').AsDateTime:= ds.FieldByName('FECHAINICIO').AsDateTime;
     cmd.ParamByName('EJERCICIO').AsInteger:= ds.FieldByName('EJERCICIO').AsInteger;
     cmd.ParamByName('PERIODO').AsInteger:= ds.FieldByName('PERIODO').AsInteger;
     cmd.ParamByName('USUARIOID').AsInteger:= UsuarioID;
     cmd.ParamByName('DESPACHADORID').AsInteger:= ds.FieldByName('DESPACHADORID').AsInteger;
     cmd.ParamByName('TURNOID').AsInteger:= ds.FieldByName('TURNOID').AsInteger;
     cmd.ParamByName('LIQUIDACIONID').AsInteger:= ds.FieldByName('LIQUIDACIONID').AsInteger;
     cmd.ParamByName('ESTACIONID').AsInteger:= ds.FieldByName('ESTACIONID').AsInteger;
     cmd.ParamByName('REFERENCIA').AsString:= ds.FieldByName('NOMBRE').AsString;
     cmd.ParamByName('PRODUCTOID').AsInteger:= ds.FieldByName('PRODUCTOID').AsInteger;
     cmd.ParamByName('CARGO').AsInteger:= ds.FieldByName('PUNTOS').AsInteger;
     cmd.ParamByName('ABONO').AsInteger:= 0;
     cmd.ParamByName('DIA').AsInteger:= ds.FieldByName('DIA').AsInteger;
     cmd.Execute;

     ds.Next;
  end;
end;

function TServiceValesCupones.CambiaFolioFactura(const Serie: AnsiString;
  const Folio: Integer; const NewSerie: AnsiString; const NewFolio: Integer): AnsiString;
var
  cmd: IDADataset;
begin
  cmd:=Schema.NewDataset(Connection, 'spCambiaFolioFactura');
  cmd.ParamByName('Serie').AsString:=Serie;
  cmd.ParamByName('Folio').AsInteger:=Folio;
  cmd.ParamByName('NewSerie').AsString:=NewSerie;
  cmd.ParamByName('NewFolio').AsInteger:=NewFolio;
  cmd.Open;
  Result:=cmd.FieldByName('Resultado').AsString;
  cmd.Close;
end;

function TServiceValesCupones.CambioFactura(const Serie: AnsiString;
  const Folio: Integer; const NuevaSerie: AnsiString; const NuevoFolio: Integer;
  const FechaImpresion: DateTime): AnsiString;
var
  cmd : IDASQLCommand;
begin
  if (DatosFactura(NuevoFolio,NuevaSerie)) then
  begin
      cmd := Schema.NewCommand(Connection, 'spCambioNumeroFactura');
      cmd.ParamByName('Serie').AsString := Serie;
      cmd.ParamByName('Folio').AsInteger:= Folio;
      cmd.ParamByName('NuevaSerie').AsString:=NuevaSerie;
      cmd.ParamByName('NuevoFolio').AsInteger:=NuevoFolio;
      cmd.ParamByName('FechaImpresion').AsDateTime:=FechaImpresion;
      cmd.Execute;
      Result := 'Cambio de Folio a Factura Exitoso';
  end Else Result := 'La factura ya existe';
end;

function TServiceValesCupones.CancelaFactura(const Folio: Integer;
  const Serie: Ansistring; const Fecha: TDateTime; const EstacionID,
  UsuarioID: Integer): Ansistring;
var
  ds:IDADataset;
begin
  Result:='';
  ds:=Schema.NewDataset(Connection, 'spCancelaFactura');
  ds.ParamByName('Folio').AsInteger:=Folio;
  ds.ParamByName('Serie').AsString:=Serie;
  ds.ParamByName('Fecha').AsDateTime:=Fecha;
  ds.ParamByName('EstacionID').AsInteger:=EstacionID;
  ds.ParamByName('UsuarioID').AsInteger:=UsuarioID;
  ds.Open;
  Result:=ds.FieldByName('Resultado').AsString;
end;

function TServiceValesCupones.CancelaGrupo(const Grupo: Integer): Boolean;
var
  cmd: IDASQLCommand;
begin
  try
    cmd:=Schema.NewCommand(Connection, 'spCancelaGrupo');
    cmd.ParamByName('Grupo').AsInteger:=Grupo;
    cmd.Execute;
    Result:=True;
  finally
  end;
end;

procedure TServiceValesCupones.CancelaGrupoC(const BombaID, Grupo: Integer);
begin
  Flotillas.CancelaGrupo(Grupo, Global.Bombas[BombaID].Host);
end;

function TServiceValesCupones.CancelarCupones(const Lista: AnsiString;
  const UsuarioID: Integer): AnsiString;
var
  Aux: TStrings;
  I: Integer;
  cmd: IDASQLCommand;
  Fecha: TDateTime;
begin
  Fecha:=Now;
  Aux:=TStringList.Create;
  cmd:=Schema.NewCommand(Connection, 'UPDCancelaCupon');
  Result:='Error al cancelar los cupones.';
  try
    Aux.Text:=Lista;
    for I := 0 to Aux.Count - 1 do
    begin
      cmd.ParamByName('Codigo').AsString:=Aux[I];
      cmd.ParamByName('Fecha').AsDateTime:=Fecha;
      cmd.ParamByName('UsuarioID').AsInteger:=UsuarioID;
      cmd.Execute;
    end;
    Result:='Los cupones fueron cancelados correctamente.';
  finally
    Aux.Free;
  end;
end;

function TServiceValesCupones.CancelarLote(const LoteID,
  UsuarioID: Integer): AnsiString;
var
  ds: IDADataset;
begin
  ds:=Schema.NewDataset(Connection, 'spCancelaLote');
  ds.ParamByName('LoteID').AsInteger:=LoteID;
  ds.ParamByName('UsuarioID').AsInteger:=UsuarioID;
  ds.Open;
  Result:=ds.FieldByName('Resultado').AsString;
end;

function TServiceValesCupones.CaracteresCupon: AnsiString;
var
  Aux: TStrings;
  I: Integer;
begin
  Result:='';
  Aux:=TStringList.Create;
  try
    for I := 1 to 5 do
      Aux.Add(CaracteresCupones[I]);
    Result:=Aux.Text;
  finally
    Aux.Free;
  end;
end;

function TServiceValesCupones.CERs(const DIR: AnsiString): AnsiString;
begin
  Result:= CER('',DIR);
end;

function TServiceValesCupones.CERsNum(const DIR: AnsiString): AnsiString;
begin
  Result:= CERNum('',DIR);
end;

function TServiceValesCupones.CER(const texto, Dir: AnsiString): string;
var
  F:TextFile;
  S: String;
begin
  EjecutaComando('openssl x509 -inform DER -in '+Dir+' > Temp.txt"');

  {$I-}
  AssignFile( F, 'Temp.txt' );
  Reset(F);

  while not EOF(F) do
  begin
  ReadLn(F, S);
  Result:= Result + S;
  end;
  CloseFile(F);

  Delete(Result,1,27);
  Delete(Result,Length(Result)-24,Length(Result));
  {$I+}

  DeleteFile('Temp.txt');
  Result:='1';
end;

function TServiceValesCupones.CERNUM(const texto, Dir: AnsiString): String;
var
  F:TextFile;
  S: String;
  serial:String;
  I, count:Integer;
begin
  count:= 2;
  EjecutaComando('openssl x509 -inform DER -in '+Dir+' -noout -serial > Temp2.txt"');

  {$I-}
  AssignFile( F, 'Temp2.txt' );
  Reset(F);

  while not EOF(F) do
  begin
  ReadLn(F, S);
  Serial:= Serial + S;
  end;
  CloseFile(F);

  Serial:= Copy(Serial,8,Length(Serial));

  for I := 1 to (Length(Serial) - 1) do
  begin
    if count <= Length(Serial) then
    begin
      Result:= Result + Serial[count];
      count:= count + 2;
    end;
  end;

  {$I+}

  DeleteFile('Temp2.txt');
end;

function TServiceValesCupones.CierraLiquidacion(
  const LiquidacionID: Integer): Ansistring;
var
  ds: IDADataSet;
  dsFaltantes: IDADataSet;
  MiEstacionID: Integer;
  cmdFyP, cmdDetLiq, cmdCierra: IDASQLCommand;
  MiFecha: TDateTime;
begin
  Result:='OK';
  ds:=Schema.NewDataset(Connection, 'spValidaCierreLiquidacion');
  ds.ParamByName('LiquidacionID').AsInteger:=LiquidacionID;
  ds.Open;
  MiEstacionID:=ds.FieldByName('EstacionID').AsInteger;
  MiFecha:=ds.FieldByName('Fecha').AsDateTime;
  if not ds.FieldByName('Existe').AsBoolean then
  begin
    Result:='la liquidacin no existe.';
    ds.Close;
    Exit;
  end;

  if ds.FieldByName('Cerrada').AsBoolean then
  begin
    Result:='La liquidacin ya est cerrada.';
    ds.Close;
    Exit;
  end;

  if ds.FieldByName('Despachador').AsInteger > 0 then
  begin
    Result:='Debe seleccionar un despachador.';
    ds.Close;
    Exit;
  end;

  dsFaltantes:=Schema.NewDataset(Connection, 'spDiferenciasLiquidacion');
  dsFaltantes.ParamByName('LiquidacionID').AsInteger:=LiquidacionID;
  dsFaltantes.Open;
  cmdFyP:=Schema.NewCommand(Connection, 'Insert_dbo FaltanteyPago');
  cmdDetLiq:=Schema.NewCommand(Connection, 'Insert_dbo DetalleLiquidacion2');

  while not dsFaltantes.Eof do
  begin
    cmdFyP.ParamByName('FaltanteyPagoID').AsInteger:=Folio('FaltanteyPago', '');
    cmdFyP.ParamByName('Fecha').AsDateTime:=MiFecha;
    cmdFyP.ParamByName('Cargo').AsInteger:=0;
    cmdFyP.ParamByName('Abono').AsInteger:=0;
    cmdFyP.ParamByName('LiquidacionID').AsInteger:=LiquidacionID;
    cmdFyP.ParamByName('Descripcion').AsString:=Format('DIFERENCIA EN LIQUIDACION [%d-%d]', [MiEstacionID, dsFaltantes.FieldByName('TurnoID').AsInteger]);
    cmdFyP.ParamByName('EmpleadoID').AsInteger:=dsFaltantes.FieldByName('DespachadorID').AsInteger;
    cmdDetLiq.ParamByName('DetalleLiquidacionID').AsInteger:=Folio('LiquidacionDetalleID', '');
    cmdDetLiq.ParamByName('DespachadorLiquidacionID').AsInteger:=dsFaltantes.FieldByName('DespachadorLiquidacionID').AsInteger;
    cmdDetLiq.ParamByName('Cantidad').AsInteger:=1;
    cmdDetLiq.ParamByName('Ticket').AsInteger:=0;
    cmdDetLiq.ParamByName('CuponID').AsInteger:=0;
    cmdDetLiq.ParamByName('SalidaID').AsInteger:=0;
    cmdDetLiq.ParamByName('ClienteID').AsInteger:=0;
    cmdDetLiq.ParamByName('BancoID').AsInteger:=0;
    cmdDetLiq.ParamByName('ProductoID').AsInteger:=0;
    cmdDetLiq.ParamByName('AuxiliarID').AsInteger:=0;
    cmdDetLiq.ParamByName('VehiculoID').AsInteger:=0;
    cmdDetLiq.ParamByName('GasolineroID').AsInteger:=0;
    cmdDetLiq.ParamByName('Costo').AsFloat:=0;
    cmdDetLiq.ParamByName('Puntos').AsInteger:=0;
    cmdDetLiq.ParamByName('Facturado').AsBoolean:=False;
    cmdDetLiq.ParamByName('Importe').AsFloat:=Abs(Decimales(dsFaltantes.FieldByName('Diferencia').AsFloat, 2));

    if dsFaltantes.FieldByName('Diferencia').AsFloat < 0 then
    begin
      cmdDetLiq.ParamByName('TipoValorID').AsInteger:=15;
      cmdDetLiq.ParamByName('Referencia').AsString:=Format('FALTANTE EN LIQUIDACION [%d]', [dsFaltantes.FieldByName('TurnoID').AsInteger]);
      cmdFyP.ParamByName('Cargo').AsFloat:=Abs(Decimales(dsFaltantes.FieldByName('Diferencia').AsFloat, 2));
      cmdFyP.ParamByName('TipoFaltantePagoID').AsInteger:=1;
      cmdFyP.Execute;
    end
    else
    begin
      cmdDetLiq.ParamByName('TipoValorID').AsInteger:=16;
      cmdDetLiq.ParamByName('Referencia').AsString:=Format('SOBRANTE EN LIQUIDACION [%d]', [dsFaltantes.FieldByName('TurnoID').AsInteger]);
      cmdFyP.ParamByName('Abono').AsFloat:=Abs(Decimales(dsFaltantes.FieldByName('Diferencia').AsFloat, 2));
      cmdFyP.ParamByName('TipoFaltantePagoID').AsInteger:=2;
      if ServerDataModule.AplicaSobrantes then
        cmdFyP.Execute;
    end;
    cmdDetLiq.Execute;
    dsFaltantes.Next;
  end;
  dsFaltantes.Close;
  cmdCierra:=Schema.NewCommand(Connection, 'CierraLiquidacion');
  cmdCierra.ParamByName('LiquidacionID').AsInteger:=LiquidacionID;
  cmdCierra.Execute;
end;

procedure TServiceValesCupones.CierraTurno(const BombaID, TurnoID: Integer;
  const FinLecturas: aLecturas);
var
  cmd: IDASQLCommand;
  ds: IDADataset;
  dsMangueras: IDADataset;
  MiFecha: TDateTime;
  I, Manguera: Integer;
begin
  MiFecha:=Now;
  cmd:=Schema.NewCommand(Connection, 'CierraTurno');
  ds:=Schema.NewDataset(Connection, 'DatosTurno');
  ds.ParamByName('BombaID').AsInteger:=BombaID;
  ds.ParamByName('TurnoID').AsInteger:=TurnoID;
  ds.Open;

  dsMangueras:=Schema.NewDataset(Connection, 'BombasTurno');
  dsMangueras.ParamByName('BombaID').AsInteger:=BombaID;
  dsMangueras.ParamByName('TurnoID').AsInteger:=TurnoID;
  dsMangueras.Open;
  Global.Bombas[BombaID].VentasTurno.Clear;
  for I := 0 to 4 do
    Global.Bombas[BombaID].VentasTurno.Add;

  while not dsMangueras.EOF do
  begin
    Manguera:=dsMangueras.FieldByName('MangueraID').AsInteger;
    cmd.ParamByName('BombaID').AsInteger:=BombaID;
    cmd.ParamByName('TurnoID').AsInteger:=TurnoID;
    cmd.ParamByName('MangueraID').AsInteger:=Manguera;
    cmd.ParamByName('FechaFinal').AsDateTime:=MiFecha;
    cmd.ParamByName('LecturaFinalImporte').AsString:=FormatFloat('#0.00', FinLecturas[Manguera].CashMoney);
    cmd.ParamByName('LecturaFinalVolumen').AsString:=FormatFloat('#0.000', FinLecturas[Manguera].CashVolume);
    cmd.ParamByName('Precio').AsString:=FormatFloat('#0.00', Global.Gasolinas[Global.Bombas[BombaID].Mangueras[Manguera].NoGasolina].Precio);
    if ds.Locate('MangueraID', Manguera, []) then
    begin
      cmd.ParamByName('Volumen').AsString:=FormatFloat('#0.000', ds.FieldByName('Volumen').AsFloat);
      cmd.ParamByName('Importe').AsString:=FormatFloat('#0.00', ds.FieldByName('Importe').AsFloat);
    end
    else
    begin
      cmd.ParamByName('Volumen').AsInteger:=0;
      cmd.ParamByName('Importe').AsInteger:=0;
    end;
    Global.Bombas[BombaID].VentasTurno[Global.Bombas[BombaID].Mangueras[Manguera].NoGasolina].Litros:=cmd.ParamByName('Volumen').AsFloat;
    Global.Bombas[BombaID].VentasTurno[Global.Bombas[BombaID].Mangueras[Manguera].NoGasolina].Importe:=cmd.ParamByName('Importe').AsFloat;
    Global.Bombas[BombaID].VentasTurno[Global.Bombas[BombaID].Mangueras[Manguera].NoGasolina].Precio:=cmd.ParamByName('Precio').AsFloat;

    cmd.Execute;
    dsMangueras.Next;
  end;
  ds.Close;
  dsMangueras.Close;
  CreaTurno(BombaID, TurnoID + 1, FinLecturas);
end;

function TServiceValesCupones.ClienteValido(
  const ClienteID: Integer; const NewClienteID: Integer): Boolean;
var
  ds: IDADataSet;
begin
  ds:=Schema.NewDataset(Connection, 'spClienteValido');
  ds.ParamByName('ClienteID').AsInteger:=ClienteID;
  ds.ParamByName('NewClienteID').AsInteger:=NewClienteID;
  ds.Open;
  Result:=ds.FieldByName('Total').AsInteger = 0;
end;

function TServiceValesCupones.CostoProducto(
  const ProductoID: Integer): Double;
var
  ds: IDADataSet;
begin
  ds:=Schema.NewDataset(Connection, 'spCostoProducto');
  ds.ParamByName('ProductoID').AsInteger:=ProductoID;
  ds.Open;
  Result:=ds.FieldByName('Costo').AsFloat;
  ds.Close;
end;

procedure TServiceValesCupones.CreaTurno(const BombaID, TurnoID: Integer;
  const InicioLecturas: aLecturas);
var
  cmd: IDASQLCommand;
  I: Integer;
  MiFecha: TDateTime;
begin
  cmd:=Schema.NewCommand(Connection, 'CreaTurno');
  MiFecha:=Now;
  for I := 1 to 4 do
  begin
    if Global.Bombas[BombaID].Mangueras[I].NoGasolina > 0 then
    begin
      cmd.ParamByName('BombaID').AsInteger:=BombaID;
      cmd.ParamByName('MangueraID').AsInteger:=I;
      cmd.ParamByName('TurnoID').AsInteger:=TurnoID;
      cmd.ParamByName('ProductoID').AsInteger:=Global.Bombas[BombaID].Mangueras[I].NoGasolina;
      cmd.ParamByName('FechaInicio').AsDateTime:=MiFecha;
      cmd.ParamByName('LecturaInicialImporte').AsString:=FormatFloat('#0.00', InicioLecturas[I].CashMoney);
      cmd.ParamByName('LecturaInicialVolumen').AsString:=FormatFloat('#0.000', InicioLecturas[I].CashVolume);
      cmd.Execute;
      Global.Bombas[BombaID].TurnoID:=TurnoID;
    end;
  end;
end;

procedure TServiceValesCupones.DataAbstractServiceCreate(Sender: TObject);
begin
   CoInitialize (nil);
end;

function TServiceValesCupones.Datos: TGlobal;
begin
  Result:=TGlobal.Create;
  Result.Assign(Global);
end;

function TServiceValesCupones.DatosCerrarLiquidacion(const EstacionID,
  TurnoID: Integer): TDatosCerrarLiquidacion;
var
  ds, dsD, dsT: IDADataset;
begin
  Result:=TDatosCerrarLiquidacion.Create;
  Result.Despachadores:=ADespachadorLiquidacion.Create;
  Result.TipoValor:=ATipoValor.Create;
  Result.EstacionID:=EstacionID;
  Result.TurnoID:=TurnoID;
  ds:=Schema.NewDataset(Connection, 'spDatosLiquidacion');
  ds.ParamByName('EstacionID').AsInteger:=EstacionID;
  ds.ParamByName('TurnoID').AsInteger:=TurnoID;
  ds.Open;
  Result.LiquidacionID:=ds.FieldByName('LiquidacionID').AsInteger;
  Result.VentasTotales:=ds.FieldByName('VentasTotales').AsFloat;
  Result.Entregado:=ds.FieldByName('Entregado').AsFloat;
  Result.Diferencia:=ds.FieldByName('Diferencia').AsFloat;
  ds.Close;
  dsD:=Schema.NewDataset(Connection, 'LIQDespachadorLiquidacion2');
  dsD.ParamByName('LiquidacionID').AsInteger:=Result.LiquidacionID;
  dsD.Open;
  while not dsD.EOF do
  begin
    with Result.Despachadores.Add do
    begin
      DespachadorLiquidacionID:=dsD.FieldByName('DespachadorLiquidacionID').AsInteger;
      DespachadorID:=dsD.FieldByName('DespachadorID').AsInteger;
      Importe:=dsD.FieldByName('Importe').AsFloat;
      Entregado:=dsD.FieldByName('Entregado').AsFloat;
      Diferencia:=dsD.FieldByName('Diferencia').AsFloat;
      AgrupacionID:=dsD.FieldByName('AgrupacionID').AsInteger;
    end;
    dsD.Next;
  end;
  dsD.Close;
  dsT:=Schema.NewDataset(Connection, 'LIQTipoValor2');
  dsT.Open;
  while not dsT.EOF do
  begin
    with Result.TipoValor.Add do
    begin
      TipoValorID:=dsT.FieldByName('TipoValorID').AsInteger;
      Nombre:=dsT.FieldByName('Nombre').AsString;
      Grupo:=dsT.FieldByName('Grupo').AsString;
    end;
    dsT.Next;
  end;
  dsT.Close;
end;

function TServiceValesCupones.DatosCliente(const ClienteID: Integer;
  const Referencia: AnsiString): TDatosCliente;
var
  cds, ds: IDADataset;
  EstacionID: Integer;
begin
  Result := TDatosCliente.Create;
  try
    try
      ds := Schema.NewDataset(Connection, 'UltimoConsumoExpressCliente');
      ds.ParamByName('ClienteID').AsInteger := ClienteID;
      ds.Open;
      EstacionID := ds.FieldByName('EstacionID').AsInteger;
    finally
      ds.Close;
    end;

    cds := Schema.NewDataset(Connection, 'DatosCliente');
    cds.ParamByName('ClienteID').AsInteger := ClienteID;
    cds.ParamByName('Referencia').AsString := Referencia;
    cds.Open;

    Result.ClienteID := cds.FieldByName('ClienteID').AsInteger;
    Result.Nombre := cds.FieldByName('Nombre').AsString;
    Result.RFC := cds.FieldByName('RFC').AsString;
    Result.Direccion := cds.FieldByName('Calle').AsString;
    Result.Telefono := cds.FieldByName('Telefono').AsString;
    Result.CP := cds.FieldByName('CodigoPostal').AsString;
    Result.Ciudad := cds.FieldByName('Ciudad').AsString;
    Result.Colonia := cds.FieldByName('Colonia').AsString;
    Result.FacturaExpress := cds.FieldByName('FacturaExpress').AsBoolean;
    Result.Saldo := PuntosCalculaSaldo(Result.ClienteID);
    Result.Telefonos := cds.FieldByName('Telefonos').AsString;
    Result.MsnError := PremioPuntos(EstacionID, Result.Saldo);
  finally
    cds.Close;
  end;
end;

function TServiceValesCupones.DatosFactura(const Folio: Integer;
  const Serie: AnsiString): Boolean;
var
  DataSet : IDADataSet;
begin
  Result:=false;
  DataSet := Schema.NewDataset(Connection, 'ObtenDatosFactura');
  DataSet.Close;
  DataSet.ParamByName('Folio').AsInteger := Folio;
  DataSet.ParamByName('Serie').AsString := Serie;
  DataSet.Open;

  if DataSet.EOF then Result := true;

end;

function TServiceValesCupones.DatosFacturaElectronica(const FacturaID,
  EstacionID: Integer): TFacturaElectronica;
var
  ds1: IDADataSet;
  ds2: IDADataSet;
  ds3: IDADataSet;
  ds4: IDADataSet;
  ds5: IDADataSet;

  TOTImpuestos: Double;
begin
  /////
  Result:=TFacturaElectronica.Create;

  TOTImpuestos:=0;

  ds1:=Schema.NewDataset(Connection, 'spDatosCadena');
  ds1.ParamByName('FacturaID').AsInteger:=FacturaID;
  ds1.ParamByName('EstacionID').AsInteger:=EstacionID;
  ds1.Open;

  ds5:=Schema.NewDataset(Connection, 'spDatosCadenaExpedidoEn');
  ds5.ParamByName('EstacionID').AsInteger:= EstacionID;
  ds5.Open;

  while not (ds1.EOF) do
  begin

    if not(ds5.EOF) then
    begin
      Result.CalleExpedidoEn:= ds5.FieldByName('Domicilio').AsString;
      Result.NoExterioExpedidoEn:= ds5.FieldByName('NoExterior').AsString;
      Result.ColoniaExpedidoEn:= ds5.FieldByName('Colonia').AsString;
      Result.CodigoPostalExpedidoEn:= ds5.FieldByName('CodigoPostal').AsString;
      Result.LocalidadExpedidoEn:= ds5.FieldByName('Localidad').AsString;
      Result.MunicipioExpedidoEn:= ds5.FieldByName('Municipio').AsString;
      Result.EstadoExpedidoEn:= ds5.FieldByName('Estado').AsString;
      Result.PaisExpedidoEn:= ds5.FieldByName('Pais').AsString;
      Result.Sucursal:= True;
    end else Result.Sucursal:= False;


    Result.Serie:= ds1.FieldByName('SERIE').AsString;
    Result.Folio:= ds1.FieldByName('FOLIO').AsString;
    Result.Fecha:= ds1.FieldByName('FECHA').AsString;
    Result.noAprobacion:= ds1.FieldByName('NOAPROBACION').AsString;
    Result.anoAprobacion:= ds1.FieldByName('ANOAPROBACION').AsString;
    Result.tipoComprobante:= ds1.FieldByName('FORMAPAGO').AsString;
    Result.formaDePago:= 'pago en una sola exhibicion';
    Result.SubTotal:= ds1.FieldByName('SUBTOTAL').AsString;
    Result.Total:= ds1.FieldByName('TOTAL').AsString;
    Result.RFCEmisor:= ds1.FieldByName('RFCEMISOR').AsString;
    Result.NOMEmpEmisor:= ds1.FieldByName('NOMEMPRESAEMISOR').AsString;
    Result.DireccionEm:= ds1.FieldByName('DOMEMISOR').AsString;
    Result.NOExteriorEM:= ds1.FieldByName('NOEXTERIOREMISOR').AsString;
    Result.ColoniaEmisor:= ds1.FieldByName('COLONIAEMISOR').AsString;
    Result.MunicipioEmisor:= ds1.FieldByName('MUNICIPIOEMISOR').AsString;
    Result.EstadoEmisor:= ds1.FieldByName('ESTADOEMISOR').AsString;
    Result.PaisEmisor:= ds1.FieldByName('PAISEMISOR').AsString;
    Result.CodigoPostalEmisor:= ds1.FieldByName('CODIGOPOSTALEMISOR').AsString;

    Result.RFCReceptor:= ds1.FieldByName('RFCRECEPTOR').AsString;
    Result.NombreReceptor:= ds1.FieldByName('NOMBREEMPRECEPTOR').AsString;
    Result.DomicilioReceptor:= ds1.FieldByName('DOMICILIORECEPTOR').AsString;
    Result.NoExteriorReceptor:= ds1.FieldByName('NOEXTERIORRECEPTOR').AsString;
    Result.ColoniaReceptor:= ds1.FieldByName('COLONIARECEPTOR').AsString;
    Result.LocalidadReceptor:= ds1.FieldByName('LOCALIDADRECEPTOR').AsString;
    Result.MunicipioReceptor:= ds1.FieldByName('MUNICIPIORECEPTOR').AsString;
    Result.EstadoReceptor:= ds1.FieldByName('ESTADORECEPTOR').AsString;
    Result.PaisReceptor:= ds1.FieldByName('PAISRECEPTOR').AsString;
    Result.CodigoPostalReceptor:= ds1.FieldByName('CODIGOPOSTALRECEPTOR').AsString;
    Result.email:= ds1.FieldByName('email').AsString;
    ds1.Next;
  end;

  ds2:=Schema.NewDataset(Connection, 'spDatosCadenaImportes');
  ds2.ParamByName('FacturaID').AsInteger:=FacturaID;
  ds2.Open;

  while not (ds2.EOF) do
  begin
    With Result.FacturaElectronicaDetalleImportes.Add do begin
      if ds2.FieldByName('ProductoID').AsInteger <= 3 then
         UnidadReceptor:= 'LTS'
      else
         UnidadReceptor:= 'UNI';

      CantidadReceptor:= ds2.FieldByName('CANTIDAD').AsString;
      DescripcionReceptor:= ds2.FieldByName('NOMBRE').AsString;
      ValorUnitarioReceptor:= ds2.FieldByName('PRECIO').AsString;
      ImporteReceptor:= ds2.FieldByName('IMPORTE').AsString;
    end;
    ds2.Next;
  end;

      ds3:=Schema.NewDataset(Connection, 'spDatosCadenaImpuestosIEPS');
      ds3.ParamByName('FacturaID').AsInteger:=FacturaID;
      ds3.Open;

      ds4:=Schema.NewDataset(Connection, 'spDatosCadenaImpuestosIVA');
      ds4.ParamByName('FacturaID').AsInteger:=FacturaID;
      ds4.Open;

      while not (ds3.EOF) do
      begin
        if ds3.FieldByName('IEPS').AsFloat <> 0 then
        begin
           With Result.FacturaElectronicaDetalleImpuestos.Add do
           begin
                ImporteImpReceptor:= ds3.FieldByName('IEPS').AsString;
                TasaReceptor:= ds3.FieldByName('TASAIEPS').AsString;
                ImpuestoReceptor:= 'IEPS';
                TOTImpuestos:= TOTImpuestos + ds3.FieldByName('IEPS').AsFloat;
                ds3.Next;
           end;
        end else ds3.Next;
      end;

      while not (ds4.EOF) do
      begin
        if ds4.FieldByName('IVA').AsFloat <> 0 then
        begin
           With Result.FacturaElectronicaDetalleImpuestos.Add do
           begin
                ImporteImpReceptor:= ds4.FieldByName('IVA').AsString;
                TasaReceptor:= ds4.FieldByName('TASAIVA').AsString;
                ImpuestoReceptor:= 'IVA';
                TOTImpuestos:= TOTImpuestos + ds4.FieldByName('IVA').AsFloat;
               ds4.Next;
           end;
        end else ds4.Next;
      end;

  Result.TotalImpuesto:= FloatToStr(TOTImpuestos);
end;

function TServiceValesCupones.DatosPremio(
  const PremioID: Integer): TDatosPremio;
var
  ds: IDADataset;
begin
  Result := TDatosPremio.Create;
  Result.PremioID := 0;
  try
    ds := Schema.NewDataset(Connection, 'spDatosPremio');
    ds.ParamByName('PremioID').AsInteger := PremioID;
    ds.Open;
    if not ds.IsEmpty then
    begin
      Result.PremioID := ds.FieldByName('PremioID').AsInteger;
      Result.Nombre := ds.FieldByName('Nombre').AsString;
      Result.Puntos := ds.FieldByName('Puntos').AsFloat;
    end;
  finally
    ds.Close;
  end;
end;

function TServiceValesCupones.DatosVehiculo(
  const VehiculoID: Integer): TDatosVehiculo;
var
  MiDs: IDADataSet;
begin
  Result:=TDatosVehiculo.Create;
  Result.ClienteID:=0;
  MiDs:=Schema.NewDataset(Connection, 'DatosVehiculo');
  MiDs.ParamByName('VehiculoID').AsInteger:=VehiculoID;
  MiDs.Open;
  if not MiDs.IsEmpty then
  begin
    Result.ClienteID:=MiDs.FieldByName('ClienteID').AsInteger;
    Result.VehiculoID:=MiDs.FieldByName('VehiculoID').AsInteger;
    Result.ClienteNombre:=MiDs.FieldByName('Nombre').AsString;
    Result.Referencia:=MiDs.FieldByName('Referencia').AsString;
  end;
  MiDs.Close;
end;

function TServiceValesCupones.DatosVerifica(
  const VehiculoID: Integer): TDatosVerifica;
var
  ds: IDADataset;
begin
  Result:=TDatosVerifica.Create;
  ds:=Schema.NewDataset(Connection, 'spDatosVerifica');
  ds.ParamByName('VehiculoID').AsInteger:=VehiculoID;
  ds.Open;
  Result.AfectarHistorico:=ds.FieldByName('AfectarHistorico').AsBoolean;
  Result.KMS:=ds.FieldByName('KMS').AsInteger;
  ds.Close;
end;

function TServiceValesCupones.DatosVerificaReferencia(
  const Referencia: AnsiString): TDatosVerifica;
var
  ds: IDADataset;
begin
  Result:=TDatosVerifica.Create;
  ds:=Schema.NewDataset(Connection, 'spDatosVerificaReferencia');
  ds.ParamByName('Referencia').AsString:=Referencia;
  ds.Open;
  Result.AfectarHistorico:=ds.FieldByName('AfectarHistorico').AsBoolean;
  Result.KMS:=ds.FieldByName('KMS').AsInteger;
  ds.Close;
end;


function TServiceValesCupones.ValidaConsumo(
  const Consumo: TConsumoExpress): Integer;
var
  ds: IDADataset;
begin
  Result:=1;
  ds:=Schema.NewDataset(Connection, 'spValidaConsumo');
  ds.ParamByName('Secuencia').AsInteger:=Consumo.Secuencia;
  ds.ParamByName('EstacionID').AsInteger:=Consumo.EstacionID;
  ds.Open;
  if ds.IsEmpty then
    Result:=0;
  ds.Close;
end;

function TServiceValesCupones.ValidaFolioFactura(const Serie: Ansistring;
  const Folio: Integer): Boolean;
var
  ds: IDADataset;
begin
  ds:=Schema.NewDataset(Connection, 'spValidaFolioFactura');
  ds.ParamByName('Serie').AsString:=Serie;
  ds.ParamByName('Folio').AsInteger:=Folio;
  ds.Open;
  Result:=ds.IsEmpty;
  ds.Close;
end;

function TServiceValesCupones.ValidaLiquidacionDespachador(
  const LiquidacionID: Integer): AnsiString;
var
  ds: IDADataSet;
begin
  Result:='OK';
  ds:=Schema.NewDataset(Connection, 'spValidaLiquidacionDespachador');
  ds.ParamByName('LiquidacionID').AsInteger:=LiquidacionID;
  ds.Open;

  if ds.FieldByName('Liquidacion').AsInteger > 0 then
  begin

    if ds.FieldByName('Despachador').AsInteger > 0 then
    begin
      Result:='Debe seleccionar un despachador.';
      ds.Close;
      Exit;
    end;

  end Else Result:= 'NO LIQ';
end;

procedure TServiceValesCupones.ValidaSecuencias(const TurnoID: Integer);
var
  ds, dsGasolinero: IDADataSet;
  Arreglo: TStrings;
  Host: String;
  Aux: Integer;
begin
  dsGasolinero:=Schema.NewDataSet(Connection, 'SecuenciasGasolinero');
  dsGasolinero.ParamByName('TurnoID').AsInteger:=TurnoID;
  dsGasolinero.Open;
  while not dsGasolinero.EOF do
  begin
    Aux:=0;
    if IsNumeric(dsGasolinero.FieldByName('GasolineroID').AsString) then
      Aux:=dsGasolinero.FieldByName('GasolineroID').AsInteger;
    ds:=Schema.NewDataset(Connection, 'SecuenciasTarjetasCupones');
    ds.ParamByName('TurnoID').AsInteger:=TurnoID;
    ds.ParamByName('GasolineroID').AsInteger:=Aux;
    ds.Open;
    Host:=Flotillas.BuscaHost(1, Aux);
    Arreglo:=TStringList.Create;
    try
      while not ds.EOF do
      begin
        Arreglo.Add(ds.FieldByName('TramaID').AsString);
        ds.Next;
      end;
      if Arreglo.Count > 0 then
      begin
        Arreglo.Text:=Flotillas.ValidaSecuencias(Aux, Estacion, Arreglo.Text);
        if Arreglo.Count > 0 then
        begin
          //Envia Consumos
          EnviaTramas(Arreglo.Text, Host, Aux);
        end;
      end;
    finally
      Arreglo.Free;
    end;
    ds.Close;
    dsGasolinero.Next;
  end;
  dsGasolinero.Close;
end;

function TServiceValesCupones.ValidaSecuenciasC(const EstacionID: Integer;
  const Secuencias: AnsiString): AnsiString;
var
  Arreglo: TStrings;
  I : Integer;
  S: String;
  ds: IDADataset;
begin
  Arreglo:=TStringList.Create;
  try
    Arreglo.Text:=Secuencias;
    if Arreglo.Count > 0 then
    begin
      S:='';
      for I := 0 to Arreglo.Count - 1 do
        S:= S + Arreglo[I] + ',';
      Delete(S, Length(S), 1);
      S:=Format('Select SecuenciaVenta from consumo where EstacionID = %d and and Serie = ''C'' SecuenciaVenta in (%s)', [EstacionID, S]);
      ds:=Connection.NewDataset(S, 'ValidaSecuencias');
      ds.Open;
      while not ds.EOF do
      begin
        I:=Arreglo.IndexOf(ds.FieldByName('SecuenciaVenta').AsString);
        if I >= 0 then
          Arreglo.Delete(I);
        ds.Next;
      end;
      ds.Close;
      Result:=Arreglo.Text;
    end;
  finally
    Arreglo.Free;
  end;
end;

function TServiceValesCupones.ValoresTurno(const EstacionID,
  TurnoID: Integer): TValoresTurno;
var
  ds: IDADataset;
begin
  Result:=TValoresTurno.Create;
  ds:=Schema.NewDataset(Connection, 'spValoresTurno');
  ds.ParamByName('EstacionID').AsInteger:=EstacionID;
  ds.ParamByName('TurnoID').AsInteger:=TurnoID;
  ds.Open;
  Result.Fecha:=ds.FieldByName('Fecha').AsDateTime;
  Result.Venta:=ds.FieldByName('Venta').AsFloat;
  Result.Efectivo:=ds.FieldByName('Efectivo').AsFloat;
  Result.Credito:=ds.FieldByName('Credito').AsFloat;
  Result.Calibraciones:=ds.FieldByName('Calibraciones').AsFloat;
  Result.ConsumoInterno:=ds.FieldByName('ConsumoInterno').AsFloat;
  Result.Faltantes:=ds.FieldByName('Faltantes').AsFloat;
  Result.Sobrantes:=ds.FieldByName('Sobrantes').AsFloat;
  ds.Close;
end;

procedure TServiceValesCupones.dbpLiquidacionBeforeProcessDelta(
  Sender: TDABusinessProcessor; const aDelta: IDADelta);
begin
  Exit;
end;

function TServiceValesCupones.DocumentosConSaldo(
  const ClienteID: Integer): TDocumentosConSaldoArray;
var
  MiDataSet: IDADataset;
begin
  Result:=TDocumentosConSaldoArray.Create;
  MiDataSet:=Schema.NewDataset(Connection, 'spSaldoDocumento');
  //MiDataSet.ParamByName('Identificador').AsInteger:=Identificador;
  MiDataSet.ParamByName('ClienteID').AsInteger:=ClienteID;
  MiDataSet.Open;
  while not MiDataSet.EOF do
  begin
    with Result.Add do
    begin
      Importe:=MiDataSet.FieldByName('Importe').AsFloat;
      Saldo:=MiDataSet.FieldByName('Saldo').AsFloat;
      Fecha:=MiDataSet.FieldByName('Fecha').AsDateTime;
      Vencimiento:=MiDataSet.FieldByName('Vencimiento').AsDateTime;
      MovimientoID:=MiDataSet.FieldByName('MovimientoID').AsInteger;
      Referencia:=Format('Movimiento:[%s] Saldo:[%s] Vencimiento[%s]', [MiDataSet.FieldbyName('Referencia').AsString,
                                                                        FormatFloat('$#,0.00', Saldo),
                                                                        FormatDateTime('dd/mmm/yyyy', Vencimiento)]);
    end;    // with
    MiDataSet.Next;
  end;    // while
  MiDataSet.Close;
end;

function TServiceValesCupones.EliminaAutomaticosLiquidacion(const EstacionID,
  TurnoID: Integer): Boolean;
var
  cmd: IDASQLCommand;
begin
  Result:=True;
  cmd:=Schema.NewCommand(Connection, 'spEliminaAutomaticosLiquidacion');
  cmd.ParamByName('EstacionID').AsInteger:=EstacionID;
  cmd.ParamByName('TurnoID').AsInteger:=TurnoID;
  cmd.Execute;
end;

function TServiceValesCupones.EliminaAutorizacionVehiculo(
  const Referencia: AnsiString): Boolean;
var
  cmd: IDASQLCommand;
begin
  Result:=False;
  try
    //cmd:=Schema.NewCommand(Connection, 'spAutorizacionEliminarTarjeta');
    cmd:=Schema.NewCommand(Connection, 'spEliminaAutorizacion');
    cmd.ParamByName('Barras').AsString:= Referencia;
    {cmd.ParamByName('ClienteID').AsInteger:= ClienteID;
    cmd.ParamByName('VehiculoID').AsInteger:= VehiculoID;
    cmd.ParamByName('GasolineroID').AsInteger:= GasolineroID;}
    cmd.Execute;
    Result:=True;
  except
  end;
end;

function TServiceValesCupones.EliminaFactura(const Folio: Integer;
  const Serie: AnsiString): Boolean;
var
  ds: IDADataset;
begin
  Result:= False;
  try
    ds:= Schema.NewDataset(Connection, 'spEliminaFactura');
    ds.ParamByName('Folio').AsInteger:= Folio;
    ds.ParamByName('Serie').AsString:= Serie;
    ds.Open;
    Result:=ds.FieldByName('Resultado').AsBoolean;
    ds.Close;
  except
  end;
end;

procedure TServiceValesCupones.EntradaBitacora(const Descripcion: AnsiString;
  const Tipo: eTipoBitacora; const Alerta: Boolean);

var
  cmd: IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection, 'INSBitacora');
  cmd.ParamByName('BitacoraID').AsInteger:=Folio('BitacoraID', '');
  cmd.ParamByName('Descripcion').AsString:=Descripcion;
  case Tipo of
    eTipoBitacora_tbDispensarios: cmd.ParamByName('BitacoraTipoID').AsInteger:=3;
    eTipoBitacora_tbTanques: cmd.ParamByName('BitacoraTipoID').AsInteger:=4;
    eTipoBitacora_tbAccesos: cmd.ParamByName('BitacoraTipoID').AsInteger:=5;
    eTipoBitacora_tbJarreos: cmd.ParamByName('BitacoraTipoID').AsInteger:=6;
    eTipoBitacora_tbCapturas: cmd.ParamByName('BitacoraTipoID').AsInteger:=7;
    eTipoBitacora_tbConexiones: cmd.ParamByName('BitacoraTipoID').AsInteger:=8;
  else
    cmd.ParamByName('BitacoraTipoID').AsInteger:=1;
  end;
  cmd.ParamByName('EstacionID').AsInteger:=Estacion;
  cmd.ParamByName('Alerta').AsBoolean:=Alerta;
  cmd.ParamByName('Fecha').AsDateTime:=Fecha;
  cmd.Execute;
end;

function TServiceValesCupones.EntregaPremio(const ClienteID, PremioID,
  Cantidad: Integer): TEntregaPremio;
var
  ds: IDADataset;
  cmd: IDASQLCommand;
  Aux: TDatosCliente;
  Puntos: Double;
begin
  Result:=TEntregaPremio.Create;
  Result.Valido:=False;
  Aux:=TDatosCliente.Create;
  try
    ds:=Schema.NewDataset(Connection, 'spDatosPremio');
    ds.ParamByName('PremioID').AsInteger:=PremioID;
    ds.Open;
    if not ds.IsEmpty then
    begin
      Puntos:=Decimales(ds.FieldByName('Puntos').AsFloat * Cantidad, 2);
      Aux.Assign(DatosCliente(ClienteID, ''));
      if Aux.Saldo >= Puntos then
      begin
        Result.Premio:=ds.FieldByName('Nombre').AsString;
        cmd:=Schema.NewCommand(Connection, 'spInsertaPremio');
        cmd.ParamByName('ClienteID').AsInteger:=ClienteID;
        cmd.ParamByName('Descripcion').AsString:=Format('PREMIO [%s]', [Result.Premio]);
        cmd.ParamByName('Cargo').AsFloat:=Puntos;
        cmd.Execute;
        Result.Saldo:=Aux.Saldo - Puntos;
        Result.Valido:=True;
        Result.ClienteID:=ClienteID;
        Result.Cliente:=Aux.Nombre;
        Result.Cantidad:=Cantidad;
        Result.Puntos:=Puntos;
      end
      else
        Result.Mensaje:='EL SALDO NO ES SUFICIENTE PARA ENTREGAR EL PREMIO';
    end
    else
      Result.Mensaje:='PREMIO NO EXISTE';
    ds.Close;
  finally
    Aux.Free;
  end;
end;

procedure TServiceValesCupones.EnviaTramas(Tramas, Host: String;
  GasolineroID: Integer);
var
  Arreglo: TStrings;
  I: Integer;
  S: String;
  ds: IDADataSet;
  Aux: aRegistroVenta;
begin
  Arreglo:=TStringList.Create;
  Aux:=aRegistroVenta.Create;
  try
    Arreglo.Text:=Tramas;
    if Arreglo.Count > 0 then
    begin
      S:='';
      for I := 0 to Arreglo.Count - 1 do
        S:=S + Arreglo[I] + ',';
      Delete(S, Length(S), 1);
      S:=Format('SELECT TramaID, BombaID, EstacionID, FechaCarga, FechaContable, TurnoID, Odometro, Referencia, Volumen, Importe, Precio, ProductoID, Tipo, IEPS FROM Trama WHERE TramaID IN (%s)', [S]);
      ds:=Connection.NewDataset(S, 'Tramas');
      ds.Open;
      while not ds.EOF do
      begin
        with Aux.Add do
        begin
          Secuencia:=ds.FieldByName('TramaID').AsInteger;
          Bomba:=ds.FieldByName('BombaID').AsInteger;
          Estacion:=ds.FieldByName('EstacionID').AsInteger;
          FechaCarga:=ds.FieldByName('FechaCarga').AsDateTime;
          FechaContable:=ds.FieldByName('FechaContable').AsDateTime;
          Turno:=ds.FieldByName('TurnoID').AsInteger;
          Kms:=ds.FieldByName('Odometro').AsInteger;
          Tarjeta:=ds.FieldByName('Referencia').AsString;
          VolumenServido:=ds.FieldByName('Volumen').AsFloat;
          ImporteServido:=ds.FieldByName('Importe').AsFloat;
          PrecioServido:=ds.FieldByName('Precio').AsFloat;
          Impuesto:=15;
          CuentaContable:='';
          Codigo:=ds.FieldByName('ProductoID').AsString;
          Tipo:=ds.FieldByName('Tipo').AsInteger;
          VehiculoID:=StrToInt(Copy(ds.FieldByName('Referencia').AsString, 9, 8));
          ClienteID:=0;
          GasolineroID:=GasolineroID;
          IEPS:=ds.FieldByName('IEPS').AsFloat;
        end;
        ds.Next;
      end;
      if Aux.Count > 0 then
        Flotillas.Consumos(Aux, Host);
    end;
  finally
    Arreglo.Free;
    Aux.Free;
  end;
end;

procedure TServiceValesCupones.EstadoDispensario(const Dispensario: Integer;
  const Estado: AnsiString);
var
  ds: IDADataSet;
  cmd: IDASQLCommand;
  I: Integer;
  S: String;
begin
  ds:=Schema.NewDataset(Connection, 'UltimoEstadoDispensario');
  ds.ParamByName('Dispensario').AsInteger:=Dispensario;
  ds.Open;
  if ds.FieldByName('Estado').AsString <> Estado then
  begin
    S:='EN LINEA';
    if Estado = 'F' then
      S:='FUERA DE LINEA';
    S:=Format('El dispensario [%d] cambio su estado a %s', [Dispensario, S]);
    EntradaBitacora(S, eTipoBitacora_tbDispensarios, True);
    cmd:=Schema.NewCommand(Connection, 'INSV2ArchivoADI');
    for I := 1 to 4 do
    begin
      if Global.Bombas[Dispensario].Mangueras[I].NoGasolina > 0 then
      begin
        cmd.ParamByName('Dispensario').AsInteger:=Dispensario;
        cmd.ParamByName('Manguera').AsInteger:=Global.Bombas[Dispensario].Mangueras[I].NoGasolina;
        cmd.ParamByName('ProductoPemex').AsString:=Global.Gasolinas[Global.Bombas[Dispensario].Mangueras[I].NoGasolina].ClavePemex;
        cmd.ParamByName('Estado').AsString:=Estado;
        cmd.ParamByName('Fecha').AsDateTime:=Fecha;
        cmd.Execute;
      end;
    end;
  end;
end;

function TServiceValesCupones.Existencia(const EstacionID, AlmacenID,
  ProductoID: Integer; const Fecha: DateTime): Double;
var
  ds: IDADataSet;
begin
  ds:=Schema.NewDataset(Connection, 'ObtenerExistencia');
  ds.ParamByName('EstacionID').AsInteger:=EstacionID;
  ds.ParamByName('AlmacenID').AsInteger:=AlmacenID;
  ds.ParamByName('ProductoID').AsInteger:=ProductoID;
  ds.ParamByName('Fecha').AsDateTime:=Trunc(Fecha);
  ds.Open;
  Result:=ds.FieldByName('Existencia').AsFloat;
  ds.Close;
end;

function TServiceValesCupones.FacturaCupon(const Cliente: Integer;
  const Importe: Double; const EstacionID, EmpleadoID: Integer;
  const SerieFactura: AnsiString): Integer;
var
  Aux: TDetalleFactura;
  DatosFactura: TDatosFactura;
  ds: IDADataSet;

  Vencimiento: TDateTime;
begin
  ds:=Schema.NewDataset(Connection, 'DatosCliente');
  ds.ParamByName('ClienteID').AsInteger:=Cliente;
  ds.Open;

  if not ds.IsEmpty then
  begin
     Vencimiento:=  Trunc(Now) + ds.FieldByName('PlazoPago').AsInteger;
  end else Vencimiento:= Trunc(Now);

  Result:=Folio('Folio', SerieFactura);
  DatosFactura:=TDatosFactura.Create;
  ds:=Schema.NewDataset(Connection, 'IVAEstacion');
  ds.ParamByName('EstacionID').AsInteger:=EstacionID;
  ds.Open;

  DatosFactura.Factura.IVA:=ds.FieldByName('IVA').AsFloat;
  if DatosFactura.Factura.IVA = 0 then
    DatosFactura.Factura.IVA:=15;
  DatosFactura.Factura.FacturaID:=Folio('FacturaID','');
  DatosFactura.Factura.Serie :=SerieFactura;
  DatosFactura.Factura.Folio:=Result;
  DatosFactura.Factura.Fecha:=Trunc(Now);
  DatosFactura.Factura.FechaVencimiento:=Vencimiento;
  DatosFactura.Factura.FechaImpresion:= Trunc(Now);
  DatosFactura.Factura.Ejercicio:= strtoint(FormatDateTime('yyyy', Now));
  DatosFactura.Factura.Periodo:=strtoint(FormatDateTime('mm', Now));
  DatosFactura.Factura.Saldo:=0;
  DatosFactura.Factura.Tickets:='';
  DatosFactura.Factura.ClienteID:=Cliente;
  DatosFactura.Factura.UsuarioID:=EmpleadoID;
  DatosFactura.Factura.MovimientoID:=Folio('MovimientoID','');
  DatosFactura.Factura.Total:= Importe;
  DatosFactura.Factura.Subtotal:=Decimales(Importe / (1 + (DatosFactura.Factura.IVA / 100)), 2);
  DatosFactura.Factura.Impuesto:=Decimales(Importe - DatosFactura.Factura.Subtotal, 2);
  Aux:=DatosFactura.DetalleFactura.Add;
  Aux.Precio:=ds.FieldByName('Precio').AsFloat;
  Aux.Importe:=Importe;
  Aux.Cantidad:=Decimales(Aux.Importe/ Aux.Precio, 3);
  Aux.ProductoID:=1;
  Aux.DetalleFacturaID:=Folio('DetalleFacturaID', '');
  GuardaDatosFactura(DatosFactura);
end;

function TServiceValesCupones.FacturaExpress(const Serie: Ansistring;
  const Folio: Integer): TFacturaExpress;
var
  dsF: IDADataSet;
  dsD: IDADataSet;
begin
  Result:=TFacturaExpress.Create;
  Result.FacturaID:=0;
  dsF:=Schema.NewDataset(Connection, 'FacturaExpress');
  dsF.ParamByName('Serie').AsString:=Serie;
  dsF.ParamByName('Folio').AsInteger:=Folio;
  dsF.Open;
  if not dsF.IsEmpty then
  begin
    Result.FacturaID:=dsF.FieldbyName('FacturaID').AsInteger;
    Result.Folio:=dsF.FieldbyName('Folio').AsInteger;
    Result.Serie:=dsF.FieldbyName('Serie').AsString;
    Result.Fecha:=dsF.FieldbyName('Fecha').AsDateTime;
    Result.Subtotal:=dsF.FieldByName('SubTotal').AsFloat;
    Result.IVA:=dsF.FieldByName('Impuesto').AsFloat;
    Result.Total:=dsF.FieldByName('Total').AsFloat;
    Result.Impuesto:=dsF.FieldByName('ImpuestoPorcentaje').AsFloat;
    Result.Cliente.Assign(DatosCliente(dsF.FieldbyName('ClienteID').AsInteger, '@@@'));
    dsD:=Schema.NewDataset(Connection, 'FacturaExpressDetalle');
    dsD.ParamByName('FacturaID').AsInteger:=Result.FacturaID;
    dsD.Open;
    while not dsD.EOF do
    begin
      with Result.Detalle.Add do
      begin
        Codigo:=dsD.FieldByName('Codigo').AsString;
        Descripcion:=dsD.FieldByName('Nombre').AsString;
        Cantidad:=dsD.FieldByName('Cantidad').AsFloat;
        Precio:=dsD.FieldByName('Precio').AsFloat;
        Importe:=dsD.FieldByName('Importe').AsFloat;
      end;
      dsD.Next;
    end;
    dsD.Close;
  end;
  dsF.Close;
end;

function TServiceValesCupones.FacturaID(const Serie: AnsiString;
  const Folio: Integer): Integer;
var
  ds: IDADataset;
begin
  ds:=Schema.NewDataset(Connection, 'spFacturaID');
  ds.ParamByName('Serie').AsString:=Serie;
  ds.ParamByName('Folio').AsInteger:=Folio;
  ds.Open;
  Result:=ds.FieldByName('FacturaID').AsInteger;
end;

function TServiceValesCupones.FacturaRecibo(const Cliente: Integer;
  const Importe: Double; const EstacionID, EmpleadoID: Integer;
  const SerieFactura: AnsiString; const ProductoID: Integer): Integer;
var
  Aux: TDetalleFactura;
  DatosFactura: TDatosFactura;
  ds: IDADataSet;
begin
  Result:=Folio('Folio', SerieFactura);
  DatosFactura:=TDatosFactura.Create;
  ds:=Schema.NewDataset(Connection, 'IVAEstacion');
  ds.ParamByName('EstacionID').AsInteger:=EstacionID;
  ds.ParamByName('ProductoID').AsInteger:=ProductoID;
  ds.Open;
  DatosFactura.Factura.IVA:=ds.FieldByName('IVA').AsFloat;
  if DatosFactura.Factura.IVA = 0 then
    DatosFactura.Factura.IVA:=15;
  DatosFactura.Factura.FacturaID:=Folio('FacturaID','');
  DatosFactura.Factura.Serie :=SerieFactura;
  DatosFactura.Factura.Folio:=Result;
  DatosFactura.Factura.Fecha:=Trunc(Now);
  DatosFactura.Factura.FechaVencimiento:=Trunc(Now);
  DatosFactura.Factura.FechaImpresion:= Trunc(Now);
  DatosFactura.Factura.Ejercicio:= strtoint(FormatDateTime('yyyy', Now));
  DatosFactura.Factura.Periodo:=strtoint(FormatDateTime('mm', Now));
  DatosFactura.Factura.Saldo:=0;
  DatosFactura.Factura.Tickets:='';
  DatosFactura.Factura.ClienteID:=Cliente;
  DatosFactura.Factura.UsuarioID:=EmpleadoID;
  DatosFactura.Factura.MovimientoID:=Folio('MovimientoID','');
  DatosFactura.Factura.Total:= Importe;
  DatosFactura.Factura.Subtotal:=Decimales(Importe / (1 + (DatosFactura.Factura.IVA / 100)), 2);
  DatosFactura.Factura.Impuesto:=Decimales(Importe - DatosFactura.Factura.Subtotal, 2);
  Aux:=DatosFactura.DetalleFactura.Add;
  Aux.Precio:=ds.FieldByName('Precio').AsFloat;
  Aux.Importe:=Importe;
  Aux.Cantidad:=Decimales(Aux.Importe/ Aux.Precio, 3);
  Aux.ProductoID:=ProductoID;
  Aux.DetalleFacturaID:=Folio('DetalleFacturaID', '');
  GuardaDatosFactura(DatosFactura);
end;

function TServiceValesCupones.FacturaYLiquidacion(
  const ClienteID: Integer): Boolean;
var
  ds: IDADataset;
begin
  ds:=Schema.NewDataset(Connection, 'spFacturayLiquidacion');
  ds.ParamByName('ClienteID').AsInteger:=ClienteID;
  ds.Open;
  Result:=ds.FieldByName('FacturayLiquidacion').AsBoolean;
  ds.Close;
end;

function TServiceValesCupones.Fecha: DateTime;
begin
  Result:=Now;
end;

function TServiceValesCupones.Folio(const Campo, Serie: AnsiString): Integer;
var
  ds: IDADataSet;
begin
  ds:=Schema.NewDataset(Connection, 'spFolio');
  ds.ParamByName('Campo').AsString:=Campo;
  ds.ParamByName('Serie').AsString:=Serie;
  ds.Open;
  Result:=ds.FieldByName('Folio').AsInteger;
  ds.Close;
end;

function TServiceValesCupones.FolioActual(const Campo,
  Serie: AnsiString): Integer;
var
  ds: IDADataSet;
begin
  ds:=Schema.NewDataset(Connection, 'spFolioActual');
  ds.ParamByName('Campo').AsString:=Campo;
  ds.ParamByName('Serie').AsString:=Serie;
  ds.Open;
  Result:=ds.FieldByName('Folio').AsInteger;
  ds.Close;
end;

function TServiceValesCupones.FolioActual2(const serie: AnsiString; const folio: Integer): Integer;
var
  ds: IDADataSet;
begin
  ds:=Schema.NewDataset(Connection, 'spFolioActual2');
  ds.ParamByName('serie').AsString:=Serie;
  ds.ParamByName('folio').AsInteger:=folio;
  ds.ParamByName('GasolineroID').AsInteger:= GasolineroID;
  ds.Open;
  Result:=ds.FieldByName('Folio').AsInteger;
  ds.Close;
end;

function TServiceValesCupones.GasolineroID: Integer;
begin
  Result:=ServerDataModule.GasolineroID;
end;

procedure TServiceValesCupones.GeneraCupones(const LoteCuponID, ClienteID,
  EstacionID, Identificador: Integer; const Cupones: AGeneraCupon;
  const TipoCupon: Boolean; const Serie: AnsiString; const aFolio: Integer);
var
  I, J, Aux: Integer;
  cmd: IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection, 'Insert_dbo Cupon');
  cmd.ParamByName('ClienteID').AsInteger:=ClienteID;
  cmd.ParamByName('EstacionID').AsInteger:=EstacionID;
  cmd.ParamByName('LoteCuponID').AsInteger:=LoteCuponID;
  cmd.ParamByName('Status').AsString:='A';
  cmd.ParamByName('VolumenImporte').AsString:='I';
  cmd.ParamByName('Serie').AsString:= Serie;
  cmd.ParamByName('Folio').AsInteger:= aFolio;
  //cmd.ParamByName('FechaEmision').AsDateTime:= Now();
  for I := 0 to Cupones.Count - 1 do
  begin
    cmd.ParamByName('Referencia').AsString:=Cupones[I].Referencia;
    cmd.ParamByName('FechaValido').AsDateTime:=Trunc(Now) + 365;
    for J := 1 to Cupones[I].Cantidad do
    begin
      Aux:=Folio('CuponID', '');
      cmd.ParamByName('CuponID').AsInteger:=Aux;
      cmd.ParamByName('Barras').AsString:='0005' + FormatFloat('0000', Identificador) + FormatFloat('00000000', Aux);
      cmd.ParamByName('Importe').AsFloat:=Cupones[I].Denominacion;
      cmd.ParamByName('TipoCupon').AsBoolean:= TipoCupon;
      cmd.Execute;
    end;
  end;
end;

function TServiceValesCupones.GeneraFactura(const EstacionID: Integer;
  const Serie: AnsiString; const FechaCorte: DateTime; const ClienteID,
  UsuarioID: Integer): Integer;
begin

end;

function TServiceValesCupones.GeneraFacturasXCliente(const ClienteID: Integer;
  const Productos: AnsiString; const FechaCorte, FechaContable: DateTime;
  const Serie: AnsiString; const aFolio, EmpleadoID: Integer): Integer;
var
  DataSet: IDADataset;
  cmd3, cmd2,cmd1: IDASQLCommand;
  DatosFactura: TDatosFactura;
  Detalle:TDetalleFactura;
  MiFolio, CliID, MovID  : Integer;
  Porcentaje, SubTotal, ImpIVA, IVA, Total: Currency;
begin
  Result:=0;
  MiFolio:= aFolio;

  //Buscar por folio repetido
  Dataset := Schema.NewDataSet(Connection, 'spBuscaFolio');
  DataSet.ParamByName('Folio').AsInteger := MiFolio;
  DataSet.ParamByName('Serie').AsString := Serie;
  DataSet.Open;

  if DataSet.RecordCount > 0 then
  begin
    Result := -2;
    Exit;
  end;

  DataSet.Close;

  cmd1:= Schema.NewCommand(Connection, 'spActualizaConsumoGenFact2');
  cmd2:= Schema.NewCommand(Connection, 'spInsertarMovimiento');
  cmd3:= Schema.NewCommand(Connection, 'spInsertaSaldoDocumentos');

  DataSet := Schema.NewDataset(Connection, 'spObtenConsumosXCliente');
  DataSet.ParamByName('ClienteID').AsInteger := ClienteID;
  DataSet.ParamByName('FechaCorte').AsDateTime := FechaCorte;
  DataSet.ParamByName('Productos').AsString := Productos;

  DataSet.Open;

  if DataSet.EOF then MiFolio:= -1;

  while not(DataSet.EOF) do
  begin
    ////BUSCA SI FOLIO EXCEDE O NO ES EL CORRECTO AL FOLIO INICIAL Y FINAL//////
    MiFolio:= FolioActual2(Serie,MiFolio);
    if MiFolio < 0 then Begin Exit; End;
    ////////////////////////////////////////////////////////////////////////////

    Total := 0;
    CliID := DataSet.FieldByName('ClienteID').AsInteger;
    Porcentaje := DataSet.FieldByName('IVA').AsFloat;
    ImpIVA := Porcentaje / 100;

    //Crear Estructura//
    DatosFactura := TDatosFactura.Create;
    DatosFactura.Factura := TFactura.Create;
    DatosFactura.DetalleFactura := ATDetalleFactura.Create;
    ////////////////////

    MovID := Folio('MovimientoID', '');

    DatosFactura.Factura.FacturaID := Folio('FacturaID','');
    DatosFactura.Factura.Serie := Serie;
    DatosFactura.Factura.Folio := MiFolio;
    DatosFactura.Factura.Fecha := FechaContable;
    DatosFactura.Factura.FechaVencimiento := FechaContable + DataSet.FieldByName('PlazoPago').AsInteger;
    DatosFactura.Factura.FechaImpresion := FechaContable;
    DatosFactura.Factura.Ejercicio := strtoint(FormatDateTime('yyyy',FechaContable));
    DatosFactura.Factura.Periodo := strtoint(FormatDateTime('mm',FechaContable));
    DatosFactura.Factura.Saldo := 0;
    DatosFactura.Factura.Tickets := '';
    DatosFactura.Factura.EstacionID:= ServerDataModule.EstacionID;
    DatosFactura.Factura.ClienteID := CliID;
    DatosFactura.Factura.UsuarioID := EmpleadoID;
    DatosFactura.Factura.MovimientoID := MovID;
    DatosFactura.Factura.IVA := Porcentaje;

    while ((DataSet.FieldByName('ClienteID').AsInteger = CliID) and
          (DataSet.FieldByName('IVA').AsFloat = Porcentaje) and
           (not DataSet.EOF)) do
    begin
      Detalle:=TDetalleFactura.Create;
      Detalle.Cantidad:=DataSet.FieldByName('Cantidad').AsFloat;
      Detalle.Precio:=DataSet.FieldByName('Precio').AsFloat;
      Detalle.Importe:=DataSet.FieldByName('Importe').AsFloat;
      Detalle.ProductoID:=DataSet.FieldByName('ProductoID').AsInteger;
      Detalle.DetalleFacturaID:=Folio('DetalleFacturaID', '');
      DatosFactura.DetalleFactura.Add(Detalle);
      Total := Total + DataSet.FieldByName('Importe').AsFloat;
      DataSet.Next;
    end;

    //Afectar Consumos
    cmd1.ParamByName('FechaCorte').AsDateTime := FechaCorte;
    cmd1.ParamByName('ClientID').AsInteger := CliID;
    cmd1.ParamByName('FacturaID').AsInteger := DatosFactura.Factura.FacturaID;
    cmd1.ParamByName('Productos').AsString := Productos;
    cmd1.Execute;

    DatosFactura.Factura.Tickets := BuscaTicketsFactura(DatosFactura.Factura.FacturaID);

    //Afectar Movimientos//
    cmd2.ParamByName('MovimientoID').AsInteger:= MovID;
    cmd2.ParamByName('FechaMovimiento').AsDateTime:= FechaContable;
    cmd2.ParamByName('FechaVencimiento').AsDateTime:=FechaContable + DataSet.FieldByName('PlazoPago').AsInteger;
    cmd2.ParamByName('Referencia').AsString:= 'FACTURA: ' + Serie + inttostr(MiFolio);
    cmd2.ParamByName('Ejercicio').AsInteger:= strtoint(FormatDateTime('yyyy',FechaContable));
    cmd2.ParamByName('Periodo').AsInteger:= strtoint(FormatDateTime('mm',FechaContable));
    cmd2.ParamByName('CargoAbono').AsString:= 'C';
    cmd2.ParamByName('Cargo').AsFloat := Total;
    cmd2.ParamByName('Abono').AsFloat := 0;
    cmd2.ParamByName('FechaRegistro').AsDateTime := Trunc(now);
    cmd2.ParamByName('Origen').AsString:= 'AUTO';
    cmd2.ParamByName('AfectaSaldos').AsBoolean := False;
    cmd2.ParamByName('TipoMovimientoID').AsString := 'FAC';
    cmd2.ParamByName('UsuarioID').AsInteger:= EmpleadoID;
    cmd2.ParamByName('ClienteID').AsInteger:= CliID;
    cmd2.Execute;

    //Afectar SaldosDocumentos//
    cmd3.ParamByName('SaldoDocumentoID').AsInteger:=Folio('SaldoDocID', '');
    cmd3.ParamByName('Fecha').AsDateTime:=FechaContable;
    cmd3.ParamByName('FechaVencimiento').AsDateTime := FechaContable + DataSet.FieldByName('PlazoPago').AsInteger;
    cmd3.ParamByName('Cargo').AsFloat:=Total;
    cmd3.ParamByName('Abono').AsFloat:=0;
    cmd3.ParamByName('Referencia').AsString:='FACTURA: ' + Serie + inttostr(MiFolio);
    cmd3.ParamByName('ClienteID').AsInteger:=CliID;
    cmd3.ParamByName('MovimientoID').AsInteger:= MovID;
    cmd3.ParamByName('ReciboID').AsInteger:= 0;
    cmd3.ParamByName('BancoID').AsInteger:= 0;
    cmd3.Execute;

    SubTotal:=StrToFloat(FormatFloat('#0.00', Total / (1+ImpIVA)));
    IVA:=StrToFloat(FormatFloat('#0.00', Total - SubTotal));
    Result:= MovID;
    MiFolio := MiFolio + 1;
    DatosFactura.Factura.Subtotal:=SubTotal;
    DatosFactura.Factura.Impuesto:=IVA;
    DatosFactura.Factura.Total:= Total;

    GuardaDatosFactura(DatosFactura);
  end;
end;

function TServiceValesCupones.GenerarFacturas(const Serie: AnsiString;
  const fol: Integer; const FechaCorte, FechaContable: DateTime;
  const DiaFacturar: Integer; const Magna, Premium, Diesel: Boolean;
  const EmpleadoID: Integer): Integer;
var
  DataSet: IDADataset;
  cmd3, cmd2,cmd1: IDASQLCommand;
  DatosFactura: TDatosFactura;
  Detalle:TDetalleFactura;
  MiFolio, CliID, MovID  : Integer;
  Porcentaje, SubTotal, ImpIVA, IVA, Total: Currency;
  Vencimiento: TDateTime;
  AuxMagna,AuxPremium,AuxDiesel: Integer;
begin
  Result:= 0;
  MiFolio:= fol;
  //Buscar por folio repetido
  try
    Dataset := Schema.NewDataSet(Connection, 'spBuscaFolio');
    DataSet.ParamByName('Folio').AsInteger := MiFolio;
    DataSet.ParamByName('Serie').AsString := Serie;
    DataSet.Open;

    if DataSet.RecordCount > 0 then
    begin
      Result := -2;
      Exit;
    end;
  finally
    DataSet.Close;
  end;

  cmd1:= Schema.NewCommand(Connection, 'spActualizaConsumoGenFact');
  cmd2:= Schema.NewCommand(Connection, 'spInsertarMovimiento');
  cmd3:= Schema.NewCommand(Connection, 'spInsertaSaldoDocumentos');

  MiFolio:= fol;

  if Magna then AuxMagna := 1 else AuxMagna := 0;
  if Premium then AuxPremium := 2 else AuxPremium := 0;
  if Diesel then AuxDiesel := 3 else AuxDiesel := 0;

  DataSet:= Schema.NewDataset(Connection, 'spObtenClientesConsumos');

  DataSet.ParamByName('Magna').AsInteger := AuxMagna;
  DataSet.ParamByName('Premium').AsInteger := AuxPremium;
  DataSet.ParamByName('Diesel').AsInteger := AuxDiesel;

  DataSet.ParamByName('FechaCorte').AsDateTime := FechaCorte;
  DataSet.ParamByName('GrupoFacturar').AsInteger := DiaFacturar;
  DataSet.Open;

  IF DataSet.EOF then MiFolio:= -1;

  while not(DataSet.EOF) Do
  begin
    ////BUSCA SI FOLIO EXCEDE O NO ES EL CORRECTO AL FOLIO INICIAL Y FINAL//////
    MiFolio:= FolioActual2(Serie,MiFolio);
    if MiFolio < 0 then Begin Result:= -1; Exit; End;
    ////////////////////////////////////////////////////////////////////////////
    Total := 0;
    CliID := DataSet.FieldByName('ClienteID').AsInteger;
    Porcentaje:=DataSet.FieldByName('IVA').AsFloat;
    ImpIVA:= Porcentaje / 100;
    Vencimiento:=FechaContable + DataSet.FieldByName('PlazoPago').AsInteger;
    //crear Estructura//
      DatosFactura := TDatosFactura.Create;
      DatosFactura.Factura:= TFactura.Create;
      DatosFactura.DetalleFactura := ATDetalleFactura.Create;
    ////////////////////

    MovID := Folio('MovimientoID', '');

    DatosFactura.Factura.FacturaID:=Folio('FacturaID','');
    DatosFactura.Factura.Serie :=Serie;
    DatosFactura.Factura.Folio:=MiFolio;
    DatosFactura.Factura.Fecha:=FechaContable;

    DatosFactura.Factura.FechaVencimiento:= Vencimiento;
    DatosFactura.Factura.FechaImpresion:= FechaContable;
    DatosFactura.Factura.Ejercicio:= strtoint(FormatDateTime('yyyy',FechaContable));
    DatosFactura.Factura.Periodo:=strtoint(FormatDateTime('mm',FechaContable));
    DatosFactura.Factura.Saldo:=0;
    //DatosFactura.Factura.Tickets:='';
    DatosFactura.Factura.ClienteID:=CliID;
    DatosFactura.Factura.UsuarioID:=EmpleadoID;
    DatosFactura.Factura.MovimientoID:=MovID;
    DatosFactura.Factura.IVA:=Porcentaje;

    while ((DataSet.FieldByName('ClienteID').AsInteger = CliID) and
          (DataSet.FieldByName('IVA').AsFloat = Porcentaje) and
           (not DataSet.EOF)) do
    begin
      Detalle:=TDetalleFactura.Create;
      Detalle.Cantidad:=DataSet.FieldByName('Cantidad').AsFloat;
      Detalle.Precio:=DataSet.FieldByName('Precio').AsFloat;
      Detalle.Importe:=DataSet.FieldByName('Importe').AsFloat;
      Detalle.ProductoID:=DataSet.FieldByName('ProductoID').AsInteger;
      Detalle.DetalleFacturaID:=Folio('DetalleFacturaID', '');
      DatosFactura.DetalleFactura.Add(Detalle);
      Total := Total + DataSet.FieldByName('Importe').AsFloat;
      DataSet.Next;
    end;
    //Afectar Consumos
    cmd1.ParamByName('FechaCorte').AsDateTime := FechaCorte;
    cmd1.ParamByName('ClientID').AsInteger := CliID;
    cmd1.ParamByName('FacturaID').AsInteger := DatosFactura.Factura.FacturaID;
    cmd1.ParamByName('IVA').AsFloat := DatosFactura.Factura.IVA;
    cmd1.Execute;

    DatosFactura.Factura.Tickets := BuscaTicketsFactura(DatosFactura.Factura.FacturaID);

    //Afectar Movimientos//
    cmd2.ParamByName('MovimientoID').AsInteger:= MovID;
    cmd2.ParamByName('FechaMovimiento').AsDateTime:= FechaContable;
    cmd2.ParamByName('FechaVencimiento').AsDateTime:=Vencimiento;
    cmd2.ParamByName('Referencia').AsString:= 'FACTURA: ' + Serie + inttostr(MiFolio);
    cmd2.ParamByName('Ejercicio').AsInteger:= strtoint(FormatDateTime('yyyy',FechaContable));
    cmd2.ParamByName('Periodo').AsInteger:= strtoint(FormatDateTime('mm',FechaContable));
    cmd2.ParamByName('CargoAbono').AsString:= 'C';
    cmd2.ParamByName('Cargo').AsFloat := Total;
    cmd2.ParamByName('Abono').AsFloat := 0;
    cmd2.ParamByName('FechaRegistro').AsDateTime := Trunc(now);
    cmd2.ParamByName('Origen').AsString:= 'AUTO';
    cmd2.ParamByName('AfectaSaldos').AsBoolean := False;
    cmd2.ParamByName('TipoMovimientoID').AsString := 'FAC';
    cmd2.ParamByName('UsuarioID').AsInteger:= EmpleadoID;
    cmd2.ParamByName('ClienteID').AsInteger:= CliID;
    cmd2.Execute;

    //Afectar SaldosDocumentos//
    cmd3.ParamByName('SaldoDocumentoID').AsInteger:=Folio('SaldoDocID', '');
    cmd3.ParamByName('Fecha').AsDateTime:=FechaContable;
    cmd3.ParamByName('FechaVencimiento').AsDateTime := FechaContable + DataSet.FieldByName('PlazoPago').AsInteger;
    cmd3.ParamByName('Cargo').AsFloat:=Total;
    cmd3.ParamByName('Abono').AsFloat:=0;
    cmd3.ParamByName('Referencia').AsString:='FACTURA: ' + Serie + inttostr(MiFolio);
    cmd3.ParamByName('ClienteID').AsInteger:=CliID;
    cmd3.ParamByName('MovimientoID').AsInteger:= MovID;
    cmd3.ParamByName('ReciboID').AsInteger:= 0;
    cmd3.ParamByName('BancoID').AsInteger:= 0;
    cmd3.Execute;

    SubTotal:=StrToFloat(FormatFloat('#0.00', Total / (1+ImpIVA)));
    IVA:=StrToFloat(FormatFloat('#0.00', Total - SubTotal));

    MiFolio := MiFolio + 1;
    DatosFactura.Factura.Subtotal:=SubTotal;
    DatosFactura.Factura.Impuesto:=IVA;
    DatosFactura.Factura.Total:= Total;
    GuardaDatosFactura(DatosFactura);
  end;
  Result:= MovID;
end;

procedure TServiceValesCupones.GuardaAccesos(const UsuarioID: Integer;
  const Lista: AnsiString);
var
  I: Integer;
  MiLista: TStrings;
  cmdElimina: IDASQLCommand;
  cmdInserta: IDASQLCommand;
begin
  cmdElimina:=Schema.NewCommand(Connection, 'AccesosEliminar');
  cmdElimina.ParamByName('UsuarioID').AsInteger:=UsuarioID;
  cmdElimina.Execute;
  cmdInserta:=Schema.NewCommand(Connection, 'AccesosInsertar');
  cmdInserta.ParamByName('UsuarioID').AsInteger:=UsuarioID;
  MiLista:=TStringList.Create;
  MiLista.Text:=Lista;
  try
    for I := 0 to MiLista.Count - 1 do
    begin
      cmdInserta.ParamByName('OpcionID').AsString:=MiLista[I];
      cmdInserta.Execute;
    end;
  finally
    MiLista.Free;
  end;
end;

function TServiceValesCupones.GuardaArchivo(nomarch,Texto: String): Integer;
var
  F: TextFile;
begin
    {$I-}
    AssignFile( F, ExtractFilePath( Application.ExeName ) + nomarch+'.txt' );
    Reset(F);
    Rewrite(F);
    Write( F, Trim(Texto) );
    CloseFile(F);
    {$I+}
    Result:=1;
end;

function TServiceValesCupones.GuardaAutorizacion(
  const Autorizacion: TAutoriza): Boolean;
var
  cmdAutorizacion: IDASQLCommand;
begin
  Result := False;
  try
    cmdAutorizacion:= Schema.NewCommand(Connection,'spInsertarAutorizacion');
    cmdAutorizacion.ParamByName('AutorizacionID').AsInteger:= Autorizacion.AutorizacionID;
    cmdAutorizacion.ParamByName('Fecha').AsDateTime:= Autorizacion.Fecha;
    cmdAutorizacion.ParamByName('Importe').AsFloat:= Autorizacion.Importe;
    cmdAutorizacion.ParamByName('Cantidad').AsFloat:= Autorizacion.Cantidad;
    cmdAutorizacion.ParamByName('ImporteCantidad').AsString:= Autorizacion.ImporteCantidad;
    cmdAutorizacion.ParamByName('PosicionCarga').AsInteger:= Autorizacion.PosicionCarga;
    cmdAutorizacion.ParamByName('Referencia').AsString:= Autorizacion.Referencia;
    cmdAutorizacion.ParamByName('EstacionID').AsInteger:= Autorizacion.EstacionID;
    cmdAutorizacion.ParamByName('VehiculoID').AsInteger:= Autorizacion.VehiculoID;
    cmdAutorizacion.ParamByName('ClienteID').AsInteger:= Autorizacion.ClienteID;
    cmdAutorizacion.ParamByName('GasolineroID').AsInteger:= ServerDataModule.GasolineroID;
    cmdAutorizacion.ParamByName('Tipo').AsInteger:= Autorizacion.Tipo;
    cmdAutorizacion.ParamByName('Odometro').AsInteger:= Autorizacion.Odometro;
    cmdAutorizacion.Execute;
    Result:= True;
  except
  end;
end;

function TServiceValesCupones.GuardaConsumoExpress(
  const Consumo: TConsumoExpress): Boolean;
var
  cmd: IDASQLCommand;
begin
  Result:=True;
  try
    cmd:=Schema.NewCommand(Connection, 'Insert_dbo ConsumoExpress');
    cmd.ParamByName('Secuencia').AsInteger:=Consumo.Secuencia;
    cmd.ParamByName('EstacionID').AsInteger:=Consumo.EstacionID;
    cmd.ParamByName('ClienteID').AsInteger:=Consumo.ClienteID;
    cmd.ParamByName('BombaID').AsInteger:=Consumo.BombaID;
    cmd.ParamByName('ProductoID').AsInteger:=Consumo.ProductoID;
    cmd.ParamByName('FacturaID').AsInteger:=Consumo.FacturaID;
    cmd.ParamByName('Precio').AsFloat:=Consumo.Precio;
    cmd.ParamByName('Volumen').AsFloat:=Consumo.Volumen;
    cmd.ParamByName('Importe').AsFloat:=Consumo.Importe;
    cmd.ParamByName('FechaConsumo').AsDateTime:=Consumo.FechaConsumo;
    cmd.ParamByName('Ejercicio').AsString:=FormatDateTime('yyyy', Consumo.FechaConsumo);
    cmd.ParamByName('Periodo').AsString:=FormatDateTime('m', Consumo.FechaConsumo);
    cmd.ParamByName('Dia').AsString:=FormatDateTime('d', Consumo.FechaConsumo);
    cmd.ParamByName('Facturado').AsBoolean:=Consumo.Facturado;
    cmd.Execute;
  except
    Result:=False;
  end;
end;

procedure TServiceValesCupones.GuardaDatosFactura(
  const DatosFactura: TDatosFactura);
var
  cmdFactura:IDASQLCommand;
  cmdDetalles:IDASQLCommand;
  cmdDetalleCupon:IDASQLCommand;
  cmdCupon:IDASQLCommand;
  Datos: TDatosFactura;
  J,I: integer;
  ds, dsGasolinero: IDADataSet;

  DFacturaElectronica: TDataFacturaElectronicaF;
begin
  Datos:=TDatosFactura.Create;
  try
    Datos.Assign(DatosFactura);
    CalculaIEPS(Datos);
    cmdFactura:=Schema.NewCommand(Connection,'spInsertarFactura') ;
    cmdFactura.ParamByName('FacturaID').AsInteger:=Datos.Factura.FacturaID;
    cmdFactura.ParamByName('Serie').AsString:=Datos.Factura.Serie;
    cmdFactura.ParamByName('Folio').AsInteger:=Datos.Factura.Folio;
    cmdFactura.ParamByName('Fecha').AsDateTime:=Datos.Factura.Fecha;
    cmdFactura.ParamByName('FechaVencimiento').AsFloat:=Datos.Factura.FechaVencimiento;
    cmdFactura.ParamByName('FechaImpresion').AsDateTime:=Datos.Factura.FechaImpresion;
    cmdFactura.ParamByName('Ejercicio').AsInteger:=Datos.Factura.Ejercicio;
    cmdFactura.ParamByName('Periodo').AsInteger:=Datos.Factura.Periodo;
    cmdFactura.ParamByName('Subtotal').AsFloat:=Datos.Factura.Subtotal;
    cmdFactura.ParamByName('Impuesto').AsFloat:=Datos.Factura.Impuesto;
    cmdFactura.ParamByName('Total').AsFloat:=Datos.Factura.Total;
    cmdFactura.ParamByName('Saldo').AsFloat:=Datos.Factura.Saldo;
    cmdFactura.ParamByName('Tickets').AsString:=Datos.Factura.Tickets;
    cmdFactura.ParamByName('ClienteID').AsInteger:=Datos.Factura.ClienteID;
    cmdFactura.ParamByName('UsuarioID').AsInteger:=Datos.Factura.UsuarioID;
    cmdFactura.ParamByName('MovimientoID').AsInteger:=Datos.Factura.MovimientoID;
    cmdFactura.ParamByName('IVA').AsFloat:=Datos.Factura.IVA;
    cmdFactura.ParamByName('EstacionID').AsInteger:=Datos.Factura.EstacionID;
    cmdFactura.Execute;

    cmdDetalles:=Schema.NewCommand(Connection,'spInsertarDetalleFactura') ;
    for I := 0 to Datos.DetalleFactura.Count - 1 do
    begin
      cmdDetalles.ParamByName('DetalleFacturaID').AsInteger:=Datos.DetalleFactura[I].DetalleFacturaID;
      cmdDetalles.ParamByName('FacturaID').AsInteger:=Datos.Factura.FacturaID;
      cmdDetalles.ParamByName('Cantidad').AsFloat:=Datos.DetalleFactura.Items[I].Cantidad;
      cmdDetalles.ParamByName('Precio').AsFloat:=Datos.DetalleFactura.Items[I].Precio;
      cmdDetalles.ParamByName('Importe').AsFloat:=Datos.DetalleFactura.Items[I].Importe;
      cmdDetalles.ParamByName('ProductoID').AsInteger:=Datos.DetalleFactura.Items[I].ProductoID;
      cmdDetalles.Execute;
    end;

    cmdDetalleCupon:=Schema.NewCommand(Connection,'spInsertaDetalleCupon') ;
    For I:=0 to Datos.DetalleCupon.Count - 1 do
    begin
      cmdDetalleCupon.ParamByName('DetalleCuponID').AsInteger:=Folio('DetalleCuponID','');
      cmdDetalleCupon.ParamByName('Denominacion').AsFloat:=Datos.DetalleCupon.Items[I].Denominacion;
      cmdDetalleCupon.ParamByName('Cantidad').AsFloat:=Datos.DetalleCupon.Items[I].Cantidad;
      cmdDetalleCupon.ParamByName('Referencia').AsString:=Datos.DetalleCupon.Items[I].Referencia;
      cmdDetalleCupon.ParamByName('FacturaID').AsFloat:=Datos.Factura.FacturaID;
      cmdDetalleCupon.Execute;
      cmdCupon:=Schema.NewCommand(Connection,'spInsertarCupon') ;
      For J:=1 to Trunc(Datos.DetalleCupon.Items[I].Cantidad) do
      begin
        cmdCupon.ParamByName('CuponID').AsInteger:=Folio('CuponID','');
        cmdCupon.ParamByName('Importe').AsFloat:=Datos.DetalleCupon.Items[I].Denominacion;
        cmdCupon.ParamByName('FechaEmision').AsDateTime:=Datos.Factura.Fecha;


        cmdCupon.ParamByName('Barras').AsString:= IntToStr(cmdCupon.ParamByName('CuponID').AsInteger) +
                                                  IntToStr(Modulo66(inttostr(cmdCupon.ParamByName('CuponID').AsInteger))) +
                                                  IntToStr(Modulo66(IntToStr(cmdCupon.ParamByName('CuponID').AsInteger) + IntToStr(Modulo66(IntToStr(cmdCupon.ParamByName('CuponID').AsInteger)))));

        cmdCupon.ParamByName('ClienteID').AsInteger:=Datos.Factura.ClienteID;
        cmdCupon.ParamByName('FacturaID').AsInteger:=Datos.Factura.FacturaID;
        cmdCupon.ParamByName('DetalleCuponID').AsInteger:=cmdDetalleCupon.ParamByName('DetalleCuponID').AsInteger;
        cmdCupon.Execute;
      end;
    end;
  finally
    ///////////FACTURA ELECTRONICA//////////////////////////////////////////////
    {dsGasolinero:=Schema.NewDataset(Connection, 'spObtenDatosGasolinero');
    dsGasolinero.ParamByName('Gasolinero').AsInteger:=GasolineroID;
    dsGasolinero.Open;

    DFacturaElectronica:=  TDataFacturaElectronicaF.Create();
    DFacturaElectronica.Assign(CadenaOriginal(Datos.Factura.FacturaID, GasolineroID));
    ///////////FACTURA ELECTRONICA//////////////////////////////////////////////
    InsertaFacturaElectronica(Folio('FacturaElectronicaID',''),
                              DFacturaElectronica.CadenaOriginal,
                              DFacturaElectronica.SelloDigital,
                              Datos.Factura.FacturaID,
                              True,False,
                              dsGasolinero.FieldByName('NOCERTIFICADO').AsString,
                              dsGasolinero.FieldByName('NOAPROBACION').AsString,
                              dsGasolinero.FieldByName('ANOAPROBACION').AsDateTime);
    ////////////////////////////////////////////////////////////////////////////
    Datos.Free;}
  end;
end;

procedure TServiceValesCupones.GuardarDatosFacturaPemex(
  const DatosFacturaPemex: TDatosFacturaPemex);
var
  cmdFactura:IDASQLCommand;
  cmdDetalles:IDASQLCommand;
  I:integer;
  Datos: TDatosFacturaPemex;
begin
  Datos:=TDatosFacturaPemex.Create;
  try
    Datos.Assign(DatosFacturaPemex);
    cmdFactura:=Schema.NewCommand(Connection,'spInsertarFacturaPemex') ;
    cmdFactura.ParamByName('TurnoID').AsInteger:= Datos.TurnoID;
    cmdFactura.ParamByName('FacturaPemexID').AsInteger:= Datos.FacturaPemexID;
    cmdFactura.ParamByName('EstacionID').AsInteger:=Datos.EstacionID;
    cmdFactura.ParamByName('Fecha').AsDateTime:=Datos.Fecha;
    cmdFactura.ParamByName('Nombre').AsString:=Datos.Nombre;
    cmdFactura.ParamByName('Serie').AsString:=Datos.Serie;
    cmdFactura.ParamByName('Folio').AsInteger:=Datos.Folio;
    cmdFactura.ParamByName('ProductoID').AsInteger:=Datos.ProductoID;
    cmdFactura.ParamByName('Total').AsFloat:=Datos.Total;
    cmdFactura.Execute;

    cmdDetalles:=Schema.NewCommand(Connection,'spInsertarDetalleFacturaPemex') ;
    for I := 0 to Datos.DetalleFactura.Count - 1 do
    begin
      cmdDetalles.ParamByName('FacturaPemexID').AsInteger:=Datos.DetalleFactura.Items[I].FacturaPemexID;
      cmdDetalles.ParamByName('TipoValorPemexID').AsFloat:=Datos.DetalleFactura.Items[I].TipoValorPemexID;
      cmdDetalles.ParamByName('Cantidad').AsFloat:=Datos.DetalleFactura.Items[I].Cantidad;
      cmdDetalles.ParamByName('Importe').AsFloat:=Datos.DetalleFactura.Items[I].Importe;
      cmdDetalles.ParamByName('Precio').AsFloat:=Datos.DetalleFactura.Items[I].Precio;
      cmdDetalles.Execute;
    end;
  finally
    Datos.Free;
  end;
end;

procedure TServiceValesCupones.PuntosGuardaCriterios(const PuntosCriterioID: Integer; const Datos: AnsiString);
var
  cmd: IDASQLCommand;
begin
  cmd := Schema.NewCommand(Connection, 'spGuardaCriterio');
  cmd.ParamByName('PuntosCriterioID').AsInteger := PuntosCriterioID;
  cmd.ParamByName('Datos').AsString := Datos;
  cmd.Execute;
end;

procedure TServiceValesCupones.PuntosGuardaDatos(const Datos: TDatosPuntos);
var
  cmd: IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection, 'spGuardaDatosPuntos');
  cmd.ParamByName('ClienteID').AsInteger:=Datos.ClienteID;
  cmd.ParamByName('ApellidoPaterno').AsString:=Datos.ApellidoPaterno;
  cmd.ParamByName('ApellidoMaterno').AsString:=Datos.ApellidoMaterno;
  cmd.ParamByName('Nombres').AsString:=Datos.Nombres;
  cmd.ParamByName('email').AsString:=Datos.email;
  cmd.ParamByName('Nacimiento').AsDateTime:=Datos.Nacimiento;
  cmd.ParamByName('Referencia').AsString:=Datos.Referencia;
  cmd.ParamByName('Telefonos').AsString:=Datos.Telefonos;
  cmd.ParamByName('FacturaExpress').AsBoolean:=Datos.FacturaExpress;
  cmd.ParamByName('PuntosCategoriaID').AsInteger:=Datos.PuntosCategoriaID;
  cmd.ParamByName('Sexo').AsInteger := Datos.Sexo;
  cmd.ParamByName('FechaAltaExpress').AsDateTime := Now;
  cmd.ParamByName('RegistroExpress').AsInteger := Datos.UsuarioID;
  cmd.ParamByName('PuntosClubID').AsInteger := Datos.PuntosClubID;
  cmd.Execute;
end;

function TServiceValesCupones.QuemarCupon(const Consumo: TConsumo;
  const Barras: AnsiString): Boolean;
var
  cmd: IDASQLCommand;
begin
  if Consumo.Importe < 1 then
  begin
    Result:=True;
    Exit;
  end;
  cmd:= Schema.NewCommand(Connection, 'spModificaCupon');
  Result:= False;
  try
    GuardarConsumo(Consumo);
    cmd.ParamByName('Barras').AsString:= Barras;
    cmd.ParamByName('EstacionID').AsInteger:=Consumo.EstacionID;
    cmd.ParamByName('TurnoID').AsInteger:=Consumo.Turno;
    cmd.ParamByName('BombaID').AsInteger:=Consumo.PosicionCarga;
    cmd.ParamByName('FechaCarga').AsDateTime:=Consumo.FechaCarga;
    cmd.ParamByName('Secuencia').AsInteger:=Consumo.SecuenciaVenta;
    cmd.ParamByName('Importe').AsFloat:=Consumo.Importe;
    cmd.Execute;
    CancelaGrupo(StrToInt(Barras));
    Result:= True;
  except
  end;
end;

function TServiceValesCupones.registraactividadrealizada(const IDACTIVIDADMANTENIMIENTO: Integer;
                                                     const NOTA: AnsiString;
                                                     const STATUS: AnsiString): AnsiString;
var
  dsresgistraactividad: IDADataset;
begin
  dsresgistraactividad := Schema.NewDataset(Connection, 'spRegistraActividadRealizada');
  dsresgistraactividad.ParamByName('NOTA').AsString := NOTA;
  dsresgistraactividad.ParamByName('STATUS').AsString:= STATUS;
  dsresgistraactividad.ParamByName('IDMANTENIMIENTOACTIVIDAD').AsInteger:= IDACTIVIDADMANTENIMIENTO;
  dsresgistraactividad.Open;

  result:= dsresgistraactividad.FieldByName('RESULTADO').AsString;
end;

procedure TServiceValesCupones.GuardaLimiteFactura(const UsuarioID: Int64;
  const Cantidad: Double);
var
  cmdElimina: IDASQLCommand;
  cmdInserta: IDASQLCommand;
begin
  cmdElimina:=Schema.NewCommand(Connection, 'LimiteFacturaEliminar');
  cmdElimina.ParamByName('UsuarioID').AsInteger:=UsuarioID;
  cmdElimina.Execute;

  cmdInserta:=Schema.NewCommand(Connection, 'LimiteFacturaInserta');
  cmdInserta.ParamByName('UsuarioID').AsInteger:=UsuarioID;
  cmdInserta.ParamByName('Cantidad').AsCurrency:=Cantidad;
  cmdInserta.Execute;
end;

function TServiceValesCupones.GuardarConsumo(const Consumo: TConsumo): Boolean;
var
  Aux: TDatosVerifica;
  cmdConsumo:IDASQLCommand;
  spBuscaClienteEmpresa: IDADataset;
begin
   {if (Abs(Consumo.Importe) < 1) then
   begin
     Result:=True;
     Exit;
   end;}
   cmdConsumo := Schema.NewCommand(Connection, 'spInsertaConsumo');
   spBuscaClienteEmpresa := Schema.NewDataset(Connection, 'BuscaClienteEmpresaDebito');
   Aux:=TDatosVerifica.Create;
   Try
       if Consumo.VehiculoID > 0 then
       begin
         Aux.Assign(DatosVerifica(Consumo.VehiculoID));
         cmdConsumo.ParamByName('Rendimiento').AsFloat := Decimales((Consumo.Kilometraje - Aux.KMS) / Consumo.Cantidad, 3);
       end
       else
         cmdConsumo.ParamByName('Rendimiento').AsFloat := 0;
       cmdConsumo.ParamByName('Serie').AsString:=Consumo.Serie;
       if Consumo.SecuenciaVenta = -1 then
         cmdConsumo.ParamByName('SecuenciaVenta').AsInteger := Folio('FolioOtrosID', '')
       else
         cmdConsumo.ParamByName('SecuenciaVenta').AsInteger := Consumo.SecuenciaVenta;
       cmdConsumo.ParamByName('EstacionID').AsInteger := Consumo.EstacionID;
       cmdConsumo.ParamByName('FechaMovimiento').AsDateTime := Consumo.FechaMovimiento;
       cmdConsumo.ParamByName('FechaCarga').AsDateTime := Consumo.FechaCarga;
       cmdConsumo.ParamByName('Ejercicio').AsInteger := Consumo.Ejercicio;
       cmdConsumo.ParamByName('Periodo').AsInteger := Consumo.Periodo;
       cmdConsumo.ParamByName('Dia').AsInteger := Consumo.Dia;
       cmdConsumo.ParamByName('Turno').AsInteger := Consumo.Turno;
       cmdConsumo.ParamByName('Kilometraje').AsInteger := Consumo.Kilometraje;
       if Length(Consumo.Tarjeta) <= 16 then
         cmdConsumo.ParamByName('Tarjeta').AsString := Consumo.Tarjeta
       else
         cmdConsumo.ParamByName('Tarjeta').AsString := Copy(Consumo.Tarjeta, 1, 16);
       cmdConsumo.ParamByName('PosicionCarga').AsInteger := Consumo.PosicionCarga;
       cmdConsumo.ParamByName('Cantidad').AsFloat := Consumo.Cantidad;
       cmdConsumo.ParamByName('Precio').AsFloat := Consumo.Precio;
       cmdConsumo.ParamByName('Importe').AsFloat := Consumo.Importe;
       cmdConsumo.ParamByName('ImpuestoImporte').AsFloat := Consumo.ImpuestoImporte;
       cmdConsumo.ParamByName('ImpuestoPorcentaje').AsFloat := Consumo.ImpuestoPorcentaje;
       cmdConsumo.ParamByName('CuentaContable').AsString := Consumo.CuentaContable;
       cmdConsumo.ParamByName('ManualAutomatico').AsString := Consumo.ManualAutomatico;
       cmdConsumo.ParamByName('Facturado').AsInteger := Consumo.Facturado;
       cmdConsumo.ParamByName('EnIngresos').AsInteger := Consumo.EnIngresos;
       cmdConsumo.ParamByName('Auditado').AsInteger := Consumo.Auditado;
       cmdConsumo.ParamByName('FacturaID').AsInteger := Consumo.FacturaID;
       cmdConsumo.ParamByName('ProductoID').AsInteger := Consumo.ProductoID;
       cmdConsumo.ParamByName('GasolineroID').AsInteger := ServerDataModule.GasolineroID;
       if Consumo.ClienteID <> 0 then
       begin
         {if Consumo.ClienteID <> -1 then
           cmdConsumo.ParamByName('ClienteID').AsInteger := Consumo.ClienteID
         else
           cmdConsumo.ParamByName('ClienteID').AsInteger := ServerDataModule.ClienteBancaria; }

         if Consumo.ClienteID <> -1 then
           cmdConsumo.ParamByName('ClienteID').AsInteger := Consumo.ClienteID
       end
       else
         cmdConsumo.ParamByName('ClienteID').AsInteger:= buscaClientexVehiculo(Consumo.VehiculoID);
       cmdConsumo.ParamByName('VehiculoID').AsInteger := Consumo.VehiculoID;
       cmdConsumo.ParamByName('IEPS').AsFloat:= Consumo.IEPS;
       cmdConsumo.ParamByName('UsuarioID').AsInteger:= Consumo.UsuarioID;
       cmdConsumo.Execute;
       Result:= True;

       //---------------------------------------------------------------------//
         {IF (ServerDataModule.DebitoEmpresa = 'S') and
         ((Consumo.Referencia = 'DEBITO') OR (Copy(Consumo.Referencia, 1, 4) = '0002'))
         Then
         begin
            spBuscaClienteEmpresa.Close;
            spBuscaClienteEmpresa.ParamByName('ESTACIONID').AsInteger:= Consumo.EstacionID;
            spBuscaClienteEmpresa.Open;

            if not spBuscaClienteEmpresa.EOF then
            begin
               cmdConsumo.ParamByName('ClienteID').AsInteger:= spBuscaClienteEmpresa.FieldByName('CLIENTEID').AsInteger;
               cmdConsumo.ParamByName('FlotillaID').AsInteger := spBuscaClienteEmpresa.FieldByName('VEHICULOID').AsInteger;
               cmdConsumo.Execute;

               spBuscaClienteEmpresa.Next;
            end;
         end;  }
       //---------------------------------------------------------------------//
   Except
       Result:= False;
   End;
end;

procedure TServiceValesCupones.GuardarDatosFactura(
  const DatosFactura: TDatosFactura);
var
  cmdFactura:IDASQLCommand;
  cmdDetalles:IDASQLCommand;
  cmdTickets:IDASQLCommand;
  cmdDetalleCupon:IDASQLCommand;
  cmdCupon:IDASQLCommand;
  cmdCartera:IDASQLCommand;
  cmdVales:IDASQLCommand;
  ds, dsGasolinero: IDADataSet;

  I:integer;
  J:integer;
  Datos: TDatosFactura;
  SelloDig: String;
begin
  Datos:=TDatosFactura.Create;
  try
    Datos.Assign(DatosFactura);
    CalculaIEPS(Datos);
    CalculaISR_IVARTN(Datos);

    cmdFactura:=Schema.NewCommand(Connection,'spInsertarFactura') ;
    cmdFactura.ParamByName('FacturaID').AsInteger:=Datos.Factura.FacturaID;
    cmdFactura.ParamByName('Folio').AsInteger:=Folio('FolioFactura',Datos.Factura.Serie);
    cmdFactura.ParamByName('Serie').AsString:=Datos.Factura.Serie;
    cmdFactura.ParamByName('Fecha').AsDateTime:=Datos.Factura.Fecha;
    cmdFactura.ParamByName('Ejercicio').AsString:=FormatDateTime('yyyy', Datos.Factura.Fecha);
    cmdFactura.ParamByName('Periodo').AsString:=FormatDateTime('m', Datos.Factura.Fecha);
    cmdFactura.ParamByName('Dia').AsString:=FormatDateTime('d', Datos.Factura.Fecha);
    cmdFactura.ParamByName('SubTotal').AsFloat:=Datos.Factura.Subtotal;
    cmdFactura.ParamByName('Impuesto').AsFloat:=Datos.Factura.Impuesto;
    cmdFactura.ParamByName('Total').AsFloat:=Datos.Factura.Total;
    cmdFactura.ParamByName('ImpuestoPorcentaje').AsFloat:=Datos.Factura.ImpuestoPorcentaje;
    cmdFactura.ParamByName('Turno').AsInteger:=Datos.Factura.Turno;
    cmdFactura.ParamByName('EstacionID').AsInteger:=Datos.Factura.EstacionID;
    cmdFactura.ParamByName('ClienteID').AsInteger:=Datos.Factura.ClienteID;
    cmdFactura.ParamByName('FormaPagoID').AsInteger:=Datos.Factura.FormaPagoID;
    cmdFactura.ParamByName('TipoFacturaID').AsInteger:=Datos.Factura.TipoFacturaID;
    cmdFactura.ParamByName('Tickets').AsString:=Datos.Factura.Tickets;
    cmdFactura.ParamByName('UsuarioID').AsInteger:=Datos.Factura.UsuarioID;
    cmdFactura.ParamByName('ISR').AsFloat:= Datos.Factura.ISR;
    cmdFactura.ParamByName('IVARTN').AsFloat:= Datos.Factura.IVARTN;
    cmdFactura.Execute;

    cmdDetalles:=Schema.NewCommand(Connection,'spInsertarDetalleFactura') ;
    for I := 0 to Datos.Detalles.Count - 1 do
    begin
      cmdDetalles.ParamByName('DetalleFacturaID').AsInteger:=Folio('DetalleFactura','');
      cmdDetalles.ParamByName('Cantidad').AsFloat:=Datos.Detalles.Items[I].Cantidad;
      cmdDetalles.ParamByName('Precio').AsFloat:=Datos.Detalles.Items[I].Precio;
      cmdDetalles.ParamByName('Importe').AsFloat:=Datos.Detalles.Items[I].Importe;
      cmdDetalles.ParamByName('ItemNo').AsInteger:=I;
      cmdDetalles.ParamByName('FacturaID').AsInteger:=Datos.Factura.FacturaID;
      cmdDetalles.ParamByName('ProductoID').AsInteger:=Datos.Detalles.Items[I].ProductoID;
      cmdDetalles.Execute;
    end;
    cmdTickets:=Schema.NewCommand(Connection,'spInsertarTicketFactura') ;
    For I:= 0 to Datos.Tickets.Count - 1 do
    begin
      cmdTickets.ParamByName('TicketFacturaID').AsInteger:=Folio('TicketFacturaID','');
      cmdTickets.ParamByName('TicketID').AsInteger:=Datos.Tickets.Items[I].TicketID;
      cmdTickets.ParamByName('Fecha').AsDateTime:=Datos.Tickets.Items[I].Fecha;
      cmdTickets.ParamByName('Volumen').AsFloat:=Datos.Tickets.Items[I].Volumen;
      cmdTickets.ParamByName('Precio').AsFloat:=Datos.Tickets.Items[I].Precio;
      cmdTickets.ParamByName('Importe').AsFloat:=Datos.Tickets.Items[I].Importe;
      cmdTickets.ParamByName('ProductoID').AsInteger:=Datos.Tickets.Items[I].ProductoID;
      cmdTickets.ParamByName('FacturaID').AsInteger:=Datos.Factura.FacturaID;
      cmdTickets.ParamByName('EstacionID').AsInteger:=Datos.Tickets.Items[I].EstacionID;
      cmdTickets.Execute;
    end;
    cmdDetalleCupon:=Schema.NewCommand(Connection,'spInsertarDetalleCupon') ;
    For I:=0 to Datos.DetalleCupon.Count - 1 do
    begin
      cmdDetalleCupon.ParamByName('DetalleCuponID').AsInteger:=Folio('DetalleCuponID','');
      cmdDetalleCupon.ParamByName('Denominacion').AsFloat:=Datos.DetalleCupon.Items[I].Denominacion;
      cmdDetalleCupon.ParamByName('Cantidad').AsFloat:=Datos.DetalleCupon.Items[I].Cantidad;
      cmdDetalleCupon.ParamByName('Referencia').AsString:=Datos.DetalleCupon.Items[I].Referencia;
      cmdDetalleCupon.ParamByName('FacturaID').AsFloat:=Datos.Factura.FacturaID;
      cmdDetalleCupon.Execute;
      cmdCupon:=Schema.NewCommand(Connection,'spInsertarCupon') ;
      For J:=1 to Trunc(Datos.DetalleCupon.Items[I].Cantidad) do
      begin
        cmdCupon.ParamByName('CuponID').AsInteger:=Folio('CuponID','');
        cmdCupon.ParamByName('Importe').AsFloat:=Datos.DetalleCupon.Items[I].Denominacion;
        cmdCupon.ParamByName('FechaEmision').AsDateTime:=Datos.Factura.Fecha;
        cmdCupon.ParamByName('Barras').AsString:=IntToStr(cmdCupon.ParamByName('CuponID').AsInteger);
        cmdCupon.ParamByName('Secuencia').AsInteger:=Datos.Factura.Turno;
        cmdCupon.ParamByName('ClienteID').AsInteger:=Datos.Factura.ClienteID;
        cmdCupon.ParamByName('FacturaID').AsInteger:=Datos.Factura.FacturaID;
        cmdCupon.ParamByName('DetalleCuponID').AsInteger:=cmdDetalleCupon.ParamByName('DetalleCuponID').AsInteger;
        cmdCupon.ParamByName('EstacionID').AsInteger:=Datos.Factura.EstacionID;
        cmdCupon.Execute;
      end;
    end;
    if Datos.Factura.FormaPagoID = 4 then
    begin
      cmdCartera:=Schema.NewCommand(Connection,'spCrearCargo') ;
      cmdCartera.ParamByName('MovimientoCarteraID').AsInteger:=Folio('MovimientoCarteraID','');
      cmdCartera.ParamByName('CarteraID').AsInteger:=Folio('CarteraID','');
      cmdCartera.ParamByName('Operador').AsInteger:=1;
      cmdCartera.ParamByName('Folio').AsInteger:=Folio('FolioCarteraID','');
      cmdCartera.ParamByName('Fecha').AsDateTime:=Datos.Factura.Fecha;
      cmdCartera.ParamByName('Importe').AsFloat:=Datos.Factura.Total;
      cmdCartera.ParamByName('Status').AsString:='CS';
      cmdCartera.ParamByName('ConceptoCarteraID').AsInteger:=1;
      cmdCartera.ParamByName('FacturaID').AsInteger:= Datos.Factura.FacturaID;
      cmdCartera.ParamByName('ClienteID').AsInteger:=Datos.Factura.ClienteID;
      cmdCartera.ParamByName('EstacionID').AsInteger:=Datos.Factura.EstacionID;
      cmdCartera.Execute;
    end;
    cmdVales:=Schema.NewCommand(Connection,'spInsertarDetalleValeFactura') ;
    For I:=0 to Datos.Vales.Count - 1 do
    begin
      cmdVales.ParamByName('DetalleValeCreditoFacturaID').AsInteger:=Folio('DetalleValeFacturaID','');
      cmdVales.ParamByName('NoVale').AsInteger:=Datos.Vales.Items[i].NoVale;
      cmdVales.ParamByName('Importe').AsFloat:=Datos.Vales.Items[i].Importe;
      cmdVales.ParamByName('FacturaID').AsInteger:=Datos.Factura.FacturaID;
      cmdVales.ParamByName('CarteraValeCreditoID').AsInteger:=Datos.Vales.Items[i].CarteraValeCreditoID;
      cmdVales.Execute;
      ActualizarStatusValeCredito(Datos.Vales.Items[i].CarteraValeCreditoID,'FA', Datos.Factura.FacturaID);
    end;
  finally
    ///////////FACTURA ELECTRONICA//////////////////////////////////////////////
    dsGasolinero:=Schema.NewDataset(Connection, 'spObtenDatosGasolinero');
    dsGasolinero.ParamByName('EstacionID').AsInteger:=Datos.Factura.EstacionID;
    dsGasolinero.Open;

    ds:=Schema.NewDataset(Connection, 'spCadenaOriginal2');
    ds.ParamByName('EstacionID').AsInteger:=Datos.Factura.EstacionID;
    ds.ParamByName('FacturaID').AsInteger:=Datos.Factura.FacturaID;
    ds.Open;

    SelloDig:= TRIM(SELLOPEMs(depuraCadena(ds.FieldByName('cadenaoriginal').AsWideString),Datos.Factura.EstacionID));
    InsertaFacturaElectronica(Folio('FacturaElectronicaID',''),
                              ds.FieldByName('cadenaoriginal').AsWideString,
                              SelloDig,
                              Datos.Factura.FacturaID,
                              True,False,
                              dsGasolinero.FieldByName('NOCERTIFICADO').AsString,
                              dsGasolinero.FieldByName('NOAPROBACION').AsString,
                              dsGasolinero.FieldByName('ANOAPROBACION').AsDateTime);
    ////////////////////////////////////////////////////////////////////////////
    Datos.Free;
  end;
end;


procedure TServiceValesCupones.GuardarDatosLiquidacion(
  const DatosLiquidacion: TDatosLiquidacion);
var
  cmdLiquidacion:IDASQLCommand;
  cmdCombustible:IDASQLCommand;
  cmdProducto:IDASQLCommand;
  cmdTransaccion:IDASQLCommand;
  cmdDetalleTransaccion:IDASQLCommand;
  cmdLiquidacionDetalle:IDASQLCommand;
  I:integer;
  LiquidacionID:integer;
  Cantidad:real;
begin
  cmdLiquidacion:=Schema.NewCommand(Connection,'spInsertarLiquidacion') ;
  LiquidacionID:=Folio('LiquidacionID','');
  cmdLiquidacion.ParamByName('LiquidacionID').AsInteger:=LiquidacionID;
  cmdLiquidacion.ParamByName('FechaActual').AsDateTime:=DatosLiquidacion.Liquidacion.Fecha;
  cmdLiquidacion.ParamByName('VentasTotales').AsFloat:=DatosLiquidacion.Liquidacion.VentasTotales;
  cmdLiquidacion.ParamByName('Anticipos').AsFloat:=DatosLiquidacion.Liquidacion.Anticipos;
  cmdLiquidacion.ParamByName('Diferencias').AsFloat:=DatosLiquidacion.Liquidacion.Diferencias;
  cmdLiquidacion.ParamByName('Secuencia').AsInteger:=DatosLiquidacion.Liquidacion.Secuencia;
  cmdLiquidacion.ParamByName('EstacionID').AsInteger:=DatosLiquidacion.Liquidacion.EstacionID;
  cmdLiquidacion.ParamByName('DespachadorID').AsInteger:=DatosLiquidacion.Liquidacion.DespachadorID;
  cmdLiquidacion.ParamByName('AgrupacionID').AsInteger:=DatosLiquidacion.Liquidacion.AgrupacionID;
  cmdLiquidacion.Execute;

  cmdCombustible:=Schema.NewCommand(Connection,'spInsertarLiquidacionCombustible') ;
  For I:=0 to DatosLiquidacion.LiquidacionCombustible.Count -1 do
  begin
    cmdCombustible.ParamByName('LiquidacionProductoID').AsInteger:=Folio('LiquidacionProductoID','');
    cmdCombustible.ParamByName('PrecioVenta').AsFloat:=DatosLiquidacion.LiquidacionCombustible.Items[i].PrecioVenta;
    cmdCombustible.ParamByName('InventarioInicial').AsFloat:=DatosLiquidacion.LiquidacionCombustible.Items[i].InventarioInicial;
    cmdCombustible.ParamByName('InventarioFinal').AsFloat:=DatosLiquidacion.LiquidacionCombustible.Items[i].InventarioFinal;
    cmdCombustible.ParamByName('Cantidad').AsFloat:=DatosLiquidacion.LiquidacionCombustible.Items[i].Cantidad;
    cmdCombustible.ParamByName('Importe').AsFloat:=DatosLiquidacion.LiquidacionCombustible.Items[i].Importe;
    cmdCombustible.ParamByName('Traspasos').AsFloat:=DatosLiquidacion.LiquidacionCombustible.Items[i].Traspasos;
    cmdCombustible.ParamByName('Secuencia').AsInteger:=DatosLiquidacion.LiquidacionCombustible.Items[i].Secuencia;
    cmdCombustible.ParamByName('LiquidacionID').AsInteger:=LiquidacionID;
    cmdCombustible.ParamByName('ProductoID').AsInteger:=DatosLiquidacion.LiquidacionCombustible.Items[i].ProductoID;
    cmdCombustible.ParamByName('BombaID').AsInteger:=DatosLiquidacion.LiquidacionCombustible.Items[i].BombaID;
    cmdCombustible.Execute;
  end;
  cmdProducto:=Schema.NewCommand(Connection,'spInsertarLiquidacionProducto') ;
  Cantidad:=0;
  For I:=0 to DatosLiquidacion.LiquidacionProducto.Count -1 do
  begin
    cmdProducto.ParamByName('LiquidacionProductoID').AsInteger:=Folio('LiquidacionProductoID','');
    cmdProducto.ParamByName('PrecioVenta').AsFloat:=DatosLiquidacion.LiquidacionProducto.Items[i].PrecioVenta;
    cmdProducto.ParamByName('InventarioInicial').AsFloat:=DatosLiquidacion.LiquidacionProducto.Items[i].InventarioInicial;
    cmdProducto.ParamByName('InventarioFinal').AsFloat:=DatosLiquidacion.LiquidacionProducto.Items[i].InventarioFinal;
    cmdProducto.ParamByName('Cantidad').AsFloat:=DatosLiquidacion.LiquidacionProducto.Items[i].Cantidad;
    cmdProducto.ParamByName('Importe').AsFloat:=DatosLiquidacion.LiquidacionProducto.Items[i].Importe;
    cmdProducto.ParamByName('Traspasos').AsFloat:=DatosLiquidacion.LiquidacionProducto.Items[i].Traspasos;
    cmdProducto.ParamByName('Secuencia').AsInteger:=DatosLiquidacion.LiquidacionProducto.Items[i].Secuencia;
    cmdProducto.ParamByName('LiquidacionID').AsInteger:=LiquidacionID;
    cmdProducto.ParamByName('ProductoID').AsInteger:=DatosLiquidacion.LiquidacionProducto.Items[i].ProductoID;
    cmdProducto.Execute;
    Cantidad:=Cantidad+DatosLiquidacion.LiquidacionProducto.Items[i].Cantidad;
  end;
  if Cantidad > 0 then
  begin
    cmdTransaccion:=Schema.NewCommand(Connection,'spInsertarTransaccion') ;
    cmdTransaccion.ParamByName('TransaccionID').AsInteger:=Folio('TransaccionID','');
    cmdTransaccion.ParamByName('Folio').AsInteger:=Folio('FolioVentaLiquidacionID','');
    cmdTransaccion.ParamByName('MovimientoAlmacen').AsInteger:=Folio('MovimientoAlmacen','');
    cmdTransaccion.ParamByName('AlmacenID').AsInteger:=1;
    cmdTransaccion.ParamByName('Fecha').AsDateTime:=DatosLiquidacion.Liquidacion.Fecha;
    cmdTransaccion.ParamByName('Secuencia').AsInteger:=DatosLiquidacion.Liquidacion.Secuencia;
    cmdTransaccion.ParamByName('EstacionID').AsInteger:=DatosLiquidacion.Liquidacion.EstacionID;
    cmdTransaccion.ParamByName('EstacionDestinoID').AsInteger:=DatosLiquidacion.Liquidacion.EstacionID;
    cmdTransaccion.ParamByName('Tipo').AsString:='VT';
    cmdTransaccion.ParamByName('Referencia').AsString:='.';
    cmdTransaccion.ParamByName('Total').AsFloat:=0;
    cmdTransaccion.ParamByName('Subtotal').AsFloat:=0;
    cmdTransaccion.ParamByName('Impuesto').AsFloat:=0;
    cmdTransaccion.ParamByName('Plazo').AsInteger:=0;
    cmdTransaccion.ParamByName('Credito').AsInteger:=0;
    cmdTransaccion.Execute;
    cmdDetalleTransaccion:=Schema.NewCommand(Connection,'spInsertarDetalleTransaccion');
    For I:=0 to DatosLiquidacion.LiquidacionProducto.Count -1 do
    begin
      cmdDetalleTransaccion.ParamByName('DetalleTransaccionID').AsInteger:=Folio('DetalleTransaccionID','');
      cmdDetalleTransaccion.ParamByName('TransaccionID').AsInteger:=cmdTransaccion.ParamByName('TransaccionID').AsInteger;
      cmdDetalleTransaccion.ParamByName('ProductoID').AsInteger:=DatosLiquidacion.LiquidacionProducto.Items[i].ProductoID;
      cmdDetalleTransaccion.ParamByName('Cantidad').AsFloat:=DatosLiquidacion.LiquidacionProducto.Items[i].Cantidad;
      cmdDetalleTransaccion.ParamByName('Tipo').AsString:='VT';
      cmdDetalleTransaccion.ParamByName('Operador').AsInteger:=-1;
      cmdDetalleTransaccion.ParamByName('MovimientoAlmacen').AsInteger:=cmdTransaccion.ParamByName('MovimientoAlmacen').AsInteger;
      cmdDetalleTransaccion.Execute;
    end;
  end;
  cmdLiquidacionDetalle:=Schema.NewCommand(Connection,'spInsertarLiquidacionDetalle');
  For I:=0 to DatosLiquidacion.LiquidacionDetalle.Count -1 do
  begin
    cmdLiquidacionDetalle.ParamByName('LiquidacionDetalleID').asinteger:=Folio('LiquidacionDetalleID','');
    cmdLiquidacionDetalle.ParamByName('Importe').AsFloat:=DatosLiquidacion.LiquidacionDetalle.Items[i].Importe;
    cmdLiquidacionDetalle.ParamByName('Secuencia').AsInteger:=DatosLiquidacion.LiquidacionDetalle.Items[i].Secuencia;
    cmdLiquidacionDetalle.ParamByName('Referencia').Value:=DatosLiquidacion.LiquidacionDetalle.Items[i].Referencia;
    cmdLiquidacionDetalle.ParamByName('Ticket').Value:=DatosLiquidacion.LiquidacionDetalle.Items[i].Ticket;
    cmdLiquidacionDetalle.ParamByName('Cupon').Value:=DatosLiquidacion.LiquidacionDetalle.Items[i].Cupon;
    cmdLiquidacionDetalle.ParamByName('LiquidacionID').AsInteger:=LiquidacionID;
    cmdLiquidacionDetalle.ParamByName('TipoValorID').AsInteger:=DatosLiquidacion.LiquidacionDetalle.Items[i].TipoValorID;
    cmdLiquidacionDetalle.ParamByName('BancoID').Value:=DatosLiquidacion.LiquidacionDetalle.Items[i].BancoID;
    cmdLiquidacionDetalle.ParamByName('SalidaID').Value:=DatosLiquidacion.LiquidacionDetalle.Items[i].SalidaID;
    cmdLiquidacionDetalle.ParamByName('ClienteID').Value:=DatosLiquidacion.LiquidacionDetalle.Items[i].ClienteID;
    cmdLiquidacionDetalle.ParamByName('EstacionID').Value:=DatosLiquidacion.Liquidacion.EstacionID;
    cmdLiquidacionDetalle.ParamByName('Fecha').Value:=DatosLiquidacion.Liquidacion.Fecha;
    cmdLiquidacionDetalle.Execute;
  end;
  ActualizaLiquidacionCorte(LiquidacionID,DatosLiquidacion.Liquidacion.Secuencia,DatosLiquidacion.Liquidacion.AgrupacionID);
end;

procedure TServiceValesCupones.GuardarDatosReciboPago(
  const DatosReciboPago: TDatosReciboPago);
var
  cmdReciboPago:IDASQLCommand;
  cmdDetalles:IDASQLCommand;
  I:integer;
begin
  cmdReciboPago:=Schema.NewCommand(Connection,'spInsertarReciboPago') ;
  cmdReciboPago.ParamByName('ReciboPagoID').AsInteger:=DatosReciboPago.Recibo.ReciboPagoID;
  cmdReciboPago.ParamByName('Folio').AsInteger:=Folio('FolioReciboPago',DatosReciboPago.Recibo.Serie);
  cmdReciboPago.ParamByName('Serie').AsString:=DatosReciboPago.Recibo.Serie;
  cmdReciboPago.ParamByName('Fecha').AsDateTime:=DatosReciboPago.Recibo.Fecha;
  cmdReciboPago.ParamByName('Subtotal').AsFloat:=DatosReciboPago.Recibo.Subtotal;
  cmdReciboPago.ParamByName('Impuesto').AsFloat:=DatosReciboPago.Recibo.Impuesto;
  cmdReciboPago.ParamByName('Total').AsFloat:=DatosReciboPago.Recibo.Total;
  cmdReciboPago.ParamByName('EstacionID').AsInteger:=DatosReciboPago.Recibo.EstacionID;
  cmdReciboPago.ParamByName('ClienteID').AsInteger:=DatosReciboPago.Recibo.ClienteID;
  cmdReciboPago.ParamByName('FormaPagoID').AsInteger:=DatosReciboPago.Recibo.FormaPagoID;
  cmdReciboPago.Execute;

  cmdDetalles:=Schema.NewCommand(Connection,'spInsertarDetalleReciboPago') ;
  for I := 0 to  DatosReciboPago.Detalles.Count - 1 do
  begin
    cmdDetalles.ParamByName('DetalleReciboPagoID').AsInteger:=Folio('DetalleReciboPagoID','');
    cmdDetalles.ParamByName('Importe').AsFloat:=DatosReciboPago.Detalles.Items[I].Total;
    cmdDetalles.ParamByName('ItemNo').AsInteger:=I;
    cmdDetalles.ParamByName('ReciboPagoID').AsInteger:= DatosReciboPago.Recibo.ReciboPagoID;
    cmdDetalles.ParamByName('FacturaID').AsInteger:=DatosReciboPago.Detalles.Items[I].FacturaID;
    cmdDetalles.Execute;
  end;
end;

function TServiceValesCupones.GuardarFacturaExpress(const ClienteID: Integer;
  const Serie: AnsiString; const EstacionID: Integer; const TicketID: Integer): TFacturaExpress;
var
  ds: IDADataSet;
  dsConsumosporFacturar:IDADataSet;
  dsConsumosPorCliente:IDADataSet;
  dsDatosEstacion:IDADAtaSet;

  cmdFactura:IDASQLCommand;
  cmdDetalles:IDASQLCommand;
  cmdTickets:IDASQLCommand;
  Total,Iva,SubTotal,ImpuestoPorcentaje,Impuesto:Float;
  FolioFactura,I,FolioFacturaID:Integer;
  Tickets:String;
begin
   Tickets:='';
   Total:=0;
   Result:=TFacturaExpress.Create;
   Result.FacturaID:=0;
   dsConsumosPorcliente:=Schema.NewDataSet(Connection,'ObtenerConsumosExpressPorCliente');
   dsConsumosPorCliente.ParamByName('Cliente').AsInteger:=ClienteID;
   dsConsumosPorCliente.ParamByName('Estacion').AsInteger:=EstacionID;
   dsConsumosPorCliente.ParamByName('Ticket').AsInteger:=TicketID;
   dsConsumosPorCliente.Open;

   if dsConsumosPorCliente.IsEmpty then
     Exit;

   cmdTickets:=Schema.NewCommand(Connection,'spInsertarTicketFactura');

   FolioFactura:=FolioActual('FolioFactura',Serie);
   FolioFacturaID:=Folio('FacturaID','');

   while not dsConsumosPorCliente.EOF do
   begin
    Tickets:=Tickets + dsConsumosPorCliente.FieldByName('Secuencia').AsString + ' ';
    cmdTickets.ParamByName('TicketFacturaID').AsInteger:=Folio('TicketFacturaID','');
    cmdTickets.ParamByName('TicketID').AsInteger:=dsConsumosPorCliente.FieldByName('Secuencia').AsInteger;
    cmdTickets.ParamByName('Fecha').AsDateTime:=Trunc(dsConsumosPorCliente.FieldByName('FechaConsumo').AsDateTime);
    cmdTickets.ParamByName('Volumen').AsFloat:=dsConsumosPorCliente.FieldByName('Volumen').AsFloat;
    cmdTickets.ParamByName('Precio').AsFloat:=dsConsumosPorCliente.FieldByName('Precio').AsFloat;
    cmdTickets.ParamByName('Importe').AsFloat:=dsConsumosPorCliente.FieldByName('Importe').AsFloat;
    cmdTickets.ParamByName('ProductoID').AsInteger:=dsConsumosPorcliente.FieldByName('ProductoID').asInteger;
    cmdTickets.ParamByName('FacturaID').AsInteger:=FolioFacturaID;
    cmdTickets.ParamByName('EstacionID').AsInteger:=dsConsumosPorCliente.FieldByName('EStacionID').ASinteger;
    cmdTickets.Execute;
    dsConsumosPorCliente.Next;
   end;

   dsDatosEstacion:=Schema.NewDataSet(Connection,'ObtenerDatosEstacion');
   dsDatosEstacion.ParamByName('EstacionID').AsInteger:=EstacionID;
   dsDatosEstacion.Open;

   ImpuestoPorcentaje:=1 + ((dsDatosEstacion.FieldByName('impuesto').asFloat )/100);
   Impuesto:=dsDatosEstacion.FieldByName('impuesto').asFloat;
   dsDatosEstacion.Close;

   dsConsumosporFacturar:=Schema.NewDataSet(Connection,'ConsumoExpressPorcliente');
   dsConsumosPorFacturar.ParamByName('ClienteID').AsInteger:=ClienteID;
   dsConsumosPorFacturar.ParamByName('EstacionID').AsInteger:=EstacionID;
   dsConsumosPorFacturar.ParamByName('Ticket').AsInteger:=TicketID;
   dsConsumosPorFacturar.Open;

   cmdDetalles:=Schema.NewCommand(Connection,'spInsertarDetalleFactura') ;
   I:=0;
   while not dsConsumosPorFacturar.EOF do
   begin
      //Para detalle Factura
      I:=I+1;
      Total:=Total + dsConsumosPorFacturar.FieldByName('Importe').AsFloat;
      cmdDetalles.ParamByName('DetalleFacturaID').AsInteger:=Folio('DetalleFacturaID','');
      cmdDetalles.ParamByName('Cantidad').AsFloat:=dsConsumosPorFacturar.FieldByName('Volumen').AsFloat;
      cmdDetalles.ParamByName('Precio').AsFloat:=dsConsumosPorFacturar.FieldByName('Precio').AsFloat;
      cmdDetalles.ParamByName('Importe').AsFloat:=dsConsumosPorFacturar.FieldByName('Importe').AsFloat;
      cmdDetalles.ParamByName('ItemNo').AsInteger:=I;
      cmdDetalles.ParamByName('FacturaID').AsInteger:=FolioFacturaID;
      cmdDetalles.ParamByName('ProductoID').AsInteger:=dsConsumosPorFacturar.FieldByName('ProductoID').asInteger;
      cmdDetalles.Execute;
      dsConsumosPorFacturar.Next;
   end;
   Subtotal:=Total / ImpuestoPorcentaje;
   Iva:=Total - SubTotal;

   ds:=Schema.NewDataset(Connection, 'spFolio');
   ds.ParamByName('Campo').AsString:='FolioFactura';
   ds.ParamByName('Serie').AsString:=Serie;
   ds.Open;


   cmdFactura:=Schema.NewCommand(Connection,'spInsertarFactura') ;
   cmdFactura.ParamByName('FacturaID').AsInteger:=FolioFacturaID;
   cmdFactura.ParamByName('Folio').AsInteger:=FolioFactura;
   cmdFactura.ParamByName('Serie').AsString:=Serie;
   cmdFactura.ParamByName('Fecha').AsDateTime:=Trunc(Fecha);
   cmdFactura.ParamByName('Ejercicio').AsString:=FormatDateTime('yyyy', Fecha);
   cmdFactura.ParamByName('Periodo').AsString:=FormatDateTime('m', Fecha);
   cmdFactura.ParamByName('Dia').AsString:=FormatDateTime('d', Fecha);
   cmdFactura.ParamByName('SubTotal').AsFloat:=SubTotal;
   cmdFactura.ParamByName('Impuesto').AsFloat:=Iva;
   cmdFactura.ParamByName('Total').AsFloat:=Total;
   cmdFactura.ParamByName('ImpuestoPorcentaje').AsFloat:=Impuesto;
   cmdFactura.ParamByName('Turno').AsInteger:=1;
   cmdFactura.ParamByName('EstacionID').AsInteger:=EstacionID;
   cmdFactura.ParamByName('ClienteID').AsInteger:=ClienteID;
   cmdFactura.ParamByName('FormaPagoID').AsInteger:=1;    //Pago en Cheque para FacturaExpress
   cmdFactura.ParamByName('TipoFacturaID').AsInteger:=5;  //Tipo de Factura Express
   cmdFactura.ParamByName('Tickets').AsString:=Tickets;
   cmdFactura.ParamByName('UsuarioID').AsInteger:=1;
   cmdFactura.Execute;


   Result.Assign(FacturaExpress(Serie, FolioFactura));
   CalculaIEPSExpress(Result);

   ds.Close;
end;


function TServiceValesCupones.GuardaVenta(const nBomba: Integer): Integer;
var
  Sec: Integer;
  cmd: IDASQLCommand;
  cmd2, cmd3: IDASQLCommand;
  MiFecha: TDateTime;
  TipoTrama: Integer;
begin
  Result:=0;
  try
    Global.Bombas[nBomba].PendienteGrabar:=False;
    MiFecha:=Now;
    Sec:=Global.Bombas[nBomba].VentaProceso.Secuencia;
    TipoTrama:=0;
    if (Global.Bombas[nBomba].Clasificacion <> '') then
      TipoTrama:=StrToInt(Global.Bombas[nBomba].Clasificacion);

    cmd:=Schema.NewCommand(Connection, 'Insert_dbo.ArchivoVTA');
    cmd.ParamByName('Secuencia').AsInteger:=Sec;
    cmd.ParamByName('Dispensario').AsInteger:=nBomba;
    cmd.ParamByName('Manguera').AsInteger:=Global.Bombas[nBomba].VentaProceso.Manguera;
    cmd.ParamByName('ProductoPemex').AsInteger:=StrToInt(Global.Bombas[nbomba].VentaProceso.ClavePemex);
    cmd.ParamByName('Volumen').AsString:=FormatFloat('#0.000', Global.Bombas[nBomba].VentaProceso.VolumenServido);
    cmd.ParamByName('Precio').AsString:=FormatFloat('#0.00', Global.Bombas[nBomba].VentaProceso.PrecioServido);
    cmd.ParamByName('Importe').AsString:=FormatFloat('#0.00', Global.Bombas[nBomba].VentaProceso.ImporteServido);
    cmd.ParamByName('Fecha').AsDateTime:=Fecha;
    cmd.Execute;

    try
      cmd2:=Schema.NewCommand(Connection, 'Insert_dbo.Trama');
      cmd2.ParamByName('TramaID').AsInteger:=Sec;
      cmd2.ParamByName('FechaCarga').AsDateTime:=MiFecha;
      cmd2.ParamByName('FechaContable').AsDateTime:=Trunc(MiFecha);
      cmd2.ParamByName('Ejercicio').AsString:=FormatDateTime('yyyy', MiFecha);
      cmd2.ParamByName('Periodo').AsString:=FormatDateTime('m', MiFecha);
      cmd2.ParamByName('Dia').AsString:=FormatDateTime('d', MiFecha);
      cmd2.ParamByName('Odometro').AsInteger:=Global.Bombas[nBomba].VentaProceso.Odometro;
      cmd2.ParamByName('Referencia').AsString:=Global.Bombas[nBomba].VentaProceso.Tarjeta;
      cmd2.ParamByName('Volumen').AsString:=FormatFloat('#0.000', Global.Bombas[nBomba].VentaProceso.VolumenServido);
      cmd2.ParamByName('Precio').AsString:=FormatFloat('#0.00', Global.Bombas[nBomba].VentaProceso.PrecioServido);
      cmd2.ParamByName('Importe').AsString:=FormatFloat('#0.00', Global.Bombas[nBomba].VentaProceso.ImporteServido);
      cmd2.ParamByName('Tipo').AsInteger:=Global.Bombas[nBomba].VentaProceso.Tipo;
      cmd2.ParamByName('TipoTrama').AsInteger:=TipoTrama;
      cmd2.ParamByName('Impreso').AsInteger:=0;
      cmd2.ParamByName('Estado').AsInteger:=0;
      cmd2.ParamByName('MangueraID').AsInteger:=Global.Bombas[nBomba].VentaProceso.Manguera;
      cmd2.ParamByName('BombaID').AsInteger:=nBomba;
      cmd2.ParamByName('EstacionID').AsInteger:=Global.Estacion;
      cmd2.ParamByName('TurnoID').AsInteger:=Global.Bombas[nBomba].TurnoID;
      cmd2.ParamByName('ProductoID').AsString:=Global.Bombas[nBomba].VentaProceso.Codigo;
      cmd2.ParamByName('IEPS').AsFloat:=Global.Bombas[nBomba].VentaProceso.IEPS;
      cmd2.ParamByName('Host').AsString:=Global.Bombas[nBomba].Host;
      cmd2.Execute;
    except
      on E: Exception do
        EscribeSerialLog('ErroresCistem', FormatDateTime('dd/mm/yyyy hh:nn:ss.zzz', Now) + '->' + E.Message);
    end;

    try
      cmd3:=Schema.NewCommand(Connection, 'INSV2ArchivoVTA');
      cmd3.ParamByName('TipoRegistro').AsString:='D';
      cmd3.ParamByName('Secuencia').AsInteger:=Sec;
      cmd3.ParamByName('Dispensario').AsInteger:=nBomba;
      cmd3.ParamByName('Manguera').AsInteger:=Global.Bombas[1].VentaProceso.Manguera;
      cmd3.ParamByName('ProductoPemex').AsInteger:=StrToInt(Global.Bombas[nbomba].VentaProceso.ClavePemex);
      cmd3.ParamByName('Volumen').AsString:=FormatFloat('#0.000', Global.Bombas[nbomba].VentaProceso.VolumenServido);
      cmd3.ParamByName('Precio').AsString:=FormatFloat('#0.00', Global.Bombas[nbomba].VentaProceso.PrecioServido);
      cmd3.ParamByName('Importe').AsString:=FormatFloat('#0.00', Global.Bombas[nbomba].VentaProceso.ImporteServido);
      cmd3.ParamByName('Fecha').AsDateTime:=Fecha;
      cmd3.Execute;
    except
      on E: Exception do
        ShowMessage(E.Message);
    end;

    Global.Bombas[nBomba].VentaAntePenultima.Assign(Global.Bombas[nBomba].VentaPenultima);
    Global.Bombas[nBomba].VentaPenultima.Assign(Global.Bombas[nBomba].VentaUltima);
    Global.Bombas[nBomba].VentaUltima.Assign(Global.Bombas[nBomba].VentaProceso);
    Global.Bombas[nBomba].Ticket:=eImpresionTicket_itParcial;
    Result:=Sec;
    case Global.Bombas[nBomba].VentaProceso.Tipo of
      2, 3, 5: begin
                 Flotillas.Consumo(Global.Bombas[nBomba].VentaProceso);
                 Global.Bombas[nBomba].Ticket:=eImpresionTicket_itParcial;
               end;
      //9: begin
      //     Express.Consumo(Global.Bombas[nBomba].VentaProceso);
      //     Global.Bombas[nBomba].Ticket:=itParcial;
      //   end;
    end;
    Global.Bombas[nBomba].VentaProceso.Tipo:=0;
    Global.Bombas[nBomba].VentaProceso.Tarjeta:='';
    Global.Bombas[nBomba].VentaProceso.Odometro:=0;
    Global.Bombas[nBomba].VentaProceso.Impreso:=0;
    Global.Bombas[nBomba].VentaProceso.Site:='';
    Global.Bombas[nBomba].VentaProceso.VentaAutorizada:=0;
    Global.Bombas[nBomba].VentaProceso.VentaVolumenImporte:='';
    Global.Bombas[nBomba].VentaProceso.NoTerminal:='';
    Global.Bombas[nBomba].Host:='';
  except
  end;
end;

function TServiceValesCupones.IEPS(ProductoID: Integer): Real;
var
  ds: IDADataset;
begin
  ds:=Schema.NewDataset(Connection, 'spIEPS');
  ds.ParamByName('ProductoID').AsInteger:=ProductoID;
  ds.Open;
  Result:=Decimales(ds.FieldByName('IEPS').AsFloat, 4);
  ds.Close;
end;

procedure TServiceValesCupones.IncrementarImpreso(const Secuencia: Integer);
var
  cmd: IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection, 'IncrementaImpreso');
  cmd.ParamByName('Secuencia').AsInteger:=Secuencia;
  cmd.Execute;
end;

procedure TServiceValesCupones.InsertaDeposito(const DepositoID: Integer;
  const Cantidad: Double; const Usuario: Integer; const Fecha: DateTime;
  const Secuencia, EstacionID: Integer; const Descripcion: AnsiString;
  const Ejercicio, Periodo, Dia: Integer);
var
  cmd:IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection,'spInsertaDeposito');
  cmd.ParamByName('DepositoID').AsInteger:=DepositoID;
  cmd.ParamByName('Cantidad').AsFloat:=Cantidad;
  cmd.ParamByName('UsuarioID').AsInteger:=Usuario;
  cmd.ParamByName('Fecha').AsDateTime:=Fecha;
  cmd.ParamByName('Secuencia').AsInteger:=Secuencia;
  cmd.ParamByName('EstacionID').AsInteger:=EstacionID;
  cmd.ParamByName('Descripcion').AsString:=Descripcion;
  cmd.ParamByName('Ejercicio').AsInteger:=Ejercicio;
  cmd.ParamByName('Periodo').AsInteger:=Periodo;
  cmd.ParamByName('Dia').AsInteger:=Dia;
  cmd.Execute;

end;

procedure TServiceValesCupones.InsertaFacturaElectronica(const FacturaElectronicaID: Integer; const CadenaOriginal: UnicodeString; const SelloDigital: UnicodeString;
const FacturaID: Integer; const Vigencia: Boolean; const Enviado: Boolean; const NoCertificado: AnsiString;
const NoAprobacion: AnsiString; const FechaAprobacion: DateTime);
var
  cmd:IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection, 'spInsertaFCTELECTRONICA');
  cmd.ParamByName('FacturaElectornicaID').AsInteger:= Folio('FacturaElectronicaID','');
  cmd.ParamByName('CadenaOriginal').AsWideString:= CadenaOriginal;
  cmd.ParamByName('SelloDigital').AsWideString:= SelloDigital;
  cmd.ParamByName('FacturaID').AsInteger:= FacturaID;
  cmd.ParamByName('Vigencia').AsBoolean:= Vigencia;
  cmd.ParamByName('Enviado').AsBoolean:= Enviado;
  cmd.ParamByName('NoCertificado').AsString:= NoCertificado;
  cmd.ParamByName('Noaprobacion').AsString:= NoAprobacion;
  cmd.ParamByName('FechaAprobacion').AsDateTime:= FechaAprobacion;

  cmd.Execute;
end;

procedure TServiceValesCupones.InsertaProductoPrecio(const ProductoID,
  EstacionID: Integer; const Precio: Double);
var
  cmd:IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection,'spInsertaProductoPrecio') ;
  cmd.ParamByName('ProductoID').AsInteger:=ProductoID;
  cmd.ParamByName('EstacionID').AsInteger:=EstacionID;
  cmd.ParamByName('Precio').AsFloat:=Precio;
  cmd.Execute;
end;

function TServiceValesCupones.LiquidacionCerrada(const EstacionID,
  TurnoID: Integer): Boolean;
var
  ds: IDADataSet;
begin
  ds:=Schema.NewDataset(Connection, 'spLiquidacionCerrada');
  ds.ParamByName('EstacionID').AsInteger:=EstacionID;
  ds.ParamByName('TurnoID').AsInteger:=TurnoID;
  ds.Open;
  Result:=ds.IsEmpty;
end;

function TServiceValesCupones.LlavePriv(const Password,
  Dir: AnsiString; EstacionID: Integer): string;
var s:String;
begin
  S:='openssl pkcs8 -inform DER -in '+Dir+' -passin pass:'+Password+' -out temp'+inttostr(EstacionID)+'.key.pem';
  //ShellExecute(Handle, 'open', PChar('openssl.exe'), PChar('pkcs8 -inform DER -in '+PChar(Dir)+' -passin pass:'+PChar(Password)+ ' -out temp.key.pem'), nil, SW_SHOWDEFAULT);
  EjecutaComando('openssl pkcs8 -inform DER -in '+Dir+' -passin pass:'+Password+' -out temp'+inttostr(EstacionID)+'.key.pem');
  result:='llave privada generada';
  if FileExists('temp'+inttostr(EstacionID)+'.key.pem') = false then
  begin
     result:='no se genero la llave privada';
  end;
end;

function TServiceValesCupones.LlavePrivaCertificado(const LlavePrivada,
  Certificado: AnsiString; const GasolineroID: Integer;
  const Password: AnsiString; const EstacionID: Integer): AnsiString;
var
  cmd: IDASQLCommand;
  Cert:String;
begin
  cmd:= Schema.NewCommand(Connection, 'spLlavePrivadaCertificado');

  Cert:= CER('',Certificado);

  cmd.ParamByName('Certificado').AsString:= Cert;
  cmd.ParamByName('GasolineroID').AsInteger:= GasolineroID;
  cmd.ParamByName('EstacionID').AsInteger:= EstacionID;
  cmd.Execute;

  Result:= LlavePriv(Password,LlavePrivada,EstacionID);
end;

function TServiceValesCupones.Login(const Usuario, Clave: AnsiString): TLoginInfo;
var
  DataSet, Permisos: IDADataSet;
begin
  Result:=TLoginInfo.Create;
  DataSet:=Schema.NewDataset(Connection, 'spValidaUsuario');
  DataSet.ParamByName('Usuario').AsString:=Usuario;
  DataSet.ParamByName('Clave').AsString:=Clave;
  DataSet.Open;
  if not DataSet.IsEmpty then
  begin
    Result.Valida:=True;
    Result.EmpleadoID:=DataSet.FieldByName('IDEMPLEADO').AsInteger;
    Result.NombreEmpleado:=DataSet.FieldByName('Nombre').AsString;
    Permisos:=Schema.NewDataset(Connection, 'spAccesos');
    Permisos.ParamByName('UsuarioID').AsInteger:=Result.EmpleadoID;
    Permisos.Open;
    while not Permisos.EOF do
    begin
      with Result.Accesos.Add do
      begin
        OpcionID:=Permisos.FieldByName('OpcionID').AsInteger;
        Nombre:=Permisos.FieldByName('Descripcion').AsString;
      end;
      Permisos.Next;
    end;
    Permisos.Close;
  end
  else
  begin
    Result.Valida:=False;
    Result.EmpleadoID:=0;
    Result.NombreEmpleado:='';
  end;
  DataSet.Close;
end;

function TServiceValesCupones.ModificarFolioActual(const Campo, Serie: AnsiString;
  const Folio: Integer): AnsiString;
var
  cmd:IDADataset;
begin
 cmd:=Schema.NewDataset(Connection, 'spModificaFolioActual');
 cmd.ParamByName('Campo').AsString:=Campo;
 cmd.ParamByName('Serie').AsString:=Serie;
 cmd.ParamByName('Folio').AsInteger:=Folio;
 cmd.Open;
 Result:=cmd.FieldByName('Resultado').AsString;
end;

function TServiceValesCupones.ObtenCuponValido(const Barras: AnsiString;
  const Grupo: Integer; const CuponAutoriza: TAutoriza): TCuponValido;
var
  DataSet :    IDADataset;

  DS :    IDADataset;
  Autorizacion:TAutoriza;
  ABarras: String;
begin
  ABarras:=Barras;
  Result:= TCuponValido.Create();
  Autorizacion:=TAutoriza.Create();
  if Length(ABarras) <= 10 then
     ABarras:=IntToStr(ClaveToID(ABarras));

  DataSet:= Schema.NewDataset(Connection, 'spObtenCuponValido');
  DataSet.ParamByName('Barras').AsString:= ABarras;
  DataSet.Open;
  Result.MsnError:= 'CODIGO DE CUPON NO EXISTE';
  Result.Valido:=False;

  ////VALIDA QUE EL CUPON PUEDA SER CONSUMIDO EN PISO////
  if CUPONAUTORIZA.Referencia <> 'CAJA' then
  BEGIN

  DS:= Schema.NewDataset(Connection, 'spTipoCupon');
  DS.ParamByName('CUPONID').AsString:= ABarras;
  DS.Open;

  if not DS.IsEmpty then
  begin
    if DS.FieldByName('TipoCupon').AsBoolean then
    begin
       Result.MsnError:= 'ESTE CUPON NO PUEDE SER CONSUMIDO EN PISO';
       Result.Valido:=False;
       Exit;
    end;
  end;

  END;
  ///////////////////////////////////////////////////////

  if not DataSet.IsEmpty then
  begin
    if Grupo = 0 then
      Result.Grupo:=Folio('Grupo', '')
    else
      Result.Grupo:=Grupo;
    Result.CuponID:= DataSet.FieldByName('CuponID').AsInteger;
    Result.Importe:= DataSet.FieldByName('Importe').AsCurrency;
    Result.Status:=  DataSet.FieldByName('Status').AsString;
    Result.Referencia:= DataSet.FieldByName('Barras').AsString;
    Result.Nombre:=  DataSet.FieldByName('Nombre').AsString;
    Result.RazonSocial:= DataSet.FieldByName('RazonSocial').AsString;
    Result.Domicilio:= DataSet.FieldByName('Domicilio').AsString;
    Result.RFC:= DataSet.FieldByName('RFC').AsString;
    Result.CuentaContable:= DataSet.FieldByName('CuentaContable').AsString;
    Result.TarjetaID:= DataSet.FieldByName('TarjetaID').AsInteger;
    Result.ClienteID:= DataSet.FieldByName('ClienteID').AsInteger;
    Result.VehiculoID:= 0;
    Result.GasolineroID:= DataSet.FieldByName('GasolineroID').AsInteger;
    Result.MsnError:='';

    if Result.Status <> 'A' then
       Result.MsnError:= 'ESTE CUPON YA FUE CONSUMIDO';

    if Result.Status = 'I' then
       Result.MsnError:= 'ESTE CUPON FUE CANCELADO';

    if (CuponAutoriza.ClienteID <> 0) and (CuponAutoriza.ClienteID <> Result.ClienteID) then
      Result.MsnError:= 'EL CUPON NO ES^DEL MISMO CLIENTE';

    if BuscaAutorizacion(Result.Referencia) then
       Result.MsnError:= 'CUPON EN PROCESO DE CARGA';

    if Trunc(DataSet.FieldByName('FechaValido').AsDateTime) < Trunc(Now) then
      Result.MsnError:= 'EL CUPON HA CADUCADO^ ^VERIFIQUE FECHA^DE VENCIMIENTO';

    if Result.MsnError = '' then
    begin
       Result.Valido:=True;
       Autorizacion.AutorizacionID:= Folio('AutorizacionID','');
       Autorizacion.Fecha:= Now;
       Autorizacion.Importe:= DataSet.FieldByName('Importe').AsCurrency;
       Autorizacion.Cantidad:= 0;
       Autorizacion.ImporteCantidad:= 'I';
       Autorizacion.PosicionCarga:= CuponAutoriza.PosicionCarga;
       Autorizacion.Referencia:= Result.Referencia;
       Autorizacion.EstacionID:= CuponAutoriza.EstacionID;
       Autorizacion.VehiculoID:= Result.CuponID;
       Autorizacion.ClienteID:= Result.Grupo;
       Autorizacion.Tipo:= 2;

       if not(GuardaAutorizacion(Autorizacion)) then
          Result.MsnError:= 'ERROR AL SOLIICTAR^LA AUTORIZACION';
    end;
  end;
end;

function TServiceValesCupones.obtendatosActividadesProgramadas(const IDESTACION,
  TIPO: Integer): AnsiString;
var
  ds: IDADataSet;
  res: String;
begin
  ds:=Schema.NewDataset(Connection, 'spObtenActividadesProgramadas');
  ds.ParamByName('IDESTACION').AsInteger:= IDESTACION;
  ds.ParamByName('TIPO').AsInteger:= TIPO;
  ds.Open;

  if not ds.IsEmpty then
     res:= ds.FieldByName('XML').AsString
  else
     res:= '-1';

  Result:= res;
end;

function TServiceValesCupones.obtendatosempleados(
  const EstacionID: AnsiString; const Turno: AnsiString): AnsiString;
var
  ds: IDADataSet;
  res: String;
begin
  ds:=Schema.NewDataset(Connection, 'spObtenFotosEmpleado');
  ds.ParamByName('EstacionID').AsInteger:= strtoint(EstacionID);
  ds.ParamByName('Turno').AsInteger:= strtoint(Turno);
  ds.Open;

  if not ds.IsEmpty then
     res:= ds.FieldByName('XML').AsString
  else
     res:= '-1';

  Result:= res;
end;

function TServiceValesCupones.ObtenerStatusCupon(const Barras: AnsiString): AnsiString;
var
  ds: IDADataSet;
begin
  ds:=Schema.NewDataset(Connection, 'spObtenerStatusCupon');
  ds.ParamByName('Barras').AsString:=Barras;
  ds.Open;
  Result:=ds.FieldByName('Status').AsString;
  ds.Close;
end;

function TServiceValesCupones.ObtenerTipoCambioIDPorEstacion(
  const EstacionID: Integer): Integer;
var
  ds: IDADataSet;
begin
  ds:=Schema.NewDataset(Connection, 'ObtenerTipoCambioPorEstacion');
  ds.ParamByName('EstacionID').AsInteger:=EstacionID;
  ds.Open;
  Result:=ds.FieldByName('TipoCambioID').asInteger;
  ds.Close;

end;

function TServiceValesCupones.ObtenerTipoCambioPorEstacion(
  const EstacionID: Integer): Double;
var
  ds: IDADataSet;
begin
  ds:=Schema.NewDataset(Connection, 'ObtenerTipoCambioPorEstacion');
  ds.ParamByName('EstacionID').AsInteger:=EstacionID;
  ds.Open;
  Result:=ds.FieldByName('TipoCambio').AsFloat;
  ds.Close;
end;

function TServiceValesCupones.obtenNotificacionesDiarias(
  const IDESTACION: Integer): AnsiString;
var
  ds: IDADataSet;
begin
  ds:=Schema.NewDataset(Connection, 'spObtenNotificacionesDiarias');
  ds.ParamByName('IDESTACION').AsInteger:=IDESTACION;
  ds.Open;
  Result:=ds.FieldByName('XML').AsString;
  ds.Close;
end;

function TServiceValesCupones.PrecioProducto(const EstacionID,
  ProductoID: Integer):Double;
var
  ds: IDADataSet;
begin
  try
    ds := Schema.NewDataset(Connection, 'spPrecioProducto');
    ds.ParamByName('EstacionID').AsInteger := EstacionID;
    ds.ParamByName('ProductoID').AsInteger := ProductoID;
    ds.Open;
    Result := ds.FieldByName('PrecioVenta').AsFloat;
  finally
    ds.Close;
  end;
end;

function TServiceValesCupones.PrefijaCupon(const nBomba: Integer; const Barras,
  Terminal: AnsiString; const Grupo, ClienteID: Integer): TCupon;
var
  Gasolinero: Integer;
  Aux: String;
begin
  Result:=TCupon.Create;
  if Length(Barras) = 16 then
  begin
    Aux:=Copy(Barras, 1, 4);
    if not IsNumeric(Aux) then
    begin
      Result.Valido:=False;
      Result.Mensaje:='Error en los datos^del cupon';
      Exit;
    end;
    Gasolinero:=StrToInt(Aux);
  end
  else
    Gasolinero:=0;
  Global.Bombas[nBomba].Host:=Flotillas.BuscaHost(1, Gasolinero);
  Result.Assign(Flotillas.Cupon(nBomba, Grupo, ClienteID, Barras, Terminal));
end;

function TServiceValesCupones.PrefijaGrupo(const Bomba, Grupo: Integer;
  const Terminal: AnsiString; const Cupon: TCupon): AnsiString;
var
  ds: IDADataSet;
begin
  //---//
  if Global.Bombas[Bomba].VentaProceso.Secuencia = 0 then
  begin
     try
      ds := Schema.NewDataset(Connection, 'spObtenSecuenciaVentaActual');
      ds.Open;
      Global.Bombas[Bomba].VentaProceso.Secuencia := ds.FieldByName('SECUENCIAVENTA').AsInteger;
     finally
      ds.Close;
     end;
  end;
  //--//

  Global.Bombas[Bomba].VentaProceso.Nombre:=Cupon.Nombre;
  Global.Bombas[Bomba].VentaProceso.Empresa:=Cupon.RazonSocial;
  Global.Bombas[Bomba].VentaProceso.Registro:=Cupon.RFC;

  Global.Bombas[Bomba].VentaProceso.Tipo:=5;
  Global.Bombas[Bomba].VentaProceso.Tarjeta:=Cupon.Referencia;
  Global.Bombas[Bomba].VentaProceso.TipoTarjeta:=IntToStr(Cupon.Grupo);
  Global.Bombas[Bomba].VentaProceso.Estacion:= Cupon.EstacionID;
  Global.Bombas[Bomba].VentaProceso.ClienteID:=Cupon.ClienteID;
  Global.Bombas[Bomba].VentaProceso.VehiculoID:=0;
  Global.Bombas[Bomba].VentaProceso.GasolineroID:=Cupon.GasolineroID;
  Global.Bombas[Bomba].VentaProceso.VentaAutorizada:=Cupon.Importe;
  Global.Bombas[Bomba].VentaProceso.VentaVolumenImporte:='I';
  Global.Bombas[Bomba].VentaProceso.NoTerminal:=Terminal;
  Global.Bombas[Bomba].Autorizacion:=eTipoAutorizacion_taCupon;

  {*MODIFICACION PARA REALIAR EL GUARDADO DE LA VENTA**************************}
  //Control.Procesos.AgregarProceso(TProcesoPresetImporte, Bomba, 0, Cupon.Importe);
  //Sleep(300);
  //Control.Procesos.AgregarProceso(TProcesoPresetImporte, Bomba, 0, Cupon.Importe);
  //Sleep(300);
  //Control.Procesos.AgregarProceso(TProcesoPresetImporte, Bomba, 0, Cupon.Importe);

  {*******ASIGNA VALORES DE LA VENTA PARA GUARDAR INFO ************************}
  Global.Bombas[Bomba].VentaProceso.ImporteServido:= Cupon.Importe;
  Global.Bombas[Bomba].VentaProceso.VolumenServido:= 1;
  Global.Bombas[Bomba].VentaProceso.FechaCarga:= now();
  Global.Bombas[Bomba].VentaProceso.FechaContable:= now();
  Global.Bombas[Bomba].VentaProceso.PrecioServido:= Cupon.Importe;
  Global.Bombas[Bomba].VentaProceso.VehiculoID:= Cupon.VehiculoID;

  Global.Bombas[Bomba].VentaProceso.Codigo:='1';
  Global.Bombas[Bomba].VentaProceso.Bomba:= Bomba;
  Global.Bombas[Bomba].VentaProceso.Tarjeta:= Cupon.Referencia;

  {****************************************************************************}
  case Global.Bombas[Bomba].VentaProceso.Tipo of
      2, 3, 5: begin
                 Flotillas.Consumo(Global.Bombas[Bomba].VentaProceso);
                 Global.Bombas[Bomba].Ticket:=eImpresionTicket_itParcial;
               end;
    end;

  Result:='CUPON  AUTORIZADO'#10#13 + FormatFloat('"IMPORTE: "$#,#0.00', Cupon.Importe) + #10#13'INICIE SU DESPACHO';
end;

function TServiceValesCupones.PrefijaTarjeta(const nBomba: Integer;
  const Tarjeta, NIP, Odometro, Terminal: AnsiString): AnsiString;
var
  Gasolinero: Integer;
  Aux: String;
begin
  Aux:=Copy(Tarjeta, 5, 4);
  if not IsNumeric(Aux) then
  begin
    Result:='Error en los datos^de la tarjeta';
    Exit;
  end;
  Gasolinero:=StrToInt(Aux);
  Global.Bombas[nBomba].Host:=Flotillas.BuscaHost(1, Gasolinero);
  //Result:=Flotillas.Tarjeta(nBomba, Tarjeta, NIP, Odometro, Terminal, PresetMN, PresetLT).MsnError;
  Result:=Flotillas.Tarjeta(nBomba, Tarjeta, NIP, Odometro, Terminal).MsnError;
end;

function TServiceValesCupones.PrefijaTarjetaFrecuente(const nBomba: Integer;
  const Tarjeta, Odometro, Terminal: AnsiString): AnsiString;
var
  Gasolinero: Integer;
  Aux: String;
begin
  Aux := Copy(Tarjeta, 5, 4);
  if not IsNumeric(Aux) then
  begin
    Result := 'Error en los datos^de la tarjeta';
    Exit;
  end;
  Gasolinero := StrToInt(Aux);
  Global.Bombas[nBomba].Host := Flotillas.BuscaHost(1, Gasolinero);
end;

function TServiceValesCupones.PremioPuntos(EstacionID: Integer; Puntos: Double): String;
var
  ds: IDADataset;
begin
  Result := '';
  if Puntos = 0 then
    Exit;
  try
    ds := Schema.NewDataset(Connection, 'spPuntosPremio');
    ds.ParamByName('Puntos').AsFloat := Puntos;
    ds.ParamByName('EstacionID').AsInteger := EstacionID;
    ds.Open;
    if not ds.IsEmpty then
    begin
      Result := 'HA ALCANZADO UN PREMIO: [' + ds.FieldByName('Premio').AsString + ']';
    end;
  finally
    ds.Close;
  end;
end;

procedure TServiceValesCupones.ProcesaVentasLiquidacion(
  const Datos: TDatosCerrarLiquidacion);
var
  I, Aux, MiIndex: Integer;
  ds: IDADataset;
  cmd, cmd1, cmd2: IDASQLCommand;

function NombreProducto(ProductoID: Integer): String;
var
  ds: IDADataset;
begin
  ds:=Schema.NewDataset(Connection, 'spNombreProducto');
  ds.ParamByName('ProductoID').AsInteger:=ProductoID;
  ds.Open;
  Result:=ds.FieldByName('Nombre').AsString;
  ds.Close;
end;

begin
  cmd:=Schema.NewCommand(Connection, 'Insert_dbo DetalleLiquidacion2');
  for I := 0 to Datos.Detalle.Count - 1 do
  begin
    cmd.ParamByName('DetalleLiquidacionID').AsInteger:=Folio('LiquidacionDetalleID', '');
    cmd.ParamByName('DespachadorLiquidacionID').AsInteger:=Datos.Detalle[I].DespachadorLiquidacionID;
    cmd.ParamByName('Cantidad').AsFloat:=Decimales(Datos.Detalle[I].Cantidad, 2);
    cmd.ParamByName('Importe').AsFloat:=Decimales(Datos.Detalle[I].Importe, 2);
    cmd.ParamByName('Referencia').AsString:=Datos.Detalle[I].Referencia;
    cmd.ParamByName('Ticket').AsInteger:=Datos.Detalle[I].Ticket;
    cmd.ParamByName('Serie').AsString:=Datos.Detalle[I].Serie;
    cmd.ParamByName('CuponID').AsInteger:=Datos.Detalle[I].CuponID;
    cmd.ParamByName('SalidaID').AsInteger:=Datos.Detalle[I].SalidaID;
    cmd.ParamByName('ClienteID').AsInteger:=Datos.Detalle[I].ClienteID;
    cmd.ParamByName('BancoID').AsInteger:=Datos.Detalle[I].BancoID;
    cmd.ParamByName('ProductoID').AsInteger:=Datos.Detalle[I].ProductoID;
    cmd.ParamByName('AuxiliarID').AsInteger:=Datos.Detalle[I].AuxiliarID;
    cmd.ParamByName('Facturado').AsBoolean:=False;
    cmd.ParamByName('TipoValorID').AsInteger:=Datos.Detalle[I].TipoValorID;
    if (Datos.Detalle[I].Referencia = '') and (Datos.Detalle[I].ProductoID > 0) then
      cmd.ParamByName('Referencia').AsString:=NombreProducto(Datos.Detalle[I].ProductoID);
    cmd.ParamByName('VehiculoID').AsInteger:= 0;
    cmd.ParamByName('GasolineroID').AsInteger:= 0;
    cmd.ParamByName('Costo').AsFloat:= 0;
    cmd.ParamByName('Puntos').AsInteger:= 0;
    cmd.Execute;
  end;
  ds:=Schema.NewDataset(Connection, 'spRecalcularLiquidacion');
  ds.ParamByName('LiquidacionID').AsInteger:=Datos.LiquidacionID;
  ds.Open;
  Aux:=-1;
  Datos.VentasTotales:=0;
  Datos.Entregado:=0;
  MiIndex:=0;
  while not ds.EOF do
  begin
    if Aux <> ds.FieldByName('DespachadorLiquidacionID').AsInteger then
    begin
      Aux:=ds.FieldByName('DespachadorLiquidacionID').AsInteger;
      for I := 0 to Datos.Despachadores.Count - 1 do
      begin
        if Datos.Despachadores[I].DespachadorLiquidacionID = Aux then
        begin
          MiIndex:=I;
          break;
        end;
      end;
    end;
    if ds.FieldByName('Operador').AsInteger = 1 then
    begin
      Datos.Despachadores[MiIndex].Entregado:=ds.FieldByName('Importe').AsFloat;
      Datos.Entregado:=Datos.Entregado + ds.FieldByName('Importe').AsFloat;
    end
    else
    begin
      Datos.Despachadores[MiIndex].Importe:=ds.FieldByName('Importe').AsFloat;
      Datos.VentasTotales:=Datos.VentasTotales + ds.FieldByName('Importe').AsFloat;
    end;
    Datos.Despachadores[MiIndex].Diferencia:=Decimales(Datos.Despachadores[MiIndex].Importe - Datos.Despachadores[MiIndex].Entregado, 2);
    ds.Next;
  end;
  Datos.Diferencia:=Datos.VentasTotales - Datos.Entregado;
  cmd1:=Schema.NewCommand(Connection, 'spUpdateDespachadoresLiquidacion');
  for I := 0 to Datos.Despachadores.Count - 1 do
  begin
    cmd1.ParamByName('DespachadorLiquidacionID').AsInteger:=Datos.Despachadores[I].DespachadorLiquidacionID;
    cmd1.ParamByName('Importe').AsFloat:=Decimales(Datos.Despachadores[I].Importe, 2);
    cmd1.ParamByName('Entregado').AsFloat:=Decimales(Datos.Despachadores[I].Entregado, 2);
    cmd1.ParamByName('Diferencia').AsFloat:=Decimales(Datos.Despachadores[I].Diferencia, 2);
    cmd1.Execute;
  end;
  cmd2:=Schema.NewCommand(Connection, 'spUpdateLiquidacion');
  cmd2.ParamByName('LiquidacionID').AsInteger:=Datos.LiquidacionID;
  cmd2.ParamByName('VentasTotales').AsFloat:=Decimales(Datos.VentasTotales, 2);
  cmd2.ParamByName('Entregado').AsFloat:=Decimales(Datos.Entregado, 2);
  cmd2.ParamByName('Diferencia').AsFloat:=Decimales(Datos.Diferencia, 2);
  cmd2.Execute;
  ds.Close;
end;

procedure TServiceValesCupones.ProgramaMantenimiento(const IDPROGRAMAMANTENIMIENTO: Integer; const IDESTACION: Integer; const FECHA: DateTime);
var
  cmd: IDASQLCommand;
begin
  cmd:=Schema.NewCommand(Connection, 'cmdProgramaMantenimiento');

  cmd.ParamByName('IDPROGRAMAMANTENIMIENTO').AsInteger:= IDPROGRAMAMANTENIMIENTO;
  cmd.ParamByName('IDESTACION').AsInteger:= IDESTACION;
  cmd.ParamByName('FECHA').AsDateTime:= FECHA;

  cmd.Execute;
end;

function TServiceValesCupones.SELLOPEMs(const texto: UnicodeString; const EstacionID: Integer): Ansistring;
var
  F: TextFile;
  S:String;
  hora:String;
begin
    //Result:= B64ENCODE(Sign_RSA_MD5('temp'+inttostr(EstacionID)+'.key.pem', Texto));
    Result:='1';
    hora:=FormatDateTime('hhnnss',Now());

    GuardaArchivo('cadenaoriginal'+hora,texto);
    EjecutaComando('openssl dgst -sign ' +'temp'+inttostr(EstacionID)+'.key.pem ' + 'cadenaoriginal'+hora+'.txt | openssl enc -base64 -A > sello'+hora+'.txt');

    {$I-}
    AssignFile( F, ExtractFilePath( Application.ExeName ) + 'sello'+hora+'.txt' );
    Reset(F);

    while not EOF(F) do
    begin
    ReadLn(F, S);
    Result:= Result + S;
    end;
    CloseFile(F);
    Result:=Trim(Result);
    CloseFile(F);

    {$I+}
    S:= 'sello'+(hora)+'.txt';
    DeleteFile(PAnsiChar(S));
    S:= 'cadenaoriginal'+(hora)+'.txt';
    DeleteFile(PAnsiChar(S));
end;

function TServiceValesCupones.StatusCupon(const Codigo: AnsiString): AnsiString;
var
  ds: IDADataset;
begin
  ds:=Schema.NewDataset(Connection, 'spStatusCuponCancelar');
  ds.ParamByName('Codigo').AsString:=Codigo;
  ds.Open;
  Result:=ds.FieldByName('Status').AsString;
end;

function TServiceValesCupones.StatusTicket(const EstacionID,
  TicketID: Integer): Integer;
var
  ds  : IDADataSet;
begin
  ds:=Schema.NewDataset(Connection, 'spTicketExisteEnLiquidacion');
  ds.ParamByName('EstacionID').AsInteger:=EstacionID;
  ds.ParamByName('TicketID').AsInteger:=TicketID;
  ds.Open;
  Result:=ds.FieldByName('Cuantos').AsInteger;
  ds.Close;
end;

function TServiceValesCupones.SumaAnticipo(const Estacion,Secuencia: Integer):Double;
var
  ds: IDADataSet;
begin
  ds:=Schema.NewDataset(Connection,'spSumaAnticipo');
  ds.ParamByName('EstacionID').AsInteger:=Estacion;
  ds.ParamByName('Secuencia').AsInteger:=Secuencia;
  ds.Open;
  result:=ds.FieldByName('SumaAnticipo').AsInteger;
  ds.Close;
end;

function TServiceValesCupones.SumaVentasCorte(const Estacion,
  Secuencia: Integer; const AgrupacionID: Integer): Double;
var
  ds: IDADataSet;
begin
  ds:=Schema.NewDataset(Connection,'spSumaVentasCorte');
  ds.ParamByName('EstacionID').AsInteger:=Estacion;
  ds.ParamByName('Secuencia').AsInteger:=Secuencia;
  ds.ParamByName('AgrupacionID').AsInteger:=AgrupacionID;
  ds.Open;
  result:=ds.FieldByName('SumaVentaCorte').AsFloat;
  ds.Close;
end;

function TServiceValesCupones.TarjetaConsumo(const Tarjeta: AnsiString;
  const Consumo: TConsumo): Boolean;
var
  DataSet, DSGOB: IDADataSet;
  aBarras: String;
begin
  {if Consumo.Tarjeta = 'E00700001F467371' then
     Consumo.Tarjeta := 'E007C1A256105304';}

  if Length(Tarjeta) <= 10 then
  begin
     ABarras:=IntToStr(ClaveToID(Tarjeta));
     Consumo.Tarjeta:= ABarras;
  end;

  try
  DataSet:= Schema.NewDataset(Connection, 'spBuscaReferencia');
  DataSet.ParamByName('Referencia').AsString:= Consumo.Tarjeta;
  DataSet.Open;
  finally
     Consumo.VehiculoID:= DataSet.FieldByName('VehiculoID').AsInteger;
  end;

  Result:=False;
  try

{pla_GOB}//--obten IDRFID------------------------------------------------------}
    //if (ServerDataModule.AUTORIZAGOB = 'S') AND (copy(Consumo.Tarjeta,1,1) <> '0') then
    //begin
    //DSGOB:= Schema.NewDataset(Connection, 'spDatosVehiculoGOB');
    //DSGOB.ParamByName('IDRFID').AsString:= Consumo.Tarjeta;
    //DSGOB.ParamByName('NUMEROECONOMICO').AsString:='';
    //DSGOB.Open;
    //if DSGOB.IsEmpty then
    //begin
    //   Consumo.VehiculoID:= -100;
    //   Consumo.ClienteID:= -100;
    //end;
    //end;
{pla_GOB}//--obten IDRFID------------------------------------------------------}
    //Result:=GuardarConsumo(Consumo);
{pla_GOB}//--obten IDRFID------------------------------------------------------}
    //if (ServerDataModule.AUTORIZAGOB = 'S') AND (copy(Consumo.Tarjeta,1,1) <> '0') then
    //Result:= GuardarConsumoGOB(Consumo);
{pla_GOB}//--------------------------------------------------------------------}

    if (Result) and (Tarjeta <> '') then
    begin
      ActualizaHistorial(Consumo);
      //EliminaAutorizacionVehiculo(Consumo.ClienteID, Consumo.VehiculoID, Consumo.GasolineroID);
      EliminaAutorizacionVehiculo(Consumo.Tarjeta);
    end;
  except
  end;
end;

function TServiceValesCupones.TicketsLiquidacion(
  const LiquidacionID: Integer): Ansistring;
var
  Aux: TStrings;
  ds: IDADataset;
begin
  Aux:=TStringList.Create;
  try
    ds:=Schema.NewDataset(Connection, 'LIQTickets');
    ds.ParamByName('LiquidacionID').AsInteger:=LiquidacionID;
    ds.Open;
    while not ds.EOF do
    begin
      Aux.Add(ds.FieldByName('Ticket').AsString);
      ds.Next;
    end;
    ds.Close;
    Result:=Aux.Text;
  finally
    Aux.Free;
  end;
end;

function TServiceValesCupones.TurnoALiquidacionID(const TurnoID,
  EstacionID: Integer): Integer;
var
  ds: IDADataset;
begin
  ds:=Schema.NewDataset(Connection, 'spTurnoALiquidacionID');
  ds.ParamByName('TurnoID').AsInteger:=TurnoID;
  ds.ParamByName('EstacionID').AsInteger:=EstacionID;
  ds.Open;
  Result:=ds.FieldByName('LiquidacionID').AsInteger;
end;

procedure TServiceValesCupones.UltimasVentas(BombaID: Integer);
var
  dsVentas: IDADataset;
procedure AsignaVenta(Venta: TRegistroVenta);
begin
  Venta.Secuencia:=dsVentas.FieldByName('TramaID').AsInteger;
  Venta.ImporteServido:=dsVentas.FieldByName('Importe').AsFloat;
  Venta.PrecioServido:=dsVentas.FieldByName('Precio').AsFloat;
  Venta.VolumenServido:=dsVentas.FieldByName('Volumen').AsFloat;
  Venta.FechaCarga:=dsVentas.FieldByName('FechaCarga').AsDateTime;
  Venta.Bomba:=dsVentas.FieldByName('BombaID').AsInteger;
  Venta.ClavePemex:=dsVentas.FieldByName('Codigo').AsString;
  Venta.Descripcion:=dsVentas.FieldByName('Descripcion').AsString;
  Venta.Impuesto:=dsVentas.FieldByName('Impuesto').AsFloat;
  Venta.Impreso:=dsVentas.FieldByName('Impreso').AsInteger;
  Venta.Codigo:=dsVentas.FieldByName('ProductoID').AsString;
  Venta.Estacion:=dsVentas.FieldByName('EstacionID').AsInteger;
end;
begin
  dsVentas:=Schema.NewDataset(Connection, 'UltimasVentas');
  dsVentas.ParamByName('BombaID').AsInteger:=BombaID;
  dsVentas.Open;
  AsignaVenta(Global.Bombas[BombaID].VentaUltima);
  dsVentas.Next;
  AsignaVenta(Global.Bombas[BombaID].VentaPenultima);
  dsVentas.Next;
  AsignaVenta(Global.Bombas[BombaID].VentaAntePenultima);
  Global.Bombas[BombaID].VentaProceso.Assign(Global.Bombas[BombaID].VentaUltima);
  dsVentas.Close;
end;

function TServiceValesCupones.UltimoTurnoBomba: aTurnoBomba;
var
  I: Integer;
  ds: IDADataset;
begin
  Result:=aTurnoBomba.Create;
  for I := 0 to Global.TotalBombas do
    Result.Add(0);
  ds:=Schema.NewDataset(Connection, 'UltimoTurno');
  ds.Open;
  while not ds.EOF do
  begin
    Result[ds.FieldByName('BombaID').AsInteger]:=ds.FieldByName('TurnoID').AsInteger;
    ds.Next;
  end;
  ds.Close;
end;


function TServiceValesCupones.VersionServer: AnsiString;
begin
  Result:=Version;
end;

initialization
  TROClassFactory.Create('ServiceValesCupones', Create_ServiceValesCupones, TServiceValesCupones_Invoker);
finalization
end.
